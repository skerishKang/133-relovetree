<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Critical for YouTube Embeds -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>LoveTree Editor</title>
    <!-- Tailwind CSS (Built locally for production) -->
    <link rel="stylesheet" href="output.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK (Compat for easier integration with existing code) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        :root {
            /* Ïù∏Îç±Ïä§ÏôÄ ÎèôÏùºÌïú Í∏∞Î≥∏ Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Í∏∞Î≥∏Í∞í */
            --main-bg-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2073&auto=format&fit=crop');
        }

        body {
            background-color: #f8fafc;
            background-image: var(--main-bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-image 0.3s ease, background-color 0.3s ease;
        }

        /* Î™®Î∞îÏùº + ÌÉÄÏûÑÎùºÏù∏ Î™®Îìú Ï†ÑÏö© Î†àÏù¥ÏïÑÏõÉ */
        body.editor-mobile.editor-timeline #timeline {
            background-color: transparent;
            padding-left: 16px;
            padding-right: 16px;
        }

        body.editor-mobile.editor-timeline .timeline-card {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            border-radius: 20px;
        }

        #canvas {
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 24px 24px;
            cursor: grab;
            transform-origin: 0 0;
            will-change: transform;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* Simplified Node Style */
        .node {
            position: absolute;
            width: 280px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.3s, transform 0.3s;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            z-index: 10;
        }

        .node:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-color: #f43f5e;
        }

        .node.selected {
            border-color: #f43f5e;
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.2);
            z-index: 20;
        }

        .moment-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: 600;
        }

        /* Unified Modal */
        dialog {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            max-width: 1000px;
            width: 95%;
            height: 85vh;
            animation: modal-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fade-in 0.3s ease;
        }

        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Scrollbar for modal content */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div
        class="fixed top-0 left-0 w-full z-50 px-4 md:px-6 py-3 flex flex-wrap md:flex-nowrap justify-between items-center gap-2 pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3">
            <a href="index.html" title="ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞"
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 p-2 rounded-xl hover:bg-white transition-colors text-slate-500 hover:text-brand-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <h1 id="tree-title"
                class="text-lg md:text-2xl font-bold text-slate-800 drop-shadow-sm bg-white/80 backdrop-blur px-3 md:px-4 py-1.5 rounded-xl border border-slate-200 max-w-[55vw] truncate">
                ÎÇòÏùò Îü¨Î∏åÌä∏Î¶¨
            </h1>
        </div>
        <div class="pointer-events-auto flex flex-wrap md:flex-nowrap gap-2 items-center justify-end">
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="mode-tree-btn" onclick="setEditorMode('tree')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    Ìä∏Î¶¨
                </button>
                <button id="mode-timeline-btn" onclick="setEditorMode('timeline')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    Î¶¨Ïä§Ìä∏
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="viewport-desktop-btn" onclick="setViewportMode('desktop')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    Îç∞Ïä§ÌÅ¨ÌÉë
                </button>
                <button id="viewport-mobile-btn" onclick="setViewportMode('mobile')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    Î™®Î∞îÏùº
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="orientation-portrait-btn" onclick="setOrientationMode('portrait')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    ÏÑ∏Î°ú
                </button>
                <button id="orientation-landscape-btn" onclick="setOrientationMode('landscape')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    Í∞ÄÎ°ú
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg text-xs font-mono text-slate-500 flex items-center gap-2">
                <span>ZOOM</span>
                <span id="zoom-level" class="font-bold text-slate-800">100%</span>
            </div>
            <button onclick="zoomOut()" title="Ï§å ÏïÑÏõÉ"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
            </button>
            <button onclick="zoomIn()" title="Ï§å Ïù∏"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
            <div class="w-px h-8 bg-slate-300 mx-1"></div>
            <button id="btn-reset" onclick="resetLayout()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-red-50 text-red-500 text-xs font-bold transition-colors">
                Ï¥àÍ∏∞Ìôî
            </button>
            <div class="w-px h-8 bg-slate-300 mx-1"></div>
            <button id="like-btn" onclick="toggleLike()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-pink-50 text-slate-400 hover:text-pink-500 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
                <span id="like-count">0</span>
            </button>
            <button id="comment-btn" onclick="openCommentsModal()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-blue-50 text-slate-400 hover:text-blue-500 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
                </svg>
                <span id="comment-count">0</span>
            </button>
            <button id="share-btn" onclick="shareTree()"
                class="bg-brand-500 shadow-lg text-white px-3 py-1.5 rounded-lg hover:bg-brand-600 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z">
                    </path>
                </svg>
                Share
            </button>
            <button id="lang-btn" onclick="toggleLanguage()"
                class="bg-slate-800 shadow-lg text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 text-xs font-bold transition-colors">
                English
            </button>
        </div>
    </div>

    <!-- Canvas Wrapper -->
    <div id="wrapper" class="w-full h-full overflow-hidden relative">
        <div id="canvas">
            <svg id="connections" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-visible">
                <!-- Connections injected here -->
            </svg>
            <!-- Nodes injected here -->
        </div>

        <!-- Floating Action Button (Moved inside wrapper for mobile positioning) -->
        <button onclick="createNewNode()"
            class="absolute bottom-6 right-6 w-14 h-14 md:bottom-8 md:right-8 md:w-16 md:h-16 bg-brand-500 hover:bg-brand-600 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40 group">
            <svg class="w-7 h-7 md:w-8 md:h-8 group-hover:rotate-90 transition-transform duration-300" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span
                class="absolute -top-10 right-0 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                ÏÉàÎ°úÏö¥ ÏàúÍ∞Ñ Ï∂îÍ∞Ä
            </span>
        </button>
        <div id="timeline" class="hidden w-full h-full overflow-y-auto pt-20 pb-24 bg-slate-100/80"></div>
    </div>



    <!-- Unified Detail Modal -->
    <dialog id="detail-modal" class="bg-white">
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Video Player -->
            <div class="w-full md:w-2/3 bg-black flex items-center justify-center relative group">
                <div id="video-shell"
                    class="w-full max-w-3xl mx-auto aspect-video relative flex items-center justify-center">
                    <div id="video-placeholder"
                        class="w-full h-full flex flex-col items-center justify-center text-slate-200 gap-3 cursor-pointer select-none">
                        <div
                            class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                        <p class="text-sm font-medium">ÏòÅÏÉÅÏùÑ Î≥¥Î†§Î©¥ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
                        <p class="text-xs text-slate-400">Ïç∏ÎÑ§ÏùºÏùÄ Ïà®Í∏∞Í≥†, Ïû¨ÏÉù ÏãúÏóêÎßå ÏòÅÏÉÅÏùÑ Î∂àÎü¨ÏòµÎãàÎã§.</p>
                    </div>
                    <iframe id="detail-video" class="w-full h-full absolute inset-0 hidden" src="" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>

                <!-- Fallback / External Link Button -->
                <a id="external-link" href="#" target="_blank"
                    class="absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-1.5 rounded-full backdrop-blur transition-colors flex items-center gap-1 z-20">
                    <span>YouTubeÏóêÏÑú Î≥¥Í∏∞</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>

                <div class="absolute top-4 left-4 z-10">
                    <button onclick="closeModal('detail-modal')"
                        class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur transition-colors md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Right: Details & Moments -->
            <div class="w-full md:w-1/3 flex flex-col h-full border-l border-slate-200 bg-white">
                <!-- Header -->
                <div class="p-5 border-b border-slate-100 flex justify-between items-start shrink-0">
                    <div>
                        <h2 id="detail-title" class="text-xl font-bold text-slate-900 leading-tight mb-1">Title</h2>
                        <p id="detail-date" class="text-sm text-slate-500">Date</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="enableEditMode()"
                            class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                            title="ÏàòÏ†ï">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                        <button onclick="deleteNode()"
                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="ÏÇ≠Ï†ú">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                        <button onclick="closeModal('detail-modal')"
                            class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors hidden md:block"
                            title="Îã´Í∏∞">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form" class="hidden p-5 bg-slate-50 border-b border-slate-200 shrink-0">
                    <form onsubmit="saveNodeDetails(event)" class="space-y-3">
                        <input type="hidden" id="edit-node-id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ï†úÎ™©</label>
                            <input type="text" id="edit-title"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ÎÇ†Ïßú</label>
                            <input type="date" id="edit-date"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ïú†ÌäúÎ∏å URL</label>
                            <input type="text" id="edit-video"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ïù¥ÎØ∏ÏßÄ (Pro)</label>
                            <input type="file" id="edit-image" accept="image/*"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                            <div id="image-preview-container" class="mt-2 hidden">
                                <img id="image-preview" src="" alt="Preview"
                                    class="w-full h-32 object-cover rounded-lg border border-slate-200">
                                <button type="button" onclick="removeImage()"
                                    class="text-xs text-red-500 mt-1 hover:underline">Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="disableEditMode()"
                                class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded-lg">Ï∑®ÏÜå</button>
                            <button type="submit"
                                class="px-3 py-1.5 text-xs font-bold text-white bg-brand-500 hover:bg-brand-600 rounded-lg">Ï†ÄÏû•</button>
                        </div>
                    </form>
                </div>

                <!-- Moments List -->
                <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-4 bg-slate-50/50" id="moments-list">
                    <!-- Moments injected here -->
                </div>

                <!-- Add Moment Input -->
                <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                    <form onsubmit="addMomentFromDetail(event)" class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <div class="flex items-center gap-2">
                                <input type="text" id="new-moment-time" placeholder="0:00"
                                    class="w-16 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 text-center">
                                <button type="button" onclick="setCurrentMomentTime()"
                                    class="px-2 py-1 bg-slate-200 hover:bg-slate-300 text-[11px] font-medium text-slate-700 rounded-lg whitespace-nowrap">ÌòÑÏû¨ ÏãúÍ∞Ñ</button>
                            </div>
                            <input type="text" id="new-moment-text" placeholder="Ïù¥ ÏàúÍ∞ÑÏóê ÎåÄÌïú ÏΩîÎ©òÌä∏..."
                                class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-1">
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="love"
                                        class="peer sr-only" checked><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 hover:bg-pink-50 transition-colors">üòç</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="tear"
                                        class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 hover:bg-blue-50 transition-colors">üò≠</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="funny" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-yellow-100 peer-checked:text-yellow-600 hover:bg-yellow-50 transition-colors">ü§£</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="shock" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-purple-100 peer-checked:text-purple-600 hover:bg-purple-50 transition-colors">üò≤</span></label>
                            </div>
                            <button type="submit"
                                class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm">Îì±Î°ù</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Comments Modal -->
    <dialog id="comments-modal"
        class="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-md backdrop:bg-black/50 backdrop:backdrop-blur-sm">
        <div class="flex flex-col h-[600px] max-h-[80vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800">ÎåìÍ∏Ä <span id="modal-comment-count"
                        class="text-brand-500 text-sm ml-1">0</span></h3>
                <button onclick="closeModal('comments-modal')"
                    class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 custom-scroll">
                <!-- Comments injected here -->
                <div class="flex flex-col items-center justify-start pt-20 h-full text-slate-400 text-sm gap-2">
                    <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    <p>Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</p>
                </div>
            </div>

            <div
                class="p-4 border-t border-slate-100 bg-white rounded-b-2xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                <form onsubmit="addComment(event)" class="flex gap-2">
                    <input type="text" id="new-comment-input" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                        class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 transition-shadow">
                    <button type="submit"
                        class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                        Ï†ÑÏÜ°
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <script src="src/shared.js"></script>
    <script src="src/auth.js"></script>
    <script>
        // --- Translations ---
        let isKorean = true;
        const translations = {
            ko: {
                treeTitle: "ÎÇòÏùò Îü¨Î∏åÌä∏Î¶¨",
                langBtn: "English",
                placeholderComment: "Ïù¥ ÏàúÍ∞ÑÏóê ÎåÄÌïú ÏΩîÎ©òÌä∏...",
                btnRegister: "Îì±Î°ù",
                editTitle: "Ï†úÎ™©",
                editDate: "ÎÇ†Ïßú",
                editVideo: "Ïú†ÌäúÎ∏å URL",
                btnCancel: "Ï∑®ÏÜå",
                btnSave: "Ï†ÄÏû•",
                btnReset: "Ï¥àÍ∏∞Ìôî"
            },
            en: {
                treeTitle: "My LoveTree",
                langBtn: "ÌïúÍµ≠Ïñ¥",
                placeholderComment: "Comment on this moment...",
                btnRegister: "Add",
                editTitle: "Title",
                editDate: "Date",
                editVideo: "YouTube URL",
                btnCancel: "Cancel",
                btnSave: "Save",
                btnReset: "Reset"
            }
        };

        function toggleLanguage() {
            isKorean = !isKorean;
            const t = isKorean ? translations.ko : translations.en;

            document.getElementById('tree-title').innerText = t.treeTitle;
            document.getElementById('lang-btn').innerText = t.langBtn;
            document.getElementById('new-moment-text').placeholder = t.placeholderComment;
            document.querySelector('button[type="submit"]').innerText = t.btnRegister;
            document.getElementById('btn-reset').innerText = t.btnReset;

            render();
        }

        // --- State & Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const treeId = urlParams.get('id') || 'bts'; // Default to bts if no ID provided

        // Expanded Test Data (Personas)
        const dummyData = {
            'bts': {
                name: 'Î∞©ÌÉÑÏÜåÎÖÑÎã® (BTS)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Îç∞Î∑î Î¨¥ÎåÄ (No More Dream)', date: '2013-06-13', videoId: 'rBG5L7UsUxA',
                        moments: [{ time: '0:10', text: 'Ï†ÑÏÑ§Ïùò ÏãúÏûë', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'Ï≤´ 1ÏúÑ (I Need U)', date: '2015-05-05', videoId: 'NMdTd9e-LEI',
                        moments: [{ time: '2:30', text: 'Í∞êÎèôÏ†ÅÏù∏ ÏàúÍ∞Ñ', feeling: 'tear' }]
                    },
                    {
                        id: 3, x: 900, y: 100, title: 'ÎπåÎ≥¥Îìú 1ÏúÑ (Dynamite)', date: '2020-08-21', videoId: 'gdZLi9oWNZg',
                        moments: [{ time: '1:00', text: 'Ïó≠ÏÇ¨Ï†ÅÏù∏ Í∏∞Î°ù', feeling: 'shock' }]
                    },
                    {
                        id: 4, x: 500, y: -100, title: 'ÌôîÏñëÏó∞Ìôî (Photo)', date: '2015-04-29', videoId: '', imageUrl: 'https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=2070&auto=format&fit=crop',
                        moments: [{ time: '0:00', text: 'ÏïÑÎ¶ÑÎã§Ïö¥ Ïª®ÏÖâ Ìè¨ÌÜ†', feeling: 'love' }]
                    }
                ],
                edges: [
                    { from: 1, to: 2 },
                    { from: 2, to: 3 },
                    { from: 2, to: 4 }
                ]
            },
            'newbie_fan': {
                name: 'Ïã†ÏûÖ Ìå¨ (Newbie)',
                nodes: [
                    {
                        id: 1, x: 400, y: 300, title: 'ÏûÖÎçï Î∂ÄÏ†ïÍ∏∞ ÎÅù', date: '2024-01-01', videoId: '',
                        moments: [{ time: '0:00', text: 'Ïù¥Ï†ú Ïù∏Ï†ïÌï©ÎãàÎã§. Ï†ÄÎäî Ìå¨ÏûÖÎãàÎã§.', feeling: 'shock' }]
                    }
                ],
                edges: []
            },
            'heavy_uploader': {
                name: 'Í∏∞Î°ùÍ¥ë (Heavy User)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Day 1', date: '2024-01-01', videoId: '', moments: [] },
                    { id: 2, x: 300, y: 100, title: 'Day 2', date: '2024-01-02', videoId: '', moments: [] },
                    { id: 3, x: 500, y: 100, title: 'Day 3', date: '2024-01-03', videoId: '', moments: [] },
                    { id: 4, x: 100, y: 300, title: 'Day 4', date: '2024-01-04', videoId: '', moments: [] },
                    { id: 5, x: 300, y: 300, title: 'Day 5', date: '2024-01-05', videoId: '', moments: [] }
                ],
                edges: [
                    { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 3, to: 4 }, { from: 4, to: 5 }
                ]
            },
            'seventeen': {
                name: 'ÏÑ∏Î∏êÌã¥ (Seventeen)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ÏÜêÏò§Í≥µ (Super)', date: '2023-04-24', videoId: 'Y6cGBh_TSIc',
                        moments: [{ time: '2:45', text: 'ÏπºÍµ∞Î¨¥ ÎØ∏Ï≥§Îã§', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'MAESTRO Ïª¥Î∞±', date: '2024-04-29', videoId: 'ThI0pBAbFnk',
                        moments: [{ time: '3:00', text: 'ÏßÄÌúòÌïòÎäî ÏïàÎ¨¥ ÎåÄÎ∞ï', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'straykids': {
                name: 'Ïä§ÌÇ§Ï¶à (Stray Kids)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Á•ûÎ©îÎâ¥ (God\'s Menu)', date: '2020-06-17', videoId: 'TQTlCHxyuu8',
                        moments: [{ time: '1:20', text: 'ÎÑ§ ÏÜêÎãò~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ÎùΩ (LALALALA)', date: '2023-11-10', videoId: 'DTAQd-qA8Q4',
                        moments: [{ time: '2:10', text: 'ÏóêÎÑàÏßÄ Ìè≠Î∞ú', feeling: 'shock' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'leejunyoung': {
                name: 'Ïù¥Ï§ÄÏòÅ (Lee Jun-young)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Í∂ÅÍ∏àÌï¥ (Curious About U)', date: '2019-12-05', videoId: 'K4y_y2BfSgI',
                        moments: [{ time: '0:00', text: 'ÏÜîÎ°ú Í∞ÄÏàò Ïù¥Ï§ÄÏòÅ!', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ÎÑàÏùò Î∞§Ïù¥ ÎêòÏñ¥Ï§ÑÍ≤å (Ïó∞Í∏∞)', date: '2021-11-07', videoId: 'B-e_nK8Q3-M',
                        moments: [{ time: '0:00', text: 'Ïó∞Í∏∞ Ï≤úÏû¨ ÎßåÏû¨', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'hearts2hearts': {
                name: 'ÌïòÏ∏†Ìà¨ÌïòÏ∏† (Hearts2Hearts)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'The Chase (Debut)', date: '2025-02-24', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '0:05', text: 'ÎπÑÏ£ºÏñº ÏáºÌÅ¨...', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'Ï≤´ ÏùåÏïÖÎ∞©ÏÜ° 1ÏúÑ', date: '2025-03-15', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '3:20', text: 'ÎààÎ¨ºÎ∞îÎã§ „Ö†„Ö†', feeling: 'tear' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'illit': {
                name: 'ÏïÑÏùºÎ¶ø (ILLIT)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Magnetic Îç∞Î∑î', date: '2024-03-25', videoId: 'Vk5-c_v4gMU',
                        moments: [{ time: '0:30', text: 'ÏäàÌçº Ïù¥ÎÅåÎ¶º~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 200, title: 'Lucky Girl Syndrome', date: '2024-04-10', videoId: 'UCmgGZbfjmk',
                        moments: [{ time: '1:10', text: 'ÏïàÎ¨¥ ÎÑàÎ¨¥ Í∑ÄÏó¨Ïõå', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            }
        };

        // Local Storage Key (Backup)
        const STORAGE_KEY = `relovetree_data_${treeId}`;

        // Initialize Firebase
        let db;
        let auth;
        let storage;
        let currentUser = null;
        let isReadOnly = false;

        // YouTube Player State
        let ytPlayer = null;
        let youTubeApiReady = false;

        let originalNodes = [];

        // Global State
        const state = {
            nodes: [],
            edges: [],
            transform: { x: 0, y: 0, k: 1 },
            isDragging: false,
            isPanning: false,
            selectedNode: null,
            dragStart: { x: 0, y: 0 },
            activeNodeId: null,
            likes: [],
            comments: []
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            initApp(); // from shared.js
            initAuth(); // from auth.js

            // Wait for Auth
            currentUser = await waitForAuth();
            console.log("Current User:", currentUser ? currentUser.email : "Guest");

            // Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÎäî Ìï≠ÏÉÅ ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÎ°ú Ï†úÌïú
            if (!currentUser) {
                isReadOnly = true;
            }

            if (typeof firebase !== 'undefined' && firebase.apps.length) {
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
            }

            // Load Data and Initialize State
            await loadData();

            // ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÎùºÎ©¥ UIÏóêÏÑú Ìé∏Ïßë Í¥ÄÎ†® Î≤ÑÌäº/Ïª®Ìä∏Î°§ÏùÑ Ïà®ÍπÄ
            updateUIForReadOnly();

            // Apply viewport settings
            const savedViewport = localStorage.getItem(VIEWPORT_MODE_KEY);
            if (savedViewport) {
                viewportMode = savedViewport;
                applyViewportLayout();
                updateViewportButtons();
            }
        });

        // Load Data (Firebase -> LocalStorage -> Dummy)
        // Default to 'bts' data if treeId not found in dummyData
        // let initialData = ... (Removed to avoid duplication, declared below)

        // Async Load Function
        async function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const treeId = urlParams.get('id') || 'bts';
            const currentTreeId = treeId;

            let loadedData = null;

            // 1. Try Firebase (if available)
            if (typeof db !== 'undefined' && db) {
                try {
                    const docRef = db.collection('trees').doc(treeId);
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        const data = docSnap.data();
                        console.log("Document data from Firebase:", data);

                        // Check Ownership
                        if (currentUser && data.ownerId && data.ownerId !== currentUser.uid) {
                            isReadOnly = true;
                            showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                            document.getElementById('tree-title').classList.add('bg-slate-100', 'text-slate-500');
                        } else if (!currentUser && data.ownerId) {
                            isReadOnly = true;
                            showToast("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. (ÏùΩÍ∏∞ Ï†ÑÏö©)");
                        }

                        if (data.nodes && data.nodes.length > 0) {
                            loadedData = data;
                        }
                    }
                } catch (error) {
                    console.error("Error getting document from Firebase:", error);
                }
            }

            // 2. Try LocalStorage
            if (!loadedData) {
                const localData = localStorage.getItem(`relovetree_data_${treeId}`);
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        if (parsed.nodes && parsed.edges) {
                            console.log('Loaded from LocalStorage');
                            loadedData = parsed;
                        }
                    } catch (e) {
                        console.error('LocalStorage parse error', e);
                    }
                }
            }

            // 3. Try Dummy Data (Ìï≠ÏÉÅ ÏùΩÍ∏∞ Ï†ÑÏö©ÏúºÎ°ú Ï∑®Í∏â)
            if (!loadedData && dummyData[treeId]) {
                console.log('Loaded from Dummy Data');
                loadedData = dummyData[treeId];
                isReadOnly = true;
            }

            // 4. Default to Empty Tree for new IDs (Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê Ï†ÑÏö©)
            if (!loadedData) {
                console.log('New tree created for ID:', treeId);
                loadedData = {
                    name: treeId ? decodeURIComponent(treeId) : 'My Tree',
                    nodes: [
                        {
                            id: 1,
                            x: window.innerWidth / 2 - 140,
                            y: window.innerHeight / 2 - 100,
                            title: 'Ïó¨Ï†ïÏùò ÏãúÏûë',
                            date: new Date().toISOString().split('T')[0],
                            videoId: '',
                            moments: [],
                            details: 'Ïó¨Í∏∞Î•º ÌÅ¥Î¶≠ÌïòÏó¨ Ï≤´ Î≤àÏß∏ ÏàúÍ∞ÑÏùÑ Í∏∞Î°ùÌï¥Î≥¥ÏÑ∏Ïöî.'
                        }
                    ],
                    edges: [],
                    likes: [],
                    comments: []
                };

                // Ïù∏Îç±Ïä§ ÌéòÏù¥ÏßÄ "ÏµúÍ∑º Î∞©Î¨∏Ìïú Ìä∏Î¶¨"Ïóê Î∞îÎ°ú Î≥¥Ïù¥ÎèÑÎ°ù Ï¥àÍ∏∞ ÏÉÅÌÉúÎ•º Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ Î∞è FirestoreÏóê Í∏∞Î°ù
                try {
                    const initialDataForIndex = {
                        name: loadedData.name,
                        nodes: loadedData.nodes,
                        edges: loadedData.edges,
                        lastUpdated: new Date().toISOString(),
                        ownerId: currentUser ? currentUser.uid : null
                    };

                    // Î°úÏª¨ Î∞±ÏóÖ
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(initialDataForIndex));

                    // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÎùºÎ©¥ Ï¶âÏãú FirestoreÏóêÎèÑ ÏÉùÏÑ±
                    if (db && currentUser) {
                        await db.collection('trees').doc(treeId).set(initialDataForIndex, { merge: true });
                    }
                } catch (e) {
                    console.error('Initial save failed', e);
                }
            }

            // Initialize State and Render
            if (loadedData) {
                initState(loadedData);
                document.getElementById('tree-title').innerText = loadedData.name || 'My Tree';
                render();
            }

            return loadedData;
        }

        // Removed redundant loadFromLocalOrDummy and initialData
        // All loading logic is now handled in loadData() and initState()

        function updateUIForReadOnly() {
            if (isReadOnly) {
                // Hide Add Button
                const fab = document.querySelector('button[onclick="createNewNode()"]');
                if (fab) fab.classList.add('hidden');

                // Hide Reset Button
                const resetBtn = document.getElementById('btn-reset');
                if (resetBtn) resetBtn.classList.add('hidden');

                // Disable Title Edit (visual only, logic handled in save)
                document.getElementById('tree-title').contentEditable = "false";
            }
        }

        // Global State moved to top of script
        // initialData usage removed

        // Initialize State with Data
        function initState(data) {
            // Deep copy for reset
            const nodesSource = data.nodes.length > 0 ? data.nodes : [{
                id: 1, x: window.innerWidth / 2 - 140, y: window.innerHeight / 2 - 100, title: 'Ïó¨Ï†ïÏùò ÏãúÏûë', date: new Date().toISOString().split('T')[0], videoId: '', moments: []
            }];

            originalNodes = JSON.parse(JSON.stringify(nodesSource));
            state.nodes = JSON.parse(JSON.stringify(originalNodes));
            state.edges = data.edges || [];
            state.likes = data.likes || [];
            state.comments = data.comments || [];

            // Reset transform
            state.transform = { x: 0, y: 0, k: 1 };
        }

        let editorMode = 'tree';

        function setEditorMode(mode) {
            if (mode !== 'tree' && mode !== 'timeline') return;
            editorMode = mode;

            const bodyEl = document.body;
            if (bodyEl) {
                if (mode === 'timeline') {
                    bodyEl.classList.add('editor-timeline');
                } else {
                    bodyEl.classList.remove('editor-timeline');
                }
            }

            const treeBtn = document.getElementById('mode-tree-btn');
            const listBtn = document.getElementById('mode-timeline-btn');

            if (treeBtn && listBtn) {
                if (mode === 'tree') {
                    treeBtn.classList.add('bg-slate-800', 'text-white');
                    treeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    listBtn.classList.remove('bg-slate-800', 'text-white');
                    listBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    listBtn.classList.add('bg-slate-800', 'text-white');
                    listBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    treeBtn.classList.remove('bg-slate-800', 'text-white');
                    treeBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }

            render();
        }

        const VIEWPORT_MODE_KEY = 'relovetree_viewport_mode';
        let viewportMode = 'desktop';
        let orientationMode = 'portrait';

        function applyViewportLayout() {
            const wrapper = document.getElementById('wrapper');
            if (!wrapper) return;

            const header = document.querySelector('body > div.fixed');
            const headerHeight = header ? header.offsetHeight + 16 : 0; // Ìó§Îçî ÏïÑÎûò Ïó¨Ïú† Í≥µÍ∞Ñ ÏïΩÍ∞Ñ Ï∂îÍ∞Ä
            const viewportHeight = window.innerHeight;

            if (viewportMode === 'desktop') {
                wrapper.style.width = '100vw';
                wrapper.style.height = '100vh';
                wrapper.style.maxWidth = '';
                wrapper.style.maxHeight = '';
                wrapper.style.margin = '0';
                wrapper.style.borderRadius = '0';
                wrapper.style.boxShadow = 'none';
                wrapper.style.background = 'transparent';
                wrapper.style.border = 'none';
                wrapper.style.backdropFilter = '';
                wrapper.style.webkitBackdropFilter = '';
                wrapper.style.overflow = 'visible';
            } else {
                let width = 430;
                let height = 780;

                if (orientationMode === 'landscape') {
                    width = 780;
                    height = 430;
                }

                const bottomPadding = 32; // Ïù∏Îç±Ïä§ Î™®Î∞îÏùº ÌîÑÎ¶¨Î∑∞ÏôÄ ÎπÑÏä∑Ìïú ÌïòÎã® Ïó¨Î∞±
                const availableHeight = Math.max(0, viewportHeight - headerHeight - bottomPadding);
                const finalHeight = Math.min(height, availableHeight || height);
                const extraSpace = Math.max(0, availableHeight - finalHeight);

                const marginTop = headerHeight + extraSpace / 2;
                const marginBottom = bottomPadding + extraSpace / 2;

                wrapper.style.width = width + 'px';
                wrapper.style.maxWidth = '100vw';
                wrapper.style.height = finalHeight + 'px';
                wrapper.style.maxHeight = '';
                wrapper.style.margin = `${marginTop}px auto ${marginBottom}px`;
                wrapper.style.borderRadius = '55px';
                wrapper.style.border = '8px solid rgba(255, 255, 255, 0.4)';
                wrapper.style.background = 'rgba(255, 255, 255, 0.25)';
                wrapper.style.backdropFilter = 'blur(25px)';
                wrapper.style.webkitBackdropFilter = 'blur(25px)';
                wrapper.style.boxShadow = '0 30px 60px rgba(15,23,42,0.5)';
                wrapper.style.overflow = 'hidden';
            }

            // Î∞∞Í≤ΩÏÉâ Í∞ïÏ†ú ÏÑ§Ï†ï Ï†úÍ±∞ (ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Îî∞Î¶Ñ)
            // document.body.style.backgroundColor = '#f8fafc';
        }

        function setViewportMode(mode) {
            if (mode !== 'desktop' && mode !== 'mobile') return;
            viewportMode = mode;

            const desktopBtn = document.getElementById('viewport-desktop-btn');
            const mobileBtn = document.getElementById('viewport-mobile-btn');

            applyViewportLayout();

            const bodyEl = document.body;
            if (bodyEl) {
                if (mode === 'mobile') {
                    bodyEl.classList.add('editor-mobile');
                } else {
                    bodyEl.classList.remove('editor-mobile');
                }
            }

            if (desktopBtn && mobileBtn) {
                if (mode === 'desktop') {
                    desktopBtn.classList.add('bg-slate-800', 'text-white');
                    desktopBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    mobileBtn.classList.remove('bg-slate-800', 'text-white');
                    mobileBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    mobileBtn.classList.add('bg-slate-800', 'text-white');
                    mobileBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    desktopBtn.classList.remove('bg-slate-800', 'text-white');
                    desktopBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }

            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Î™®ÎìúÎ•º Í∏∞Ïñµ
            try {
                localStorage.setItem(VIEWPORT_MODE_KEY, mode);
            } catch (e) { }
        }

        function updateViewportButtons() {
            const desktopBtn = document.getElementById('viewport-desktop-btn');
            const mobileBtn = document.getElementById('viewport-mobile-btn');

            if (!desktopBtn || !mobileBtn) return;

            if (viewportMode === 'desktop') {
                desktopBtn.classList.add('bg-slate-800', 'text-white');
                desktopBtn.classList.remove('bg-slate-100', 'text-slate-600');
                mobileBtn.classList.remove('bg-slate-800', 'text-white');
                mobileBtn.classList.add('bg-slate-100', 'text-slate-600');
            } else if (viewportMode === 'mobile') {
                mobileBtn.classList.add('bg-slate-800', 'text-white');
                mobileBtn.classList.remove('bg-slate-100', 'text-slate-600');
                desktopBtn.classList.remove('bg-slate-800', 'text-white');
                desktopBtn.classList.add('bg-slate-100', 'text-slate-600');
            }
        }

        function setOrientationMode(mode) {
            if (mode !== 'portrait' && mode !== 'landscape') return;
            orientationMode = mode;

            const portraitBtn = document.getElementById('orientation-portrait-btn');
            const landscapeBtn = document.getElementById('orientation-landscape-btn');

            applyViewportLayout();

            if (portraitBtn && landscapeBtn) {
                if (orientationMode === 'portrait') {
                    portraitBtn.classList.add('bg-slate-800', 'text-white');
                    portraitBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    landscapeBtn.classList.remove('bg-slate-800', 'text-white');
                    landscapeBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    landscapeBtn.classList.add('bg-slate-800', 'text-white');
                    landscapeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    portraitBtn.classList.remove('bg-slate-800', 'text-white');
                    portraitBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }
        }

        // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω ÏãúÏóêÎèÑ Î†àÏù¥ÏïÑÏõÉ Ïû¨Í≥ÑÏÇ∞
        window.addEventListener('resize', applyViewportLayout);

        // Initial viewport mode (Ïã§Ï†ú Í∏∞Í∏∞ ÌÅ¨Í∏∞ + Ï†ÄÏû•Îêú Í∞í Í∏∞Ï§Ä)
        (function initViewportMode() {
            let initialMode = 'desktop';

            try {
                const saved = localStorage.getItem(VIEWPORT_MODE_KEY);
                if (saved === 'desktop' || saved === 'mobile') {
                    initialMode = saved;
                } else if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                    initialMode = 'mobile';
                }
            } catch (e) { }

            setViewportMode(initialMode);
        })();

        // ================== BACKGROUND PREFERENCES (Copied from index.js) ==================
        const BG_STORAGE_KEY = 'relovetree_background';

        function applyBackgroundConfig(config) {
            const body = document.body;
            if (!body || !config) return;

            if (config.type === 'image' && config.value) {
                body.style.backgroundImage = `url('${config.value}')`;
                body.style.backgroundSize = 'cover';
                body.style.backgroundPosition = 'center';
                body.style.backgroundRepeat = 'no-repeat';
                body.style.backgroundColor = ''; // Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö© Ïãú Î∞∞Í≤ΩÏÉâ Ï¥àÍ∏∞Ìôî
            } else if (config.type === 'color' && config.value) {
                body.style.backgroundImage = '';
                body.style.backgroundColor = config.value;
            }
        }

        function loadBackgroundPreference() {
            // shared.jsÏùò safeLocalStorageGet ÏÇ¨Ïö©
            const saved = safeLocalStorageGet(BG_STORAGE_KEY, null);
            if (saved && (saved.type === 'image' || saved.type === 'color')) {
                applyBackgroundConfig(saved);
            }
            // Ï†ÄÏû•Îêú ÏÑ§Ï†ïÏù¥ ÏóÜÏúºÎ©¥ CSSÏóêÏÑú ÏÑ§Ï†ïÌïú Í∏∞Î≥∏ Î∞∞Í≤ΩÏùÑ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
        }

        // Load background on startup
        loadBackgroundPreference();

        // Save Data (Firebase + LocalStorage)
        // Simple debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const saveData = debounce(async () => {
            if (isReadOnly) {
                console.log("Read-only mode. Save skipped.");
                return;
            }

            const dataToSave = {
                name: document.getElementById('tree-title').innerText,
                nodes: state.nodes,
                edges: state.edges,
                lastUpdated: new Date().toISOString(),
                ownerId: currentUser ? currentUser.uid : null // Add ownerId
            };

            // 1. Save to LocalStorage (Backup & Speed)
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) { console.error("Local save failed", e); }

            // 2. Save to Firebase
            if (db) {
                if (!currentUser) {
                    // Optional: Warn user that data is only local
                    // showToast("Î°úÍ∑∏Ïù∏ÌïòÎ©¥ ÌÅ¥ÎùºÏö∞ÎìúÏóê Ï†ÄÏû•Îê©ÎãàÎã§.");
                    return;
                }

                try {
                    await db.collection('trees').doc(treeId).set(dataToSave, { merge: true });
                    console.log("Data saved to Firebase");
                    showToast("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§");
                } catch (e) {
                    console.error("Firebase save failed", e);
                    showToast("ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• Ïã§Ìå® (Î°úÏª¨ÏóêÎßå Ï†ÄÏû•Îê®)");
                }
            }
        }, 1000); // Debounce 1s

        function shareTree() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showToast("ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§! ÏπúÍµ¨ÏóêÍ≤å Í≥µÏú†ÌïòÏÑ∏Ïöî.");
            }).catch(err => {
                console.error('Async: Could not copy text: ', err);
                prompt("Ïù¥ ÎßÅÌÅ¨Î•º Î≥µÏÇ¨Ìï¥ÏÑú Í≥µÏú†ÌïòÏÑ∏Ïöî:", url);
            });
        }

        // --- Community Features ---

        function updateLikeUI() {
            const btn = document.getElementById('like-btn');
            const countEl = document.getElementById('like-count');

            countEl.innerText = state.likes.length;

            if (currentUser && state.likes.includes(currentUser.uid)) {
                btn.classList.add('text-pink-500', 'bg-pink-50');
                btn.classList.remove('text-slate-400', 'bg-white');
            } else {
                btn.classList.remove('text-pink-500', 'bg-pink-50');
                btn.classList.add('text-slate-400', 'bg-white');
            }
        }

        async function toggleLike() {
            if (!currentUser) {
                showToast("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
            }

            const uid = currentUser.uid;
            const index = state.likes.indexOf(uid);

            let newLikes = [...state.likes];
            if (index === -1) {
                newLikes.push(uid);
            } else {
                newLikes.splice(index, 1);
            }

            // Optimistic UI Update
            state.likes = newLikes;
            updateLikeUI();

            try {
                await db.collection('trees').doc(treeId).update({
                    likes: newLikes
                });
            } catch (error) {
                console.error("Error updating likes:", error);
                showToast("Ï¢ãÏïÑÏöî ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®");
                // Revert
                if (index === -1) state.likes.pop();
                else state.likes.push(uid);
                updateLikeUI();
            }
        }

        let commentsUnsubscribe = null;

        function loadComments() {
            if (commentsUnsubscribe) commentsUnsubscribe();

            commentsUnsubscribe = db.collection('trees').doc(treeId).collection('comments')
                .orderBy('createdAt', 'asc')
                .onSnapshot((snapshot) => {
                    state.comments = [];
                    snapshot.forEach(doc => {
                        state.comments.push({ id: doc.id, ...doc.data() });
                    });
                    updateCommentUI();
                });
        }

        function updateCommentUI() {
            const countEl = document.getElementById('comment-count');
            const modalCountEl = document.getElementById('modal-comment-count');
            const listEl = document.getElementById('comments-list');

            countEl.innerText = state.comments.length;
            modalCountEl.innerText = state.comments.length;

            if (state.comments.length === 0) {
                listEl.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div>';
                return;
            }

            listEl.innerHTML = state.comments.map(c => `
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">
                        ${c.userName ? c.userName[0].toUpperCase() : '?'}
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-3 rounded-r-xl rounded-bl-xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-slate-700">${c.userName || 'ÏùµÎ™Ö'}</span>
                                <span class="text-[10px] text-slate-400">${new Date(c.createdAt?.toDate()).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-slate-800">${c.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            listEl.scrollTop = listEl.scrollHeight;
        }

        function openCommentsModal() {
            const modal = document.getElementById('comments-modal');
            modal.showModal();
            // Load comments if not already loaded (though loadData calls it)
            if (!commentsUnsubscribe && db) loadComments();
        }

        async function addComment(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
            }

            const input = document.getElementById('new-comment-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = ''; // Clear input immediately

            // Handle Anonymous User Name
            let userName = 'ÏùµÎ™Ö';
            if (currentUser.displayName) {
                userName = currentUser.displayName;
            } else if (currentUser.email) {
                userName = currentUser.email.split('@')[0];
            } else if (currentUser.isAnonymous) {
                userName = 'Guest';
            } else if (currentUser.isAnonymous) {
                userName = 'Guest';
            }

            try {
                await db.collection('trees').doc(treeId).collection('comments').add({
                    text: text,
                    userId: currentUser.uid,
                    userName: userName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error adding comment:", error);
                showToast("ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®");
                input.value = text; // Restore input on fail
            }
        }

        // Simple Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity duration-300 z-50';
            toast.innerText = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('opacity-0'));
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        const canvas = document.getElementById('canvas');
        const connections = document.getElementById('connections');

        function render() {
            const timeline = document.getElementById('timeline');

            if (editorMode === 'timeline') {
                if (canvas) canvas.classList.add('hidden');
                if (connections) connections.innerHTML = '';
                if (timeline) timeline.classList.remove('hidden');
                renderTimeline();
                return;
            }

            if (timeline) timeline.classList.add('hidden');
            if (canvas) canvas.classList.remove('hidden');

            canvas.style.transform = `translate(${state.transform.x}px, ${state.transform.y}px) scale(${state.transform.k})`;
            document.getElementById('zoom-level').innerText = Math.round(state.transform.k * 100) + '%';

            connections.innerHTML = '';
            document.querySelectorAll('.node').forEach(el => el.remove());

            state.edges.forEach(edge => {
                const from = state.nodes.find(n => n.id === edge.from);
                const to = state.nodes.find(n => n.id === edge.to);
                if (from && to) drawConnection(from, to);
            });

            state.nodes.forEach(node => {
                const el = document.createElement('div');

                el.className = `node ${state.selectedNode === node.id ? 'selected' : ''}`;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';

                const hasVideo = !!node.videoId;
                const thumbUrl = hasVideo ? getYouTubeThumb(node.videoId, 'hqdefault') : '';

                el.innerHTML = `
                    <div class="h-40 bg-black relative group overflow-hidden">
                        ${hasVideo
                        ? `<div class="w-full h-full relative overflow-hidden">
                                    <img src="${thumbUrl}" alt="YouTube thumbnail" class="w-full h-full object-cover" />
                                    <div class="absolute inset-0 bg-black/25"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                               </div>`
                        : (node.imageUrl
                            ? `<div class="w-full h-full relative overflow-hidden">
                                <img src="${node.imageUrl}" alt="Node Image" class="w-full h-full object-cover" />
                               </div>`
                            : `<div class="w-full h-full flex items-center justify-center bg-slate-800 text-slate-300 text-xs">No Media</div>`
                        )
                    }
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur">
                            ${node.moments.length} Moments
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight line-clamp-1 mb-1">${node.title}</h3>
                        <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                    </div>
                    <!-- Connect Handles -->
                    <div class="absolute top-1/2 -right-3 w-6 h-6 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center cursor-crosshair hover:border-brand-500 text-slate-400 hover:text-brand-500 z-30 connection-handle" title="Drag to connect">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>
                `;

                el.onmousedown = (e) => startDragNode(e, node);

                el.onclick = (e) => {
                    if (!state.isDragging) {
                        e.stopPropagation();
                        openDetailModal(node);
                    }
                };

                canvas.appendChild(el);
            });
        }

        function drawConnection(from, to) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const startX = from.x + 280;
            const startY = from.y + 100;
            const endX = to.x;
            const endY = to.y + 100;

            const cp1X = startX + (endX - startX) * 0.5;
            const cp1Y = startY;
            const cp2X = endX - (endX - startX) * 0.5;
            const cp2Y = endY;

            const d = `M ${startX} ${startY} C ${cp1X} ${cp1Y}, ${cp2X} ${cp2Y}, ${endX} ${endY}`;

            path.setAttribute('d', d);
            path.setAttribute('stroke', '#cbd5e1');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            connections.appendChild(path);
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;

            timeline.innerHTML = '';

            const nodes = [...state.nodes];
            nodes.sort((a, b) => {
                const ad = a.date || '';
                const bd = b.date || '';
                if (ad === bd) return 0;
                return ad < bd ? -1 : 1;
            });

            if (nodes.length === 0) {
                timeline.innerHTML = '<div class="h-full flex items-center justify-center text-slate-400 text-sm px-6 text-center">ÏïÑÏßÅ Îì±Î°ùÎêú ÏàúÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§.<br>ÏïÑÎûò + Î≤ÑÌäºÏúºÎ°ú Ï≤´ ÏàúÍ∞ÑÏùÑ Ï∂îÍ∞ÄÌï¥ Î≥¥ÏÑ∏Ïöî.</div>';
                return;
            }

            nodes.forEach(node => {
                const card = document.createElement('div');
                card.className = 'timeline-card mx-auto mt-4 w-full max-w-md rounded-2xl bg-white shadow-sm border border-slate-200 overflow-hidden';
                card.dataset.nodeId = node.id;

                const hasVideo = !!node.videoId;
                const thumbUrl = hasVideo ? getYouTubeThumb(node.videoId, 'hqdefault') : '';

                const moments = node.moments || [];
                let feelingSummary = 'ÏïÑÏßÅ Í∞êÏ†ï Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.';
                if (moments.length > 0) {
                    const counts = {};
                    moments.forEach(m => {
                        const f = m.feeling || 'other';
                        counts[f] = (counts[f] || 0) + 1;
                    });

                    let topFeeling = null;
                    let topCount = 0;
                    Object.keys(counts).forEach(f => {
                        if (f !== 'other' && counts[f] > topCount) {
                            topFeeling = f;
                            topCount = counts[f];
                        }
                    });
                    if (!topFeeling) {
                        topFeeling = Object.keys(counts)[0];
                    }
                    const emoji = getFeelingEmoji(topFeeling);
                    feelingSummary = `${emoji} Ìè¨Ìï® ${moments.length}Ìöå`;
                }

                card.innerHTML = `
                    <div class="bg-black h-40 relative overflow-hidden">
                        ${hasVideo
                        ? `<div class="w-full h-full relative overflow-hidden">
                                    <img src="${thumbUrl}" alt="YouTube thumbnail" class="w-full h-full object-cover" />
                                    <div class="absolute inset-0 bg-black/25"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                            <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                               </div>`
                        : (node.imageUrl
                            ? `<div class="w-full h-full relative overflow-hidden">
                                <img src="${node.imageUrl}" alt="Node Image" class="w-full h-full object-cover" />
                               </div>`
                            : `<div class="w-full h-full flex items-center justify-center bg-slate-800 text-slate-300 text-xs">No Media</div>`
                        )
                    }
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base leading-snug mb-1 line-clamp-2">${node.title}</h3>
                                <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                                <p class="mt-1 text-[11px] text-slate-400">${feelingSummary}</p>
                                <div class="mt-1 flex gap-1">
                                    <button type="button" class="w-7 h-7 rounded-full bg-pink-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'love')">üòç</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-sky-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'tear')">üò≠</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-amber-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'funny')">ü§£</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-violet-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'shock')">üò≤</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1 shrink-0">
                                <button type="button" class="px-3 py-1.5 rounded-full bg-brand-500 text-white text-xs font-bold"
                                    onclick="event.stopPropagation(); openDetailFromTimeline(${node.id})">Ïó¥Í∏∞</button>
                                <button type="button" class="px-2 py-1 rounded-full bg-slate-100 text-[11px] text-slate-600"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">Îπ†Î•∏ÏàòÏ†ï</button>
                            </div>
                        </div>
                        <form class="quick-edit-form hidden mt-2 space-y-2" onsubmit="saveQuickEdit(event, ${node.id})">
                            <div>
                                <input type="text" class="quick-edit-title w-full px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="Ï†úÎ™©" />
                            </div>
                            <div class="flex gap-2">
                                <input type="date" class="quick-edit-date flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg" />
                                <input type="text" class="quick-edit-video flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="Ïú†ÌäúÎ∏å URL" />
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="px-2 py-1 text-[11px] text-slate-500"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">Ï∑®ÏÜå</button>
                                <button type="submit" class="px-3 py-1 text-[11px] font-bold text-white bg-brand-500 rounded-full">
                                    Ï†ÄÏû•
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                card.onclick = () => openDetailModal(node);
                timeline.appendChild(card);
            });
        }

        function openDetailFromTimeline(nodeId) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;
            openDetailModal(node);
        }

        function toggleQuickEdit(nodeId) {
            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const form = card.querySelector('.quick-edit-form');
            if (!form) return;

            if (form.classList.contains('hidden')) {
                const node = state.nodes.find(n => n.id === nodeId);
                if (!node) return;

                const titleInput = form.querySelector('.quick-edit-title');
                const dateInput = form.querySelector('.quick-edit-date');
                const videoInput = form.querySelector('.quick-edit-video');

                if (titleInput) titleInput.value = node.title || '';
                if (dateInput) dateInput.value = node.date || '';
                if (videoInput) videoInput.value = node.videoId ? 'https://youtu.be/' + node.videoId : '';
            }

            form.classList.toggle('hidden');
        }

        function saveQuickEdit(e, nodeId) {
            e.preventDefault();
            e.stopPropagation();

            if (isReadOnly) {
                showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                return;
            }

            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const titleInput = card.querySelector('.quick-edit-title');
            const dateInput = card.querySelector('.quick-edit-date');
            const videoInput = card.querySelector('.quick-edit-video');

            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const newTitle = titleInput ? titleInput.value.trim() : '';
            const newDate = dateInput ? dateInput.value : '';
            const videoUrl = videoInput ? videoInput.value.trim() : '';

            if (newTitle) node.title = newTitle;
            node.date = newDate;

            let videoId = '';
            if (videoUrl) {
                const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
                if (match) videoId = match[1];
            }

            node.videoId = videoId;

            // Ï†ÄÏû• Î∞è Îã§Ïãú Í∑∏Î¶¨Í∏∞
            render();
            saveData();
        }

        function addQuickFeeling(nodeId, feeling) {
            if (isReadOnly) {
                showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                return;
            }
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            if (!Array.isArray(node.moments)) {
                node.moments = [];
            }

            node.moments.push({
                time: '00:00',
                text: '',
                feeling
            });

            render();
            saveData();
        }

        // --- Interactions ---
        let dragStartX = 0;
        let dragStartY = 0;
        let isDraggingNode = false;

        function startDragNode(e, node) {
            if (isReadOnly) return; // Prevent dragging in read-only mode
            if (e.target.closest('.connection-handle')) return; // Don't drag if clicking connection handle
            e.stopPropagation();
            isDraggingNode = true;
            state.selectedNode = node.id;
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            state.dragStart = {
                x: e.clientX / state.transform.k - node.x,
                y: e.clientY / state.transform.k - node.y
            };
            // Do NOT set state.isDragging = true here yet
        }

        window.onmousemove = (e) => {
            if (isDraggingNode && state.selectedNode) {
                // Check threshold to distinguish click from drag
                const dist = Math.hypot(e.clientX - dragStartX, e.clientY - dragStartY);
                if (dist > 5) {
                    state.isDragging = true;
                }

                if (state.isDragging) {
                    const node = state.nodes.find(n => n.id === state.selectedNode);
                    if (node) {
                        node.x = e.clientX / state.transform.k - state.dragStart.x;
                        node.y = e.clientY / state.transform.k - state.dragStart.y;
                        render();
                    }
                }
            } else if (state.isPanning) {
                state.transform.x += e.movementX;
                state.transform.y += e.movementY;
                render();
            }
        };

        window.onmouseup = () => {
            // Delay clearing slightly to allow node.onmouseup to fire with correct state
            setTimeout(() => {
                if (state.isDragging) {
                    saveData(); // Save position after drag
                }
                isDraggingNode = false;
                state.isDragging = false;
                state.isPanning = false;
            }, 0);
        };

        document.getElementById('wrapper').onmousedown = (e) => {
            if (e.target.id === 'wrapper' || e.target.id === 'canvas') {
                state.isPanning = true;
                state.selectedNode = null;
                render();
            }
        };

        document.getElementById('wrapper').onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            state.transform.k = Math.max(0.1, Math.min(3, state.transform.k * delta));
            render();
        };

        // --- Drag & Drop YouTube URL ---
        const wrapperEl = document.getElementById('wrapper');
        if (wrapperEl) {
            wrapperEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
            });

            wrapperEl.addEventListener('drop', (e) => {
                e.preventDefault();

                if (isReadOnly) {
                    showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                    return;
                }

                const dataTransfer = e.dataTransfer;
                if (!dataTransfer) return;

                const url = dataTransfer.getData('text/uri-list') || dataTransfer.getData('text/plain');
                if (!url) return;

                const videoId = validateYouTubeUrl(url);
                if (!videoId) {
                    showToast('Ïú†ÌäúÎ∏å Ï£ºÏÜåÎ•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                    return;
                }

                let targetNode = null;
                if (state.selectedNode) {
                    targetNode = state.nodes.find(n => n.id === state.selectedNode) || null;
                }

                if (!targetNode) {
                    targetNode = {
                        id: Date.now(),
                        x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                        y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                        title: 'New Moment',
                        date: new Date().toISOString().split('T')[0],
                        videoId,
                        moments: []
                    };
                    state.nodes.push(targetNode);
                } else {
                    targetNode.videoId = videoId;
                }

                render();
                saveData();
                showToast('Ïú†ÌäúÎ∏å ÏòÅÏÉÅÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
            });
        }

        // ÏÉÅÏÑ∏ Î™®Îã¨ ÏïàÏóêÏÑúÎèÑ Ïú†ÌäúÎ∏å URL ÎìúÎ°≠ÏúºÎ°ú ÏòÅÏÉÅ ÍµêÏ≤¥ Í∞ÄÎä•ÌïòÎèÑÎ°ù Ï≤òÎ¶¨
        const detailModal = document.getElementById('detail-modal');
        if (detailModal) {
            detailModal.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
            });

            detailModal.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (isReadOnly) {
                    showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                    return;
                }

                const dataTransfer = e.dataTransfer;
                if (!dataTransfer) return;

                const url = dataTransfer.getData('text/uri-list') || dataTransfer.getData('text/plain');
                if (!url) return;

                const videoId = validateYouTubeUrl(url);
                if (!videoId) {
                    showToast('Ïú†ÌäúÎ∏å Ï£ºÏÜåÎ•º Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
                    return;
                }

                const node = state.nodes.find(n => n.id === state.activeNodeId);
                if (!node) return;

                node.videoId = videoId;

                // ÏÉÅÏÑ∏ Î∑∞ÏôÄ Î¶¨Ïä§Ìä∏/Ìä∏Î¶¨ ÎèôÏãúÏóê Í∞±Ïã†
                render();
                openDetailModal(node);
                saveData();
                showToast('Ïú†ÌäúÎ∏å ÏòÅÏÉÅÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
            });
        }

        function zoomIn() {
            state.transform.k *= 1.2;
            render();
        }

        function zoomOut() {
            state.transform.k *= 0.8;
            render();
        }

        function resetLayout() {
            if (confirm(isKorean ? 'Î™®Îì† ÎÖ∏ÎìúÏùò ÏúÑÏπòÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞ÎèÑ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§)' : 'Reset all node positions? (Saved data will be reset)')) {
                state.nodes = JSON.parse(JSON.stringify(originalNodes));
                state.transform = { x: 0, y: 0, k: 1 };

                // Clear Local Storage
                localStorage.removeItem(STORAGE_KEY);

                // Clear Firebase
                if (db) {
                    db.collection('trees').doc(treeId).delete().then(() => {
                        console.log("Firebase document deleted");
                    }).catch((error) => {
                        console.error("Error removing document: ", error);
                    });
                }

                render();
            }
        }

        // --- Video Helpers ---
        function onYouTubeIframeAPIReady() {
            youTubeApiReady = true;
        }

        function startVideo(videoId, startSeconds) {
            if (!videoId) return;
            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            // Ïö∞ÏÑ† YouTube IFrame Player API ÏÇ¨Ïö© ÏãúÎèÑ
            if (youTubeApiReady && typeof YT !== 'undefined' && typeof YT.Player === 'function') {
                const startSec = (typeof startSeconds === 'number' && Number.isFinite(startSeconds) && startSeconds > 0)
                    ? Math.floor(startSeconds)
                    : 0;

                if (!ytPlayer) {
                    ytPlayer = new YT.Player('detail-video', {
                        videoId: videoId,
                        playerVars: {
                            playsinline: 1,
                            rel: 0,
                            modestbranding: 1,
                            autoplay: 1,
                            start: startSec
                        }
                    });
                } else {
                    ytPlayer.loadVideoById({
                        videoId: videoId,
                        startSeconds: startSec
                    });
                }

                if (iframe) {
                    iframe.classList.remove('hidden');
                }
                if (placeholder) {
                    placeholder.classList.add('hidden');
                }
                return;
            }

            // Ìè¥Î∞±: Îã®Ïàú iframe src ÍµêÏ≤¥
            const params = new URLSearchParams({
                playsinline: 1,
                rel: 0,
                modestbranding: 1,
                autoplay: 1
            });

            if (typeof startSeconds === 'number' && Number.isFinite(startSeconds) && startSeconds > 0) {
                params.set('start', String(Math.floor(startSeconds)));
            }

            iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?${params.toString()}`;
            iframe.classList.remove('hidden');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }
        }

        function setCurrentMomentTime() {
            const input = document.getElementById('new-moment-time');
            if (!input) return;

            let seconds = 0;

            if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                try {
                    seconds = ytPlayer.getCurrentTime();
                } catch (e) {
                    seconds = 0;
                }
            }

            if (!Number.isFinite(seconds) || seconds < 0) {
                seconds = 0;
            }

            const total = Math.floor(seconds);

            if (typeof secondsToTime === 'function') {
                input.value = secondsToTime(total);
            } else {
                const m = Math.floor(total / 60);
                const s = total % 60;
                input.value = `${m}:${s.toString().padStart(2, '0')}`;
            }
        }

        // --- Unified Detail Modal & Other Logic ---
        function openDetailModal(node) {
            state.activeNodeId = node.id;
            document.getElementById('detail-title').innerText = node.title;
            document.getElementById('detail-date').innerText = node.date;
            document.getElementById('edit-title').value = node.title;
            document.getElementById('edit-date').value = node.date;
            document.getElementById('edit-video').value = node.videoId ? `https://youtu.be/${node.videoId}` : '';

            // Î™®Îã¨ÏùÑ Ïó¥ ÎïåÎäî ÏùΩÍ∏∞ Î™®ÎìúÎ°ú ÎëêÍ≥†, Edit Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ ÎïåÎßå Ìé∏Ïßë ÌèºÏùÑ Ïó∞Îã§
            disableEditMode();

            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            // Update Media View
            updateDetailMedia(node);

            // Edit Form - Image Preview
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            if (node.imageUrl) {
                imagePreview.src = node.imageUrl;
                imagePreviewContainer.classList.remove('hidden');
            } else {
                imagePreviewContainer.classList.add('hidden');
            }

            renderMomentsList(node.moments);
            const modal = document.getElementById('detail-modal');
            modal.showModal();
        }

        function renderMomentsList(moments) {
            const list = document.getElementById('moments-list');
            list.innerHTML = '';

            if (moments.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-10">ÏïÑÏßÅ Í∏∞Î°ùÎêú ÏàúÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§.<br>ÏòÅÏÉÅÏùÑ Î≥¥Î©∞ Í∞êÏ†ïÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div>`;
                return;
            }

            moments.forEach(m => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 items-start';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-lg">
                        ${getFeelingEmoji(m.feeling)}
                    </div>
                    <div class="flex-1 bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded cursor-pointer hover:bg-brand-100" onclick="seekVideo('${m.time}')">
                                ${m.time}
                            </span>
                            <span class="text-[10px] text-slate-400">User</span>
                        </div>
                        <p class="text-sm text-slate-700 leading-snug">${m.text}</p>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function getFeelingEmoji(feeling) {
            const map = { love: 'üòç', tear: 'üò≠', funny: 'ü§£', shock: 'üò≤' };
            return map[feeling] || 'üòä';
        }

        function seekVideo(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node || !node.videoId) return;

            startVideo(node.videoId, seconds);
        }

        function addMomentFromDetail(e) {
            e.preventDefault();
            if (isReadOnly) {
                showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                return;
            }
            const time = document.getElementById('new-moment-time').value;
            const text = document.getElementById('new-moment-text').value;
            const feeling = document.querySelector('input[name="new-moment-feeling"]:checked').value;

            if (!time || !text) return;

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.moments.push({ time, text, feeling });
                renderMomentsList(node.moments);
                render();
                saveData(); // Save after adding moment
                document.getElementById('new-moment-text').value = '';
                document.getElementById('new-moment-time').value = '';
            }
        }

        function enableEditMode() {
            document.getElementById('edit-form').classList.remove('hidden');
        }

        function disableEditMode() {
            document.getElementById('edit-form').classList.add('hidden');
        }

        async function saveNodeDetails(e) {
            e.preventDefault();
            if (isReadOnly) {
                showToast("ÏùΩÍ∏∞ Ï†ÑÏö© Î™®ÎìúÏûÖÎãàÎã§.");
                return;
            }
            const title = document.getElementById('edit-title').value;
            const date = document.getElementById('edit-date').value;
            const videoUrl = document.getElementById('edit-video').value;
            const imageFile = document.getElementById('edit-image').files[0];

            let videoId = '';
            const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (match) videoId = match[1];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.title = title;
                node.date = date;
                if (videoId) node.videoId = videoId;

                // Handle Image Upload
                if (imageFile) {
                    if (!currentUser) {
                        showToast("Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÎäî Î°úÍ∑∏Ïù∏ ÌõÑ Í∞ÄÎä•Ìï©ÎãàÎã§.");
                        return;
                    }

                    // Check for Pro (Optional, strict check in rules)
                    // if (currentUser.role !== 'pro') ... 

                    try {
                        const storageRef = storage.ref();
                        const fileRef = storageRef.child(`users/${currentUser.uid}/trees/${treeId}/nodes/${node.id}/${imageFile.name}`);
                        await fileRef.put(imageFile);
                        const downloadURL = await fileRef.getDownloadURL();
                        node.imageUrl = downloadURL;
                        console.log("Image uploaded:", downloadURL);
                    } catch (error) {
                        console.error("Image upload failed:", error);
                        showToast("Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®: " + error.message);
                        return;
                    }
                }

                document.getElementById('detail-title').innerText = title;
                document.getElementById('detail-date').innerText = date;

                // Update Video/Image View
                updateDetailMedia(node);

                render();
                saveData(); // Save after editing details
                disableEditMode();
            }
        }

        function removeImage() {
            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                delete node.imageUrl;
                document.getElementById('edit-image').value = '';
                document.getElementById('image-preview-container').classList.add('hidden');
                updateDetailMedia(node);
                render();
                saveData();
            }
        }

        function updateDetailMedia(node) {
            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');
            const externalLink = document.getElementById('external-link');

            // Reset
            iframe.src = '';
            iframe.classList.add('hidden');
            placeholder.classList.remove('hidden');
            placeholder.style.backgroundImage = '';
            placeholder.innerHTML = `
                <div class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </div>
                <p class="text-sm font-medium">ÏòÅÏÉÅÏùÑ Î≥¥Î†§Î©¥ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
                <p class="text-xs text-slate-400">Ïç∏ÎÑ§ÏùºÏùÄ Ïà®Í∏∞Í≥†, Ïû¨ÏÉù ÏãúÏóêÎßå ÏòÅÏÉÅÏùÑ Î∂àÎü¨ÏòµÎãàÎã§.</p>
            `;
            externalLink.classList.add('hidden');

            if (node.videoId) {
                const params = new URLSearchParams({
                    playsinline: 1,
                    rel: 0,
                    modestbranding: 1
                });
                // We don't set src immediately to avoid autoplay/loading
                // iframe.src = ... (handled by startVideo or click)

                // Show placeholder with play button
                placeholder.onclick = () => startVideo(node.videoId);
                externalLink.href = `https://www.youtube.com/watch?v=${node.videoId}`;
                externalLink.classList.remove('hidden');
            } else if (node.imageUrl) {
                // Show Image
                placeholder.innerHTML = ''; // Clear play button text
                placeholder.style.backgroundImage = `url('${node.imageUrl}')`;
                placeholder.style.backgroundSize = 'contain';
                placeholder.style.backgroundPosition = 'center';
                placeholder.style.backgroundRepeat = 'no-repeat';
                placeholder.onclick = null;
            } else {
                // No Media
                placeholder.innerHTML = '<p class="text-sm text-slate-300">Îì±Î°ùÎêú ÏòÅÏÉÅ/Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                placeholder.onclick = null;
            }
        }

        function createNewNode() {
            if (isReadOnly) return;
            const newNode = {
                id: Date.now(),
                x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                title: 'New Moment',
                date: new Date().toISOString().split('T')[0],
                videoId: '',
                moments: []
            };
            state.nodes.push(newNode);
            state.activeNodeId = newNode.id;
            render();
            saveData(); // Save after creating node
            openDetailModal(newNode);
        }

        function deleteNode() {
            if (isReadOnly) return;
            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node) return;

            if (confirm(isKorean ? `"${node.title}" ÎÖ∏ÎìúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?` : `Delete "${node.title}"?`)) {
                // Remove edges connected to this node
                state.edges = state.edges.filter(e => e.from !== node.id && e.to !== node.id);

                // Remove the node
                state.nodes = state.nodes.filter(n => n.id !== node.id);

                // ÏÑ†ÌÉù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                state.activeNodeId = null;
                state.selectedNode = null;

                // Close modal
                closeModal('detail-modal');

                // Re-render and save
                render();
                saveData();

                showToast(isKorean ? 'ÎÖ∏ÎìúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§' : 'Node deleted');
            }
        }

        function closeModal(id) {
            document.getElementById(id).close();
            document.getElementById('detail-video').src = '';
        }

        // Î™®Îã¨ Î∞îÍπ•(backdrop)ÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Îã´ÌûàÎèÑÎ°ù Ï≤òÎ¶¨
        const detailModalEl = document.getElementById('detail-modal');
        if (detailModalEl) {
            detailModalEl.addEventListener('click', (e) => {
                const rect = detailModalEl.getBoundingClientRect();
                const isInDialog = (
                    rect.top <= e.clientY && e.clientY <= rect.bottom &&
                    rect.left <= e.clientX && e.clientX <= rect.right
                );

                // Îã§Ïù¥ÏñºÎ°úÍ∑∏ ÏòÅÏó≠ Î∞ñ(Ïñ¥ÎëêÏö¥ Î∞∞Í≤Ω)ÏùÑ ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ÏóêÎßå Îã´Í∏∞
                if (!isInDialog) {
                    closeModal('detail-modal');
                }
            });
        }

        // Initial Load
        loadData();

        // Î™®Î∞îÏùº ÌôîÎ©¥ÏóêÏÑúÎäî Í∏∞Î≥∏ ÏóêÎîîÌÑ∞ Î™®ÎìúÎ•º Î¶¨Ïä§Ìä∏Î°ú ÏÑ§Ï†ï
        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
            setEditorMode('timeline');
        }

    </script>
</body>

</html>