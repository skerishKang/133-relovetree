<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Critical for YouTube Embeds -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>LoveTree Editor</title>
    <!-- Tailwind CSS (Built locally for production) -->
    <link rel="stylesheet" href="output.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            background-color: #f1f5f9;
            overflow: hidden;
        }

        #canvas {
            width: 100vw;
            height: 100vh;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 24px 24px;
            cursor: grab;
            transform-origin: 0 0;
            will-change: transform;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* Simplified Node Style */
        .node {
            position: absolute;
            width: 280px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.3s, transform 0.3s;
            /* Removed 'all' to prevent jitter during drag */
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            z-index: 10;
        }

        .node:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-color: #f43f5e;
        }

        .node.selected {
            border-color: #f43f5e;
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.2);
            z-index: 20;
        }

        .moment-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: 600;
        }

        /* Unified Modal */
        dialog {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            max-width: 1000px;
            width: 95%;
            height: 85vh;
            animation: modal-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fade-in 0.3s ease;
        }

        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Scrollbar for modal content */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div
        class="fixed top-0 left-0 w-full h-16 bg-white/90 backdrop-blur border-b border-slate-200 z-50 flex items-center justify-between px-6 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity" title="ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">
                <div class="w-8 h-8 bg-brand-500 rounded-full flex items-center justify-center text-white shadow-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                </div>
                <h1 class="font-bold text-lg text-slate-800 font-display" id="tree-title">My LoveTree</h1>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <!-- Reset Button -->
            <button onclick="resetLayout()"
                class="text-xs font-bold text-slate-500 hover:text-brand-600 bg-slate-100 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                    </path>
                </svg>
                <span id="btn-reset">Reset</span>
            </button>

            <div class="h-6 w-px bg-slate-200"></div>

            <button onclick="toggleLanguage()"
                class="text-sm font-medium text-slate-500 hover:text-brand-600 transition-colors"
                id="lang-btn">English</button>
            <div class="h-6 w-px bg-slate-200"></div>
            <div class="flex items-center gap-1 bg-slate-100 rounded-full p-1">
                <button onclick="zoomOut()" class="p-1.5 hover:bg-white rounded-full transition-all shadow-sm"
                    title="Zoom Out"><svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg></button>
                <span id="zoom-level" class="text-xs font-bold text-slate-500 w-10 text-center font-mono">100%</span>
                <button onclick="zoomIn()" class="p-1.5 hover:bg-white rounded-full transition-all shadow-sm"
                    title="Zoom In"><svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg></button>
            </div>
        </div>
    </div>

    <!-- Canvas -->
    <div id="wrapper">
        <div id="canvas">
            <svg id="connections">
                <!-- Nodes injected here -->
            </svg>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="createNewNode()"
        class="fixed bottom-8 right-8 w-16 h-16 bg-brand-500 hover:bg-brand-600 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40 group">
        <svg class="w-8 h-8 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span
            class="absolute -top-10 right-0 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">ÏÉàÎ°úÏö¥
            ÏàúÍ∞Ñ Ï∂îÍ∞Ä</span>
    </button>

    <!-- Unified Detail Modal -->
    <dialog id="detail-modal" class="bg-white">
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Video Player -->
            <div class="w-full md:w-2/3 bg-black flex items-center justify-center relative group">
                <iframe id="detail-video" class="w-full h-full aspect-video" src="" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>

                <!-- Fallback / External Link Button -->
                <a id="external-link" href="#" target="_blank"
                    class="absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-1.5 rounded-full backdrop-blur transition-colors flex items-center gap-1 z-20">
                    <span>YouTubeÏóêÏÑú Î≥¥Í∏∞</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>

                <div class="absolute top-4 left-4 z-10">
                    <button onclick="closeModal('detail-modal')"
                        class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur transition-colors md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Right: Details & Moments -->
            <div class="w-full md:w-1/3 flex flex-col h-full border-l border-slate-200 bg-white">

                <!-- Header -->
                <div class="p-5 border-b border-slate-100 flex justify-between items-start shrink-0">
                    <div>
                        <h2 id="detail-title" class="text-xl font-bold text-slate-900 leading-tight mb-1">Title</h2>
                        <p id="detail-date" class="text-sm text-slate-500">Date</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="enableEditMode()"
                            class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                            title="Edit Info">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                        <button onclick="closeModal('detail-modal')"
                            class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors hidden md:block">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form" class="hidden p-5 bg-slate-50 border-b border-slate-200 shrink-0">
                    <form onsubmit="saveNodeDetails(event)" class="space-y-3">
                        <input type="hidden" id="edit-node-id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ï†úÎ™©</label>
                            <input type="text" id="edit-title"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ÎÇ†Ïßú</label>
                            <input type="date" id="edit-date"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ïú†ÌäúÎ∏å URL</label>
                            <input type="text" id="edit-video"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="disableEditMode()"
                                class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded-lg">Ï∑®ÏÜå</button>
                            <button type="submit"
                                class="px-3 py-1.5 text-xs font-bold text-white bg-brand-500 hover:bg-brand-600 rounded-lg">Ï†ÄÏû•</button>
                        </div>
                    </form>
                </div>

                <!-- Moments List -->
                <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-4 bg-slate-50/50" id="moments-list">
                    <!-- Moments injected here -->
                </div>

                <!-- Add Moment Input -->
                <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                    <form onsubmit="addMomentFromDetail(event)" class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <input type="text" id="new-moment-time" placeholder="0:00"
                                class="w-16 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 text-center">
                            <input type="text" id="new-moment-text" placeholder="Ïù¥ ÏàúÍ∞ÑÏóê ÎåÄÌïú ÏΩîÎ©òÌä∏..."
                                class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-1">
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="love"
                                        class="peer sr-only" checked><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 hover:bg-pink-50 transition-colors">üòç</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="tear"
                                        class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 hover:bg-blue-50 transition-colors">üò≠</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="funny" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-yellow-100 peer-checked:text-yellow-600 hover:bg-yellow-50 transition-colors">ü§£</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="shock" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-purple-100 peer-checked:text-purple-600 hover:bg-purple-50 transition-colors">üò≤</span></label>
                            </div>
                            <button type="submit"
                                class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm">Îì±Î°ù</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        // --- Translations ---
        let isKorean = true;
        const translations = {
            ko: {
                treeTitle: "ÎÇòÏùò Îü¨Î∏åÌä∏Î¶¨",
                langBtn: "English",
                placeholderComment: "Ïù¥ ÏàúÍ∞ÑÏóê ÎåÄÌïú ÏΩîÎ©òÌä∏...",
                btnRegister: "Îì±Î°ù",
                editTitle: "Ï†úÎ™©",
                editDate: "ÎÇ†Ïßú",
                editVideo: "Ïú†ÌäúÎ∏å URL",
                btnCancel: "Ï∑®ÏÜå",
                btnSave: "Ï†ÄÏû•",
                btnReset: "Ï¥àÍ∏∞Ìôî"
            },
            en: {
                treeTitle: "My LoveTree",
                langBtn: "ÌïúÍµ≠Ïñ¥",
                placeholderComment: "Comment on this moment...",
                btnRegister: "Add",
                editTitle: "Title",
                editDate: "Date",
                editVideo: "YouTube URL",
                btnCancel: "Cancel",
                btnSave: "Save",
                btnReset: "Reset"
            }
        };

        function toggleLanguage() {
            isKorean = !isKorean;
            const t = isKorean ? translations.ko : translations.en;

            document.getElementById('tree-title').innerText = t.treeTitle;
            document.getElementById('lang-btn').innerText = t.langBtn;
            document.getElementById('new-moment-text').placeholder = t.placeholderComment;
            document.querySelector('button[type="submit"]').innerText = t.btnRegister;
            document.getElementById('btn-reset').innerText = t.btnReset;

            render();
        }

        // --- Data ---
        const dummyData = {
            'bts': {
                name: 'Î∞©ÌÉÑÏÜåÎÖÑÎã® (BTS)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Îç∞Î∑î Î¨¥ÎåÄ (No More Dream)', date: '2013-06-13', videoId: 'rBG5L7UsUxA', moments: [{ time: '0:10', text: 'Ï†ÑÏÑ§Ïùò ÏãúÏûë', feeling: 'love' }] },
                    { id: 2, x: 500, y: 300, title: 'Ï≤´ 1ÏúÑ (I Need U)', date: '2015-05-05', videoId: 'NMdTd9e-LEI', moments: [{ time: '2:30', text: 'ÎààÎ¨ºÎ∞îÎã§ „Ö†„Ö†', feeling: 'tear' }] },
                    { id: 3, x: 900, y: 100, title: 'Dynamite ÎπåÎ≥¥Îìú 1ÏúÑ', date: '2020-08-21', videoId: 'gdZLi9oWNZg', moments: [{ time: '1:00', text: 'ÏûêÎûëÏä§ÎüΩÎã§', feeling: 'love' }] }
                ],
                edges: [{ from: 1, to: 2 }, { from: 2, to: 3 }]
            },
            'hearts2hearts': {
                name: 'ÌïòÏ∏†Ìà¨ÌïòÏ∏† (Hearts2Hearts)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'The Chase (Debut)', date: '2025-02-24', videoId: 'kxUA2wwYiME', moments: [{ time: '0:05', text: 'ÎπÑÏ£ºÏñº ÏáºÌÅ¨...', feeling: 'shock' }] },
                    { id: 2, x: 500, y: 300, title: 'Ï≤´ ÏùåÏïÖÎ∞©ÏÜ° 1ÏúÑ', date: '2025-03-15', videoId: 'kxUA2wwYiME', moments: [{ time: '3:20', text: 'ÎààÎ¨ºÎ∞îÎã§ „Ö†„Ö†', feeling: 'tear' }] }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'illit': {
                name: 'ÏïÑÏùºÎ¶ø (ILLIT)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Magnetic Îç∞Î∑î', date: '2024-03-25', videoId: 'Vk5-c_v4gMU', moments: [{ time: '0:30', text: 'ÏäàÌçº Ïù¥ÎÅåÎ¶º~', feeling: 'love' }] },
                    { id: 2, x: 500, y: 200, title: 'Lucky Girl Syndrome', date: '2024-04-10', videoId: 'UCmgGZbfjmk', moments: [{ time: '1:10', text: 'ÏïàÎ¨¥ ÎÑàÎ¨¥ Í∑ÄÏó¨Ïõå', feeling: 'love' }] }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'seventeen': {
                name: 'ÏÑ∏Î∏êÌã¥ (Seventeen)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'ÏÜêÏò§Í≥µ (Super)', date: '2023-04-24', videoId: 'Y6cGBh_TSIc', moments: [{ time: '2:45', text: 'ÏπºÍµ∞Î¨¥ ÎØ∏Ï≥§Îã§', feeling: 'shock' }] },
                    { id: 2, x: 500, y: 300, title: 'MAESTRO Ïª¥Î∞±', date: '2024-04-29', videoId: 'ThI0pBAbFnk', moments: [{ time: '3:00', text: 'ÏßÄÌúòÌïòÎäî ÏïàÎ¨¥ ÎåÄÎ∞ï', feeling: 'love' }] }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'straykids': {
                name: 'Ïä§ÌÇ§Ï¶à (Stray Kids)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Á•ûÎ©îÎâ¥ (God\'s Menu)', date: '2020-06-17', videoId: 'TQTlCHxyuu8', moments: [{ time: '1:20', text: 'ÎÑ§ ÏÜêÎãò~', feeling: 'love' }] },
                    { id: 2, x: 500, y: 300, title: 'ÎùΩ (LALALALA)', date: '2023-11-10', videoId: 'DTAQd-qA8Q4', moments: [{ time: '2:10', text: 'ÏóêÎÑàÏßÄ Ìè≠Î∞ú', feeling: 'shock' }] }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'leejunyoung': {
                name: 'Ïù¥Ï§ÄÏòÅ (Lee Jun-young)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Í∂ÅÍ∏àÌï¥ (Curious About U)', date: '2019-12-05', videoId: 'K4y_y2BfSgI', moments: [{ time: '0:00', text: 'ÏÜîÎ°ú Í∞ÄÏàò Ïù¥Ï§ÄÏòÅ!', feeling: 'love' }] },
                    { id: 2, x: 500, y: 300, title: 'ÎÑàÏùò Î∞§Ïù¥ ÎêòÏñ¥Ï§ÑÍ≤å (Ïó∞Í∏∞)', date: '2021-11-07', videoId: 'B-e_nK8Q3-M', moments: [{ time: '0:00', text: 'Ïó∞Í∏∞ Ï≤úÏû¨ ÎßåÏû¨', feeling: 'love' }] }
                ],
                edges: [{ from: 1, to: 2 }]
            }
        };

        // --- State & Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const treeId = urlParams.get('id');

        const initialData = dummyData[treeId] || {
            name: treeId ? decodeURIComponent(treeId) : 'My Tree',
            nodes: [],
            edges: []
        };

        if (treeId && dummyData[treeId]) {
            document.getElementById('tree-title').innerText = dummyData[treeId].name;
        } else if (treeId) {
            document.getElementById('tree-title').innerText = decodeURIComponent(treeId) + " Tree";
        }

        // Deep copy for reset
        const originalNodes = JSON.parse(JSON.stringify(initialData.nodes.length > 0 ? initialData.nodes : [
            { id: 1, x: window.innerWidth / 2 - 140, y: window.innerHeight / 2 - 100, title: 'Ïó¨Ï†ïÏùò ÏãúÏûë', date: new Date().toISOString().split('T')[0], videoId: '', moments: [] }
        ]));

        const state = {
            nodes: JSON.parse(JSON.stringify(originalNodes)),
            edges: initialData.edges,
            transform: { x: 0, y: 0, k: 1 },
            isDragging: false,
            isPanning: false,
            selectedNode: null,
            dragStart: { x: 0, y: 0 },
            activeNodeId: null
        };

        const canvas = document.getElementById('canvas');
        const connections = document.getElementById('connections');

        function render() {
            canvas.style.transform = `translate(${state.transform.x}px, ${state.transform.y}px) scale(${state.transform.k})`;
            document.getElementById('zoom-level').innerText = Math.round(state.transform.k * 100) + '%';

            connections.innerHTML = '';
            document.querySelectorAll('.node').forEach(el => el.remove());

            state.edges.forEach(edge => {
                const from = state.nodes.find(n => n.id === edge.from);
                const to = state.nodes.find(n => n.id === edge.to);
                if (from && to) drawConnection(from, to);
            });

            state.nodes.forEach(node => {
                const el = document.createElement('div');
                el.className = `node ${state.selectedNode === node.id ? 'selected' : ''}`;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';

                const thumb = node.videoId
                    ? `https://img.youtube.com/vi/${node.videoId}/hqdefault.jpg`
                    : 'https://via.placeholder.com/280x157?text=No+Video';

                el.innerHTML = `
                    <div class="h-40 bg-slate-200 relative group">
                        <img src="${thumb}" class="w-full h-full object-cover" draggable="false">
                        <div class="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors"></div>
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur">
                            ${node.moments.length} Moments
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight line-clamp-1 mb-1">${node.title}</h3>
                        <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                    </div>
                    <!-- Connect Handles -->
            if (moments.length === 0) {
                list.innerHTML = `< div class="text-center text-slate-400 text-sm py-10" > ÏïÑÏßÅ Í∏∞Î°ùÎêú ÏàúÍ∞ÑÏù¥ ÏóÜÏäµÎãàÎã§.< br > ÏòÅÏÉÅÏùÑ Î≥¥Î©∞ Í∞êÏ†ïÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!</div > `;
                return;
            }
            moments.forEach(m => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 items-start';
                el.innerHTML = `
                    < div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-lg" >
                        ${ getFeelingEmoji(m.feeling) }
                    </div >
                    <div class="flex-1 bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded cursor-pointer hover:bg-brand-100" onclick="seekVideo('${m.time}')">${m.time}</span>
                            <span class="text-[10px] text-slate-400">User</span>
                        </div>
                        <p class="text-sm text-slate-700 leading-snug">${m.text}</p>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function getFeelingEmoji(feeling) {
            const map = { love: 'üòç', tear: 'üò≠', funny: 'ü§£', shock: 'üò≤' };
            return map[feeling] || 'üòä';
        }

        function seekVideo(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];

            const iframe = document.getElementById('detail-video');
            let src = iframe.src;
            src = src.replace(/[?&]start=\d+/, '');
            src += (src.includes('?') ? '&' : '?') + `start = ${ seconds }& autoplay=1`;
            iframe.src = src;
        }

        function addMomentFromDetail(e) {
            e.preventDefault();
            const time = document.getElementById('new-moment-time').value;
            const text = document.getElementById('new-moment-text').value;
            const feeling = document.querySelector('input[name="new-moment-feeling"]:checked').value;

            if (!time || !text) return;

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.moments.push({ time, text, feeling });
                renderMomentsList(node.moments);
                render();
                document.getElementById('new-moment-text').value = '';
                document.getElementById('new-moment-time').value = '';
            }
        }

        function enableEditMode() { document.getElementById('edit-form').classList.remove('hidden'); }
        function disableEditMode() { document.getElementById('edit-form').classList.add('hidden'); }
        function saveNodeDetails(e) {
            e.preventDefault();
            const title = document.getElementById('edit-title').value;
            const date = document.getElementById('edit-date').value;
            const videoUrl = document.getElementById('edit-video').value;

            let videoId = '';
            const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (match) videoId = match[1];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.title = title;
                node.date = date;
                if (videoId) node.videoId = videoId;

                document.getElementById('detail-title').innerText = title;
                document.getElementById('detail-date').innerText = date;
                if (videoId) {
                    document.getElementById('detail-video').src = `https://www.youtube-nocookie.com/embed/${videoId}?playsinline=1&rel=0&modestbranding=1`;
                document.getElementById('external-link').href = `https://www.youtube.com/watch?v=${videoId}`;
                document.getElementById('external-link').classList.remove('hidden');
            }

                render();
            disableEditMode();
        }
        }

        function createNewNode() {
            const newNode = {
                id: Date.now(),
                x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                title: 'New Moment',
                date: new Date().toISOString().split('T')[0],
                videoId: '',
                moments: []
            };
            state.nodes.push(newNode);
            state.activeNodeId = newNode.id;
            render();
            openDetailModal(newNode);
        }

        function closeModal(id) {
            document.getElementById(id).close();
            document.getElementById('detail-video').src = '';
        }

        render();

    </script>
</body>

</html>