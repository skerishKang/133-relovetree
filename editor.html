<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Critical for YouTube Embeds -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>LoveTree Editor</title>
    <!-- Tailwind CSS (Built locally for production) -->
    <link rel="stylesheet" href="output.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK (Compat for easier integration with existing code) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        :root {
            /* ì¸ë±ìŠ¤ì™€ ë™ì¼í•œ ê¸°ë³¸ ë°°ê²½ ì´ë¯¸ì§€ ê¸°ë³¸ê°’ */
            --main-bg-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2073&auto=format&fit=crop');
        }

        body {
            background-color: #f8fafc;
            background-image: var(--main-bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-image 0.3s ease, background-color 0.3s ease;
        }

        /* ëª¨ë°”ì¼ + íƒ€ì„ë¼ì¸ ëª¨ë“œ ì „ìš© ë ˆì´ì•„ì›ƒ */
        body.editor-mobile.editor-timeline #timeline {
            background-color: transparent;
            padding-left: 16px;
            padding-right: 16px;
        }

        body.editor-mobile.editor-timeline .timeline-card {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            border-radius: 20px;
        }

        #canvas {
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 24px 24px;
            cursor: grab;
            transform-origin: 0 0;
            will-change: transform;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* Simplified Node Style */
        .node {
            position: absolute;
            width: 280px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.3s, transform 0.3s;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            z-index: 10;
        }

        .node:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-color: #f43f5e;
        }

        .node.selected {
            border-color: #f43f5e;
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.2);
            z-index: 20;
        }

        .moment-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: 600;
        }

        /* Unified Modal */
        dialog {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            max-width: 1000px;
            width: 95%;
            height: 85vh;
            animation: modal-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        #ai-helper-modal {
            height: auto;
            max-height: 85vh;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fade-in 0.3s ease;
        }

        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Scrollbar for modal content */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div
        class="fixed top-0 left-0 w-full z-50 px-4 md:px-6 py-3 flex flex-wrap md:flex-nowrap justify-between items-center gap-2 pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3">
            <a href="index.html" title="í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°"
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 p-2 rounded-xl hover:bg-white transition-colors text-slate-500 hover:text-brand-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <h1 id="tree-title"
                class="text-lg md:text-2xl font-bold text-slate-800 drop-shadow-sm bg-white/80 backdrop-blur px-3 md:px-4 py-1.5 rounded-xl border border-slate-200 max-w-[55vw] truncate">
                ë‚˜ì˜ ëŸ¬ë¸ŒíŠ¸ë¦¬
            </h1>
        </div>
        <div class="pointer-events-auto flex flex-wrap md:flex-nowrap gap-2 items-center justify-end">
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="mode-tree-btn" onclick="setEditorMode('tree')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    íŠ¸ë¦¬
                </button>
                <button id="mode-timeline-btn" onclick="setEditorMode('timeline')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="orientation-portrait-btn" onclick="setOrientationMode('portrait')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    ì„¸ë¡œ
                </button>
                <button id="orientation-landscape-btn" onclick="setOrientationMode('landscape')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    ê°€ë¡œ
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg text-xs font-mono text-slate-500 flex items-center gap-2">
                <span>ZOOM</span>
                <span id="zoom-level" class="font-bold text-slate-800">100%</span>
            </div>
            <div id="tree-stats-banner"
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-2 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <span id="tree-stats-text">ë…¸ë“œ 0 Â· ìˆœê°„ 0 Â· ì¡°íšŒ 0 Â· ì¢‹ì•„ìš” 0 Â· ê³µìœ  0</span>
            </div>
            <button onclick="zoomOut()" title="ì¤Œ ì•„ì›ƒ"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
            </button>
            <button onclick="zoomIn()" title="ì¤Œ ì¸"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
            <div class="w-px h-8 bg-slate-300 mx-1"></div>
            <button id="btn-auto-connect" onclick="autoConnectTimeline()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg text-[11px] font-bold text-slate-600 hover:bg-slate-50 transition-colors">
                ìë™ ì—°ê²°
            </button>
            <button id="btn-clear-connections" onclick="clearAllConnections()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg text-[11px] font-bold text-slate-600 hover:bg-slate-50 transition-colors ml-1">
                ì—°ê²°ì„  ì´ˆê¸°í™”
            </button>
            <button id="btn-reset" onclick="resetLayout()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-red-50 text-red-500 text-xs font-bold transition-colors ml-1">
                ì´ˆê¸°í™”
            </button>
            <button id="ai-helper-btn" type="button" onclick="openAiHelper()"
                class="bg-slate-900 text-white shadow-sm border border-slate-900 px-3 py-1.5 rounded-lg text-[11px] font-bold hover:bg-slate-800 transition-colors ml-1">
                AI ë„ìš°ë¯¸
            </button>
            <div class="w-px h-8 bg-slate-300 mx-1"></div>
            <button id="like-btn" onclick="toggleLike()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-pink-50 text-slate-400 hover:text-pink-500 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
                <span id="like-count">0</span>
            </button>
            <button id="comment-btn" onclick="openCommentsModal()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-blue-50 text-slate-400 hover:text-blue-500 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
                </svg>
                <span id="comment-count">0</span>
            </button>
            <button id="share-btn" onclick="shareTree()"
                class="bg-brand-500 shadow-lg text-white px-3 py-1.5 rounded-lg hover:bg-brand-600 text-xs font-bold transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z">
                    </path>
                </svg>
                Share
            </button>
            <button id="lang-btn" onclick="toggleLanguage()"
                class="bg-slate-800 shadow-lg text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 text-xs font-bold transition-colors">
                English
            </button>
        </div>
    </div>

    <!-- Canvas Wrapper -->
    <div id="wrapper" class="w-full h-full overflow-hidden relative">
        <div id="canvas">
            <svg id="connections" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-visible">
                <!-- Connections injected here -->
            </svg>
            <!-- Nodes injected here -->
        </div>

        <button onclick="createNewNode()"
            class="absolute bottom-6 right-6 w-14 h-14 md:bottom-8 md:right-8 md:w-16 md:h-16 bg-brand-500 hover:bg-brand-600 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40 group">
            <svg class="w-7 h-7 md:w-8 md:h-8 group-hover:rotate-90 transition-transform duration-300" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span
                class="absolute -top-10 right-0 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                ìƒˆë¡œìš´ ìˆœê°„ ì¶”ê°€
            </span>
        </button>

        <!-- ë¯¸ë‹ˆë§µ -->
        <div id="minimap"
            class="absolute bottom-20 left-4 w-28 h-16 bg-slate-900/70 backdrop-blur-sm border border-slate-600/50 rounded-lg shadow-md z-30 overflow-hidden cursor-pointer hidden md:block transition-all duration-200 hover:w-36 hover:h-20 hover:shadow-lg group">
            <canvas id="minimap-canvas" class="w-full h-full opacity-80 group-hover:opacity-100"></canvas>
            <div id="minimap-viewport"
                class="absolute border border-white/80 bg-white/20 rounded-[1px] pointer-events-none"></div>
        </div>

        <div id="timeline" class="hidden w-full h-full overflow-y-auto pt-20 pb-24 bg-slate-100/80"></div>
    </div>



    <!-- Unified Detail Modal -->
    <dialog id="detail-modal" class="bg-white">
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Video Player -->
            <div class="w-full md:w-2/3 bg-black flex items-center justify-center relative group">
                <div id="video-shell"
                    class="w-full max-w-3xl mx-auto aspect-video relative flex items-center justify-center">
                    <div id="video-placeholder"
                        class="w-full h-full flex flex-col items-center justify-center text-slate-200 gap-3 cursor-pointer select-none">
                        <div
                            class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                        <p class="text-sm font-medium">ì˜ìƒì„ ë³´ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                        <p class="text-xs text-slate-400">ì¸ë„¤ì¼ì€ ìˆ¨ê¸°ê³ , ì¬ìƒ ì‹œì—ë§Œ ì˜ìƒì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                    </div>
                    <iframe id="detail-video" class="w-full h-full absolute inset-0 hidden" src="" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>

                <!-- Fallback / External Link Button -->
                <a id="external-link" href="#" target="_blank"
                    class="absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-1.5 rounded-full backdrop-blur transition-colors flex items-center gap-1 z-20">
                    <span>YouTubeì—ì„œ ë³´ê¸°</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>

                <div class="absolute top-4 left-4 z-10">
                    <button onclick="closeModal('detail-modal')"
                        class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur transition-colors md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Right: Details & Moments -->
            <div class="w-full md:w-1/3 flex flex-col h-full border-l border-slate-200 bg-white">
                <!-- Header -->
                <div class="p-5 border-b border-slate-100 flex justify-between items-start shrink-0">
                    <div>
                        <h2 id="detail-title" class="text-xl font-bold text-slate-900 leading-tight mb-1">Title</h2>
                        <p id="detail-date" class="text-sm text-slate-500">Date</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openNodeAiHelperFromDetail()"
                            class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                            title="AIë¡œ ì´ ë…¸ë“œ ë‹¤ë“¬ê¸°">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364-6.364l-2.121 2.121M8.757 15.243l-2.121 2.121m0-12.728l2.121 2.121m8.486 8.486l2.121 2.121" />
                            </svg>
                        </button>
                        <button onclick="enableEditMode()"
                            class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                            title="ìˆ˜ì •">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                        <button onclick="deleteNode()"
                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="ì‚­ì œ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                        <button onclick="closeModal('detail-modal')"
                            class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors hidden md:block"
                            title="ë‹«ê¸°">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form" class="hidden p-5 bg-slate-50 border-b border-slate-200 shrink-0">
                    <form onsubmit="saveNodeDetails(event)" class="space-y-3">
                        <input type="hidden" id="edit-node-id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì œëª©</label>
                            <input type="text" id="edit-title"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ë‚ ì§œ</label>
                            <input type="date" id="edit-date"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ìœ íŠœë¸Œ URL</label>
                            <input type="text" id="edit-video"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì´ë¯¸ì§€ (Pro)</label>
                            <input type="file" id="edit-image" accept="image/*"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                            <div id="image-preview-container" class="mt-2 hidden">
                                <img id="image-preview" src="" alt="Preview"
                                    class="w-full h-32 object-cover rounded-lg border border-slate-200">
                                <button type="button" onclick="removeImage()"
                                    class="text-xs text-red-500 mt-1 hover:underline">ì´ë¯¸ì§€ ì‚­ì œ</button>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="disableEditMode()"
                                class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded-lg">ì·¨ì†Œ</button>
                            <button type="submit"
                                class="px-3 py-1.5 text-xs font-bold text-white bg-brand-500 hover:bg-brand-600 rounded-lg">ì €ì¥</button>
                        </div>
                    </form>
                </div>

                <!-- Moments List -->
                <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-4 bg-slate-50/50" id="moments-list">
                    <!-- Moments injected here -->
                </div>

                <!-- Add Moment Input -->
                <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                    <form onsubmit="addMomentFromDetail(event)" class="flex flex-col gap-3">
                        <div class="flex flex-col gap-2">
                            <div class="flex gap-2">
                                <div class="flex items-center gap-2">
                                    <input type="text" id="new-moment-time" placeholder="0:00"
                                        class="w-16 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 text-center">
                                    <button type="button" onclick="setCurrentMomentTime()"
                                        class="px-2 py-1 bg-slate-200 hover:bg-slate-300 text-[11px] font-medium text-slate-700 rounded-lg whitespace-nowrap">í˜„ì¬
                                        ì‹œê°„</button>
                                </div>
                                <div class="flex-1 flex gap-2">
                                    <input type="text" id="new-moment-text" placeholder="ì´ ìˆœê°„ì— ëŒ€í•œ ì½”ë©˜íŠ¸..."
                                        class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                                    <button type="button" onclick="openMomentAiHelper()"
                                        class="px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white text-[11px] font-semibold rounded-xl whitespace-nowrap">AI</button>
                                </div>
                            </div>
                            <div id="moment-ai-result" class="mt-1 space-y-1 text-xs text-slate-700"></div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-1">
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="love"
                                        class="peer sr-only" checked><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 hover:bg-pink-50 transition-colors">ğŸ˜</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="tear"
                                        class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 hover:bg-blue-50 transition-colors">ğŸ˜­</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="funny" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-yellow-100 peer-checked:text-yellow-600 hover:bg-yellow-50 transition-colors">ğŸ¤£</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="shock" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-purple-100 peer-checked:text-purple-600 hover:bg-purple-50 transition-colors">ğŸ˜²</span></label>
                            </div>
                            <button type="submit"
                                class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm">ë“±ë¡</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="ai-helper-modal"
        class="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-sm sm:max-w-md backdrop:bg-black/50 backdrop:backdrop-blur-sm">
        <form id="ai-helper-form" method="dialog" class="flex flex-col h-[75vh] sm:h-[80vh] max-h-[80vh]">
            <div class="px-4 py-3 border-b border-slate-100 flex items-center justify-between">
                <h3 class="text-sm font-bold text-slate-900">AI ë„ìš°ë¯¸</h3>
                <button type="button" onclick="closeAiHelper()"
                    class="w-7 h-7 flex items-center justify-center rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="px-4 pt-3 pb-2 flex gap-2 text-xs font-bold text-slate-600">
                <button type="button" id="ai-mode-tree-btn" onclick="setAiHelperMode('tree')"
                    class="px-3 py-1.5 rounded-full bg-slate-900 text-white">íŠ¸ë¦¬ ë¼ˆëŒ€</button>
                <button type="button" id="ai-mode-comment-btn" onclick="setAiHelperMode('qa')"
                    class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-600">ì§ˆë¬¸Â·ë„ì›€ë§</button>
                <button type="button" id="ai-mode-node-btn" onclick="setAiHelperMode('node')"
                    class="px-3 py-1.5 rounded-full bg-slate-100 text-slate-600">ë…¸ë“œ ìˆ˜ì •</button>
            </div>
            <div class="flex-1 overflow-y-auto px-4 pb-3 space-y-3 text-sm" id="ai-helper-body">
                <div id="ai-tree-panel" class="space-y-2">
                    <label for="ai-tree-prompt" class="block text-xs font-medium text-slate-500">ì–´ë–¤ íŠ¸ë¦¬ë¥¼ ë§Œë“¤ê¹Œìš”?</label>
                    <textarea id="ai-tree-prompt" rows="3"
                        class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm"
                        placeholder="ì˜ˆ: ë‰´ì§„ìŠ¤ í™œë™ì„ ì…ë•ë¶€í„° ìµœê·¼ ì•¨ë²”ê¹Œì§€ 5ë‹¨ê³„ë¡œ ì •ë¦¬í•´ì¤˜"></textarea>
                    <div class="flex items-center justify-between mt-1">
                        <label for="ai-tree-count" class="text-xs text-slate-500">ë…¸ë“œ ê°œìˆ˜</label>
                        <select id="ai-tree-count"
                            class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-xs text-slate-700">
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                </div>
                <div id="ai-comment-panel" class="space-y-2 hidden">
                    <label for="ai-comment-prompt" class="block text-xs font-medium text-slate-500">ì–´ë–¤ ì ì´ ê¶ê¸ˆí•œê°€ìš”?</label>
                    <textarea id="ai-comment-prompt" rows="3"
                        class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm"
                        placeholder="ì˜ˆ: ì§€ê¸ˆ íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ ë” ë‹¨ìˆœí•˜ê²Œ ë§Œë“¤ê³  ì‹¶ì€ë° ì–´ë–»ê²Œ ë‚˜ëˆ„ë©´ ì¢‹ì„ê¹Œ?"></textarea>
                </div>
                <div id="ai-node-panel" class="space-y-2 hidden">
                    <p class="text-[11px] text-slate-500">ë…¸ë“œë¥¼ ì„ íƒí•œ ë’¤, ìƒë‹¨ \"AI ë„ìš°ë¯¸\" ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ íƒ€ì„ë¼ì¸ ì¹´ë“œ/ë¦¬ìŠ¤íŠ¸ ì¹´ë“œë¥¼ ì´ ì˜ì—­ìœ¼ë¡œ ë“œë˜ê·¸í•˜ë©´
                        ì´ ë…¸ë“œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë„ì™€ì¤ë‹ˆë‹¤.</p>
                    <div id="ai-node-context"
                        class="text-[11px] text-slate-500 bg-slate-50 border border-slate-100 rounded-xl px-3 py-2 min-h-[2.5rem]">
                    </div>
                    <label for="ai-node-prompt" class="block text-xs font-medium text-slate-500 mt-1">ì´ ë…¸ë“œë¥¼ ì–´ë–»ê²Œ
                        ìˆ˜ì •í• ê¹Œìš”?</label>
                    <textarea id="ai-node-prompt" rows="3"
                        class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-brand-500 text-sm"
                        placeholder="ì˜ˆ: ì œëª©ê³¼ ì„¤ëª…ì„ ë” ê°ì„±ì ìœ¼ë¡œ ë°”ê¾¸ê³ , ëŒ€í‘œ ë¬´ëŒ€ ì˜ìƒë„ ì¶”ì²œí•´ì¤˜"></textarea>
                </div>
                <div id="ai-result" class="mt-1 space-y-2 text-sm text-slate-700"></div>
            </div>
            <div class="px-4 py-3 border-t border-slate-100 flex justify-end gap-2">
                <button id="ai-helper-cancel" type="button" onclick="closeAiHelper()"
                    class="px-3 py-1.5 rounded-xl text-xs font-medium text-slate-600 hover:bg-slate-100">ë‹«ê¸°</button>
                <button id="ai-helper-submit" type="submit"
                    class="px-4 py-1.5 rounded-xl text-xs font-bold bg-brand-500 text-white hover:bg-brand-600">ìƒì„±</button>
            </div>
        </form>
    </dialog>

    <!-- Comments Modal -->
    <dialog id="comments-modal"
        class="bg-white p-0 rounded-2xl shadow-2xl w-full max-w-md backdrop:bg-black/50 backdrop:backdrop-blur-sm">
        <div class="flex flex-col h-[600px] max-h-[80vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800">ëŒ“ê¸€ <span id="modal-comment-count"
                        class="text-brand-500 text-sm ml-1">0</span></h3>
                <button onclick="closeModal('comments-modal')"
                    class="text-slate-400 hover:text-slate-600 p-1 rounded-full hover:bg-slate-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div id="comments-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 custom-scroll">
                <!-- Comments injected here -->
                <div class="flex flex-col items-center justify-start pt-20 h-full text-slate-400 text-sm gap-2">
                    <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
                        </path>
                    </svg>
                    <p>ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
                </div>
            </div>

            <div
                class="p-4 border-t border-slate-100 bg-white rounded-b-2xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                <form onsubmit="addComment(event)" class="flex gap-2">
                    <input type="text" id="new-comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                        class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 transition-shadow">
                    <button type="button" onclick="openCommentAiHelper()"
                        class="px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white text-xs font-semibold rounded-xl whitespace-nowrap hidden sm:inline-flex items-center justify-center">
                        AI
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed shrink-0">
                        ì „ì†¡
                    </button>
                </form>
                <div id="comment-ai-result" class="mt-2 space-y-1 text-xs text-slate-700"></div>
            </div>
        </div>
    </dialog>

    <script src="src/shared.js"></script>
    <script src="src/auth.js"></script>
    <script src="editor_ai.js"></script>
    <script>
        // --- Translations ---
        let isKorean = true;
        const translations = {
            ko: {
                treeTitle: "ë‚˜ì˜ ëŸ¬ë¸ŒíŠ¸ë¦¬",
                langBtn: "English",
                placeholderComment: "ì´ ìˆœê°„ì— ëŒ€í•œ ì½”ë©˜íŠ¸...",
                btnRegister: "ë“±ë¡",
                editTitle: "ì œëª©",
                editDate: "ë‚ ì§œ",
                editVideo: "ìœ íŠœë¸Œ URL",
                btnCancel: "ì·¨ì†Œ",
                btnSave: "ì €ì¥",
                btnReset: "ì´ˆê¸°í™”"
            },
            en: {
                treeTitle: "My LoveTree",
                langBtn: "í•œêµ­ì–´",
                placeholderComment: "Comment on this moment...",
                btnRegister: "Add",
                editTitle: "Title",
                editDate: "Date",
                editVideo: "YouTube URL",
                btnCancel: "Cancel",
                btnSave: "Save",
                btnReset: "Reset"
            }
        };

        function toggleLanguage() {
            isKorean = !isKorean;
            const t = isKorean ? translations.ko : translations.en;

            document.getElementById('tree-title').innerText = t.treeTitle;
            document.getElementById('lang-btn').innerText = t.langBtn;
            document.getElementById('new-moment-text').placeholder = t.placeholderComment;
            document.querySelector('button[type="submit"]').innerText = t.btnRegister;
            document.getElementById('btn-reset').innerText = t.btnReset;

            render();
        }

        // --- State & Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const treeId = urlParams.get('id') || 'bts'; // Default to bts if no ID provided

        // Expanded Test Data (Personas)
        const dummyData = {
            'bts': {
                name: 'ë°©íƒ„ì†Œë…„ë‹¨ (BTS)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ë°ë·” ë¬´ëŒ€ (No More Dream)', date: '2013-06-13', videoId: 'rBG5L7UsUxA',
                        moments: [{ time: '0:10', text: 'ì „ì„¤ì˜ ì‹œì‘', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ì²« 1ìœ„ (I Need U)', date: '2015-05-05', videoId: 'NMdTd9e-LEI',
                        moments: [{ time: '2:30', text: 'ê°ë™ì ì¸ ìˆœê°„', feeling: 'tear' }]
                    },
                    {
                        id: 3, x: 900, y: 100, title: 'ë¹Œë³´ë“œ 1ìœ„ (Dynamite)', date: '2020-08-21', videoId: 'gdZLi9oWNZg',
                        moments: [{ time: '1:00', text: 'ì—­ì‚¬ì ì¸ ê¸°ë¡', feeling: 'shock' }]
                    },
                    {
                        id: 4, x: 500, y: -100, title: 'í™”ì–‘ì—°í™” (Photo)', date: '2015-04-29', videoId: '', imageUrl: 'https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=2070&auto=format&fit=crop',
                        moments: [{ time: '0:00', text: 'ì•„ë¦„ë‹¤ìš´ ì»¨ì…‰ í¬í† ', feeling: 'love' }]
                    }
                ],
                edges: [
                    { from: 1, to: 2 },
                    { from: 2, to: 3 },
                    { from: 2, to: 4 }
                ]
            },
            'newbie_fan': {
                name: 'ì‹ ì… íŒ¬ (Newbie)',
                nodes: [
                    {
                        id: 1, x: 400, y: 300, title: 'ì…ë• ë¶€ì •ê¸° ë', date: '2024-01-01', videoId: '',
                        moments: [{ time: '0:00', text: 'ì´ì œ ì¸ì •í•©ë‹ˆë‹¤. ì €ëŠ” íŒ¬ì…ë‹ˆë‹¤.', feeling: 'shock' }]
                    }
                ],
                edges: []
            },
            'heavy_uploader': {
                name: 'ê¸°ë¡ê´‘ (Heavy User)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Day 1', date: '2024-01-01', videoId: '', moments: [] },
                    { id: 2, x: 300, y: 100, title: 'Day 2', date: '2024-01-02', videoId: '', moments: [] },
                    { id: 3, x: 500, y: 100, title: 'Day 3', date: '2024-01-03', videoId: '', moments: [] },
                    { id: 4, x: 100, y: 300, title: 'Day 4', date: '2024-01-04', videoId: '', moments: [] },
                    { id: 5, x: 300, y: 300, title: 'Day 5', date: '2024-01-05', videoId: '', moments: [] }
                ],
                edges: [
                    { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 3, to: 4 }, { from: 4, to: 5 }
                ]
            },
            'seventeen': {
                name: 'ì„¸ë¸í‹´ (Seventeen)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ì†ì˜¤ê³µ (Super)', date: '2023-04-24', videoId: 'Y6cGBh_TSIc',
                        moments: [{ time: '2:45', text: 'ì¹¼êµ°ë¬´ ë¯¸ì³¤ë‹¤', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'MAESTRO ì»´ë°±', date: '2024-04-29', videoId: 'ThI0pBAbFnk',
                        moments: [{ time: '3:00', text: 'ì§€íœ˜í•˜ëŠ” ì•ˆë¬´ ëŒ€ë°•', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'straykids': {
                name: 'ìŠ¤í‚¤ì¦ˆ (Stray Kids)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ç¥ë©”ë‰´ (God\'s Menu)', date: '2020-06-17', videoId: 'TQTlCHxyuu8',
                        moments: [{ time: '1:20', text: 'ë„¤ ì†ë‹˜~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ë½ (LALALALA)', date: '2023-11-10', videoId: 'DTAQd-qA8Q4',
                        moments: [{ time: '2:10', text: 'ì—ë„ˆì§€ í­ë°œ', feeling: 'shock' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'leejunyoung': {
                name: 'ì´ì¤€ì˜ (Lee Jun-young)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ê¶ê¸ˆí•´ (Curious About U)', date: '2019-12-05', videoId: 'K4y_y2BfSgI',
                        moments: [{ time: '0:00', text: 'ì†”ë¡œ ê°€ìˆ˜ ì´ì¤€ì˜!', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ë„ˆì˜ ë°¤ì´ ë˜ì–´ì¤„ê²Œ (ì—°ê¸°)', date: '2021-11-07', videoId: 'B-e_nK8Q3-M',
                        moments: [{ time: '0:00', text: 'ì—°ê¸° ì²œì¬ ë§Œì¬', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'hearts2hearts': {
                name: 'í•˜ì¸ íˆ¬í•˜ì¸  (Hearts2Hearts)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'The Chase (Debut)', date: '2025-02-24', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '0:05', text: 'ë¹„ì£¼ì–¼ ì‡¼í¬...', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ì²« ìŒì•…ë°©ì†¡ 1ìœ„', date: '2025-03-15', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '3:20', text: 'ëˆˆë¬¼ë°”ë‹¤ ã… ã… ', feeling: 'tear' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'illit': {
                name: 'ì•„ì¼ë¦¿ (ILLIT)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Magnetic ë°ë·”', date: '2024-03-25', videoId: 'Vk5-c_v4gMU',
                        moments: [{ time: '0:30', text: 'ìŠˆí¼ ì´ëŒë¦¼~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 200, title: 'Lucky Girl Syndrome', date: '2024-04-10', videoId: 'UCmgGZbfjmk',
                        moments: [{ time: '1:10', text: 'ì•ˆë¬´ ë„ˆë¬´ ê·€ì—¬ì›Œ', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            }
        };

        // Local Storage Key (Backup)
        const STORAGE_KEY = `relovetree_data_${treeId}`;

        // Initialize Firebase
        let db;
        let auth;
        let storage;
        let currentUser = null;
        let isReadOnly = false;

        // YouTube Player State
        let ytPlayer = null;
        let youTubeApiReady = false;

        let originalNodes = [];
        let pendingConnectionFrom = null; // ì—°ê²°ì„  ì‹œì‘ ë…¸ë“œ ID ì €ì¥

        // Global State
        const state = {
            nodes: [],
            edges: [],
            transform: { x: 0, y: 0, k: 1 },
            isDragging: false,
            isPanning: false,
            selectedNode: null,
            dragStart: { x: 0, y: 0 },
            activeNodeId: null,
            likes: [],
            comments: []
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', async () => {
            initApp(); // from shared.js
            initAuth(); // from auth.js

            // Wait for Auth
            currentUser = await waitForAuth();
            console.log("Current User:", currentUser ? currentUser.email : "Guest");

            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” í•­ìƒ ì½ê¸° ì „ìš© ëª¨ë“œë¡œ ì œí•œ
            if (!currentUser) {
                isReadOnly = true;
            }

            if (typeof firebase !== 'undefined' && firebase.apps.length) {
                db = firebase.firestore();
                auth = firebase.auth();
                storage = firebase.storage();
            }

            // Load Data and Initialize State
            await loadData();

            // ì½ê¸° ì „ìš© ëª¨ë“œë¼ë©´ UIì—ì„œ í¸ì§‘ ê´€ë ¨ ë²„íŠ¼/ì»¨íŠ¸ë¡¤ì„ ìˆ¨ê¹€
            updateUIForReadOnly();
        });

        // Load Data (Firebase -> LocalStorage -> Dummy)
        // Default to 'bts' data if treeId not found in dummyData
        // let initialData = ... (Removed to avoid duplication, declared below)

        // Async Load Function
        async function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const treeId = urlParams.get('id') || 'bts';
            const currentTreeId = treeId;

            let loadedData = null;

            // 1. Try Firebase (if available)
            if (typeof db !== 'undefined' && db) {
                try {
                    const docRef = db.collection('trees').doc(treeId);
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        const data = docSnap.data();
                        console.log("Document data from Firebase:", data);

                        const baseView = typeof data.viewCount === 'number' ? data.viewCount : 0;
                        const baseShare = typeof data.shareCount === 'number' ? data.shareCount : 0;
                        window.treeStats = {
                            viewCount: baseView + 1, // ì•„ë˜ì—ì„œ increment 1íšŒë¥¼ ìˆ˜í–‰í•˜ë¯€ë¡œ í™”ë©´ì—ëŠ” ì¦ê°€ëœ ê°’ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
                            shareCount: baseShare
                        };

                        // ì¡°íšŒìˆ˜(viewCount) ë° ë§ˆì§€ë§‰ ì—´ëŒ ì‹œê°(lastOpened) í†µê³„ ì¦ê°€
                        try {
                            if (typeof firebase !== 'undefined' && firebase.firestore && firebase.firestore.FieldValue) {
                                await docRef.update({
                                    viewCount: firebase.firestore.FieldValue.increment(1),
                                    lastOpened: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        } catch (e) {
                            console.warn('viewCount/lastOpened update failed:', e);
                        }

                        // Check Ownership
                        if (currentUser && data.ownerId && data.ownerId !== currentUser.uid) {
                            isReadOnly = true;
                            showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                            document.getElementById('tree-title').classList.add('bg-slate-100', 'text-slate-500');
                        } else if (!currentUser && data.ownerId) {
                            isReadOnly = true;
                            showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì½ê¸° ì „ìš©)");
                        }

                        if (data.nodes && data.nodes.length > 0) {
                            loadedData = data;
                        }
                    }
                } catch (error) {
                    console.error("Error getting document from Firebase:", error);
                }
            }

            // 2. Try LocalStorage
            if (!loadedData) {
                const localData = localStorage.getItem(`relovetree_data_${treeId}`);
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        if (parsed.nodes && parsed.edges) {
                            console.log('Loaded from LocalStorage');
                            loadedData = parsed;
                        }
                    } catch (e) {
                        console.error('LocalStorage parse error', e);
                    }
                }
            }

            // 3. Try Dummy Data (í•­ìƒ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì·¨ê¸‰)
            if (!loadedData && dummyData[treeId]) {
                console.log('Loaded from Dummy Data');
                loadedData = dummyData[treeId];
                isReadOnly = true;
            }

            // 4. Default to Empty Tree for new IDs (ë¡œê·¸ì¸ ì‚¬ìš©ì ì „ìš©)
            if (!loadedData) {
                console.log('New tree created for ID:', treeId);
                loadedData = {
                    name: treeId ? decodeURIComponent(treeId) : 'My Tree',
                    nodes: [
                        {
                            id: 1,
                            x: window.innerWidth / 2 - 140,
                            y: window.innerHeight / 2 - 100,
                            title: 'ì—¬ì •ì˜ ì‹œì‘',
                            date: new Date().toISOString().split('T')[0],
                            videoId: '',
                            moments: [],
                            details: 'ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì—¬ ì²« ë²ˆì§¸ ìˆœê°„ì„ ê¸°ë¡í•´ë³´ì„¸ìš”.'
                        }
                    ],
                    edges: [],
                    likes: [],
                    comments: []
                };

                // ì¸ë±ìŠ¤ í˜ì´ì§€ "ìµœê·¼ ë°©ë¬¸í•œ íŠ¸ë¦¬"ì— ë°”ë¡œ ë³´ì´ë„ë¡ ì´ˆê¸° ìƒíƒœë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë° Firestoreì— ê¸°ë¡
                try {
                    const initialNodeCount = Array.isArray(loadedData.nodes) ? loadedData.nodes.length : 0;
                    const initialDataForIndex = {
                        name: loadedData.name,
                        nodes: loadedData.nodes,
                        edges: loadedData.edges,
                        lastUpdated: new Date().toISOString(),
                        ownerId: currentUser ? currentUser.uid : null,
                        nodeCount: initialNodeCount,
                        viewCount: 0,
                        shareCount: 0,
                        likeCount: Array.isArray(loadedData.likes) ? loadedData.likes.length : 0
                    };

                    window.treeStats = {
                        viewCount: 0,
                        shareCount: 0
                    };

                    // ë¡œì»¬ ë°±ì—…
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(initialDataForIndex));

                    // ë¡œê·¸ì¸ ìƒíƒœë¼ë©´ ì¦‰ì‹œ Firestoreì—ë„ ìƒì„±
                    if (db && currentUser) {
                        await db.collection('trees').doc(treeId).set(initialDataForIndex, { merge: true });
                    }
                } catch (e) {
                    console.error('Initial save failed', e);
                }
            }

            // Initialize State and Render
            if (loadedData) {
                initState(loadedData);
                document.getElementById('tree-title').innerText = loadedData.name || 'My Tree';
                render();
                if (typeof updateTreeStatsBanner === 'function') {
                    updateTreeStatsBanner();
                }
            }

            return loadedData;
        }

        // Removed redundant loadFromLocalOrDummy and initialData
        // All loading logic is now handled in loadData() and initState()

        function updateUIForReadOnly() {
            if (isReadOnly) {
                // Hide Add Button
                const fab = document.querySelector('button[onclick="createNewNode()"]');
                if (fab) fab.classList.add('hidden');

                // Hide Reset Button
                const resetBtn = document.getElementById('btn-reset');
                if (resetBtn) resetBtn.classList.add('hidden');

                // Hide Auto Connect Button
                const autoBtn = document.getElementById('btn-auto-connect');
                if (autoBtn) autoBtn.classList.add('hidden');

                // Hide Clear Connections Button
                const clearBtn = document.getElementById('btn-clear-connections');
                if (clearBtn) clearBtn.classList.add('hidden');

                // Disable Title Edit (visual only, logic handled in save)
                document.getElementById('tree-title').contentEditable = "false";
            }
        }

        // Global State moved to top of script
        // initialData usage removed

        // Initialize State with Data
        function initState(data) {
            // Deep copy for reset
            const nodesSource = data.nodes.length > 0 ? data.nodes : [{
                id: 1, x: window.innerWidth / 2 - 140, y: window.innerHeight / 2 - 100, title: 'ì—¬ì •ì˜ ì‹œì‘', date: new Date().toISOString().split('T')[0], videoId: '', moments: []
            }];

            originalNodes = JSON.parse(JSON.stringify(nodesSource));
            state.nodes = JSON.parse(JSON.stringify(originalNodes));
            state.edges = data.edges || [];
            state.likes = data.likes || [];
            state.comments = data.comments || [];

            // Reset transform
            state.transform = { x: 0, y: 0, k: 1 };
        }

        let editorMode = 'tree';

        function setEditorMode(mode) {
            if (mode !== 'tree' && mode !== 'timeline') return;
            editorMode = mode;

            const bodyEl = document.body;
            if (bodyEl) {
                if (mode === 'timeline') {
                    bodyEl.classList.add('editor-timeline');
                } else {
                    bodyEl.classList.remove('editor-timeline');
                }
            }

            const treeBtn = document.getElementById('mode-tree-btn');
            const listBtn = document.getElementById('mode-timeline-btn');

            if (treeBtn && listBtn) {
                if (mode === 'tree') {
                    treeBtn.classList.add('bg-slate-800', 'text-white');
                    treeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    listBtn.classList.remove('bg-slate-800', 'text-white');
                    listBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    listBtn.classList.add('bg-slate-800', 'text-white');
                    listBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    treeBtn.classList.remove('bg-slate-800', 'text-white');
                    treeBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }

            render();
        }

        // ================== BACKGROUND PREFERENCES (Copied from index.js) ==================
        const BG_STORAGE_KEY = 'relovetree_background';

        function applyBackgroundConfig(config) {
            const body = document.body;
            if (!body || !config) return;

            if (config.type === 'image' && config.value) {
                body.style.backgroundImage = `url('${config.value}')`;
                body.style.backgroundSize = 'cover';
                body.style.backgroundPosition = 'center';
                body.style.backgroundRepeat = 'no-repeat';
                body.style.backgroundColor = ''; // ì´ë¯¸ì§€ ì‚¬ìš© ì‹œ ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
            } else if (config.type === 'color' && config.value) {
                body.style.backgroundImage = '';
                body.style.backgroundColor = config.value;
            }
        }

        function loadBackgroundPreference() {
            // shared.jsì˜ safeLocalStorageGet ì‚¬ìš©
            const saved = safeLocalStorageGet(BG_STORAGE_KEY, null);
            if (saved && (saved.type === 'image' || saved.type === 'color')) {
                applyBackgroundConfig(saved);
            }
            // ì €ì¥ëœ ì„¤ì •ì´ ì—†ìœ¼ë©´ CSSì—ì„œ ì„¤ì •í•œ ê¸°ë³¸ ë°°ê²½ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        }

        // Load background on startup
        loadBackgroundPreference();

        function updateTreeStatsBanner() {
            const banner = document.getElementById('tree-stats-banner');
            const textEl = document.getElementById('tree-stats-text');
            if (!banner || !textEl) return;

            const nodeCount = Array.isArray(state.nodes) ? state.nodes.length : 0;

            let momentsTotal = 0;
            if (Array.isArray(state.nodes)) {
                state.nodes.forEach((n) => {
                    if (Array.isArray(n.moments)) {
                        momentsTotal += n.moments.length;
                    }
                });
            }

            const likeCount = Array.isArray(state.likes) ? state.likes.length : 0;
            const viewCount = (window.treeStats && typeof window.treeStats.viewCount === 'number')
                ? window.treeStats.viewCount
                : 0;
            const shareCount = (window.treeStats && typeof window.treeStats.shareCount === 'number')
                ? window.treeStats.shareCount
                : 0;

            textEl.textContent = `ë…¸ë“œ ${nodeCount} Â· ìˆœê°„ ${momentsTotal} Â· ì¡°íšŒ ${viewCount} Â· ì¢‹ì•„ìš” ${likeCount} Â· ê³µìœ  ${shareCount}`;
        }

        // Save Data (Firebase + LocalStorage)
        // Simple debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        async function saveDataImmediate(showToastOnSuccess = true) {
            if (isReadOnly) {
                console.log("Read-only mode. Save skipped.");
                return;
            }

            const nodeCount = Array.isArray(state.nodes) ? state.nodes.length : 0;

            const dataToSave = {
                name: document.getElementById('tree-title').innerText,
                nodes: state.nodes,
                edges: state.edges,
                lastUpdated: new Date().toISOString(),
                ownerId: currentUser ? currentUser.uid : null,
                nodeCount: nodeCount
            };

            // 1. Save to LocalStorage (Backup & Speed)
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) { console.error("Local save failed", e); }

            // 2. Save to Firebase
            if (db) {
                if (!currentUser) {
                    // Optional: Warn user that data is only local
                    // showToast("ë¡œê·¸ì¸í•˜ë©´ í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤.");
                    return;
                }

                try {
                    await db.collection('trees').doc(treeId).set(dataToSave, { merge: true });
                    console.log("Data saved to Firebase");
                    if (showToastOnSuccess && typeof showToast === 'function') {
                        showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
                    }
                } catch (e) {
                    console.error("Firebase save failed", e);
                    if (showToastOnSuccess && typeof showToast === 'function') {
                        showToast("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ì—ë§Œ ì €ì¥ë¨)");
                    }
                }
            }
        }

        const saveData = debounce(() => {
            // ì¼ë°˜ í¸ì§‘ ë™ì‘ì—ì„œëŠ” ë””ë°”ìš´ìŠ¤ëœ ì €ì¥ì„ ì‚¬ìš©
            saveDataImmediate(true);
        }, 1000); // Debounce 1s

        function shareTree() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(async () => {
                showToast("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.");

                // ê³µìœ ìˆ˜(shareCount) í†µê³„ ì¦ê°€
                try {
                    if (db && typeof firebase !== 'undefined' && firebase.firestore && firebase.firestore.FieldValue) {
                        await db.collection('trees').doc(treeId).update({
                            shareCount: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                } catch (e) {
                    console.warn('shareCount increment failed:', e);
                }

                // ë¡œì»¬ í†µê³„ ê°’ë„ í•¨ê»˜ ì¦ê°€
                if (!window.treeStats) {
                    window.treeStats = { viewCount: 0, shareCount: 0 };
                }
                if (typeof window.treeStats.shareCount !== 'number') {
                    window.treeStats.shareCount = 0;
                }
                window.treeStats.shareCount += 1;

                if (typeof updateTreeStatsBanner === 'function') {
                    updateTreeStatsBanner();
                }
            }).catch(err => {
                console.error('Async: Could not copy text: ', err);
                prompt("ì´ ë§í¬ë¥¼ ë³µì‚¬í•´ì„œ ê³µìœ í•˜ì„¸ìš”:", url);
            });
        }

        // --- Community Features ---

        function updateLikeUI() {
            const btn = document.getElementById('like-btn');
            const countEl = document.getElementById('like-count');

            countEl.innerText = state.likes.length;

            if (currentUser && state.likes.includes(currentUser.uid)) {
                btn.classList.add('text-pink-500', 'bg-pink-50');
                btn.classList.remove('text-slate-400', 'bg-white');
            } else {
                btn.classList.remove('text-pink-500', 'bg-pink-50');
                btn.classList.add('text-slate-400', 'bg-white');
            }

            if (typeof updateTreeStatsBanner === 'function') {
                updateTreeStatsBanner();
            }
        }

        async function toggleLike() {
            if (!currentUser) {
                showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            const uid = currentUser.uid;
            const index = state.likes.indexOf(uid);

            let newLikes = [...state.likes];
            if (index === -1) {
                newLikes.push(uid);
            } else {
                newLikes.splice(index, 1);
            }

            // Optimistic UI Update
            state.likes = newLikes;
            updateLikeUI();

            try {
                await db.collection('trees').doc(treeId).update({
                    likes: newLikes,
                    likeCount: Array.isArray(newLikes) ? newLikes.length : 0
                });
            } catch (error) {
                console.error("Error updating likes:", error);
                showToast("ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                // Revert
                if (index === -1) state.likes.pop();
                else state.likes.push(uid);
                updateLikeUI();
            }
        }

        let commentsUnsubscribe = null;

        function loadComments() {
            if (commentsUnsubscribe) commentsUnsubscribe();

            commentsUnsubscribe = db.collection('trees').doc(treeId).collection('comments')
                .orderBy('createdAt', 'asc')
                .onSnapshot((snapshot) => {
                    state.comments = [];
                    snapshot.forEach(doc => {
                        state.comments.push({ id: doc.id, ...doc.data() });
                    });
                    updateCommentUI();
                });
        }

        function updateCommentUI() {
            const countEl = document.getElementById('comment-count');
            const modalCountEl = document.getElementById('modal-comment-count');
            const listEl = document.getElementById('comments-list');

            countEl.innerText = state.comments.length;
            modalCountEl.innerText = state.comments.length;

            if (state.comments.length === 0) {
                listEl.innerHTML = '<div class="text-center text-slate-400 text-sm py-10">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
                return;
            }

            listEl.innerHTML = state.comments.map(c => `
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">
                        ${c.userName ? c.userName[0].toUpperCase() : '?'}
                    </div>
                    <div class="flex-1">
                        <div class="bg-white p-3 rounded-r-xl rounded-bl-xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-bold text-slate-700 flex items-center gap-1">
                                    <span>${c.userName || 'ìµëª…'}</span>
                                    ${c.isAiBot ? '<span class="px-1.5 py-0.5 rounded-full bg-emerald-50 text-emerald-600 text-[9px] font-bold">AI</span>' : ''}
                                </span>
                                <span class="text-[10px] text-slate-400">${new Date(c.createdAt?.toDate()).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-slate-800">${c.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            // Scroll to bottom
            listEl.scrollTop = listEl.scrollHeight;
        }

        function openCommentsModal() {
            const modal = document.getElementById('comments-modal');
            modal.showModal();
            // Load comments if not already loaded (though loadData calls it)
            if (!commentsUnsubscribe && db) loadComments();
        }

        async function addComment(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            const input = document.getElementById('new-comment-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = ''; // Clear input immediately

            // Handle Anonymous User Name
            let userName = 'ìµëª…';
            if (currentUser.displayName) {
                userName = currentUser.displayName;
            } else if (currentUser.email) {
                userName = currentUser.email.split('@')[0];
            } else if (currentUser.isAnonymous) {
                userName = 'Guest';
            } else if (currentUser.isAnonymous) {
                userName = 'Guest';
            }

            try {
                await db.collection('trees').doc(treeId).collection('comments').add({
                    text: text,
                    userId: currentUser.uid,
                    userName: userName,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error adding comment:", error);
                showToast("ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨");
                input.value = text; // Restore input on fail
            }
        }

        // Simple Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity duration-300 z-50';
            toast.innerText = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('opacity-0'));
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        const canvas = document.getElementById('canvas');
        const connections = document.getElementById('connections');

        function render() {
            const timeline = document.getElementById('timeline');

            if (editorMode === 'timeline') {
                if (canvas) canvas.classList.add('hidden');
                if (connections) connections.innerHTML = '';
                if (timeline) timeline.classList.remove('hidden');
                renderTimeline();
                return;
            }

            if (timeline) timeline.classList.add('hidden');
            if (canvas) canvas.classList.remove('hidden');

            canvas.style.transform = `translate(${state.transform.x}px, ${state.transform.y}px) scale(${state.transform.k})`;
            document.getElementById('zoom-level').innerText = Math.round(state.transform.k * 100) + '%';

            connections.innerHTML = '';
            document.querySelectorAll('.node').forEach(el => el.remove());

            state.nodes.forEach(node => {
                const el = document.createElement('div');

                el.className = `node ${state.selectedNode === node.id ? 'selected' : ''}`;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';
                el.dataset.nodeId = String(node.id);
                el.setAttribute('draggable', 'true');
                el.addEventListener('dragstart', (event) => {
                    if (typeof onNodeDragStartForAi === 'function') {
                        onNodeDragStartForAi(event, node.id);
                    }
                });

                const hasVideo = !!node.videoId;
                const thumbUrl = hasVideo ? getYouTubeThumb(node.videoId, 'hqdefault') : '';

                el.innerHTML = `
                    <div class="h-40 bg-black relative group overflow-hidden">
                        ${hasVideo
                        ? `<div class="w-full h-full relative overflow-hidden">
                                    <img src="${thumbUrl}" alt="YouTube thumbnail" class="w-full h-full object-cover" />
                                    <div class="absolute inset-0 bg-black/25"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                               </div>`
                        : (node.imageUrl
                            ? `<div class="w-full h-full relative overflow-hidden">
                                <img src="${node.imageUrl}" alt="Node Image" class="w-full h-full object-cover" />
                               </div>`
                            : `<div class="w-full h-full flex items-center justify-center bg-slate-800 text-slate-300 text-xs">No Media</div>`
                        )
                    }
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur">
                            ${node.moments.length} Moments
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight line-clamp-1 mb-1">${node.title}</h3>
                        <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                    </div>
                    <!-- Connect Handles (Left: ì´ì „, Right: ë‹¤ìŒ) -->
                    <div class="absolute top-1/2 -left-3 w-6 h-6 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center cursor-crosshair hover:border-brand-500 text-slate-400 hover:text-brand-500 z-30 connection-handle connection-handle-left" title="ì´ì „ ë…¸ë“œì™€ ì—°ê²°">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </div>
                    <div class="absolute top-1/2 -right-3 w-6 h-6 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center cursor-crosshair hover:border-brand-500 text-slate-400 hover:text-brand-500 z-30 connection-handle connection-handle-right" title="ë‹¤ìŒ ë…¸ë“œì™€ ì—°ê²°">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>
                `;

                // ì—°ê²° í•¸ë“¤ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ë²„ë¸”ë§ ë°©ì§€)
                const leftHandle = el.querySelector('.connection-handle-left');
                if (leftHandle) {
                    leftHandle.addEventListener('click', (event) => {
                        event.stopPropagation();
                        onConnectionHandleClick(node.id, 'left');
                    });
                }

                const rightHandle = el.querySelector('.connection-handle-right');
                if (rightHandle) {
                    rightHandle.addEventListener('click', (event) => {
                        event.stopPropagation();
                        onConnectionHandleClick(node.id, 'right');
                    });
                }

                el.onmousedown = (e) => startDragNode(e, node);

                el.onclick = (e) => {
                    if (!state.isDragging) {
                        e.stopPropagation();
                        openDetailModal(node);
                    }
                };

                canvas.appendChild(el);
            });

            // ë…¸ë“œ DOMì´ ëª¨ë‘ ìƒì„±ëœ ì´í›„ì— ì‹¤ì œ í•¸ë“¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—°ê²°ì„ ì„ ê·¸ë¦¼
            state.edges.forEach(edge => {
                const from = state.nodes.find(n => n.id === edge.from);
                const to = state.nodes.find(n => n.id === edge.to);
                if (from && to) drawConnection(from, to);
            });

            // ë¯¸ë‹ˆë§µ ì—…ë°ì´íŠ¸
            if (typeof updateMinimap === 'function') {
                updateMinimap();
            }
        }

        function drawConnection(from, to) {
            // ì‹¤ì œ DOM ìƒì˜ í•¸ë“¤ ì¤‘ì•™ ì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—°ê²°ì„ ì„ ê³„ì‚°
            const fromEl = document.querySelector(`.node[data-node-id="${from.id}"]`);
            const toEl = document.querySelector(`.node[data-node-id="${to.id}"]`);
            if (!fromEl || !toEl) return;

            const fromHandle = fromEl.querySelector('.connection-handle-right');
            const toHandle = toEl.querySelector('.connection-handle-left');
            if (!fromHandle || !toHandle) return;

            const startX = fromEl.offsetLeft + fromHandle.offsetLeft + fromHandle.offsetWidth / 2;
            const startY = fromEl.offsetTop + fromHandle.offsetTop + fromHandle.offsetHeight / 2;
            const endX = toEl.offsetLeft + toHandle.offsetLeft + toHandle.offsetWidth / 2;
            const endY = toEl.offsetTop + toHandle.offsetTop + toHandle.offsetHeight / 2;

            const cp1X = startX + (endX - startX) * 0.5;
            const cp1Y = startY;
            const cp2X = endX - (endX - startX) * 0.5;
            const cp2Y = endY;

            const d = `M ${startX} ${startY} C ${cp1X} ${cp1Y}, ${cp2X} ${cp2Y}, ${endX} ${endY}`;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', d);
            path.setAttribute('stroke', '#cbd5e1');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            connections.appendChild(path);
        }

        // ì—°ê²° í•¸ë“¤ í´ë¦­ ë¡œì§: ì˜¤ë¥¸ìª½(ë‹¤ìŒ) â†’ ì™¼ìª½(ì´ì „) ìˆœìœ¼ë¡œ í´ë¦­í•´ ì—°ê²°ì„ ì„ ë§Œë“ ë‹¤
        function onConnectionHandleClick(nodeId, side) {
            if (isReadOnly) {
                if (typeof showToast === 'function') {
                    showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                }
                return;
            }

            if (side === 'right') {
                // ì‹œì‘ ë…¸ë“œ ì„ íƒ
                pendingConnectionFrom = nodeId;
                if (typeof showToast === 'function') {
                    showToast('ì—°ê²°í•  ë‹¤ìŒ ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì™¼ìª½ í•¸ë“¤ í´ë¦­)');
                }
                return;
            }

            if (side === 'left') {
                // ë„ì°© ë…¸ë“œ ì„ íƒ
                if (!pendingConnectionFrom || pendingConnectionFrom === nodeId) {
                    // ìê¸° ìì‹ ì´ê±°ë‚˜ ì‹œì‘ì ì´ ì—†ëŠ” ê²½ìš°: ì—°ê²° ì·¨ì†Œ
                    pendingConnectionFrom = null;
                    return;
                }

                const fromId = pendingConnectionFrom;
                const toId = nodeId;

                // ì¤‘ë³µ ì—°ê²° ë°©ì§€
                const exists = state.edges.some(e => e.from === fromId && e.to === toId);
                if (!exists) {
                    state.edges.push({ from: fromId, to: toId });
                    if (typeof saveData === 'function') {
                        saveData();
                    }
                    render();
                }

                pendingConnectionFrom = null;
            }
        }

        // ë‚ ì§œ ìˆœìœ¼ë¡œ ìë™ìœ¼ë¡œ ì—°ê²°ì„ ì„ ë§Œë“¤ì–´ ì£¼ëŠ” ê¸°ëŠ¥
        function autoConnectTimeline() {
            if (isReadOnly) {
                if (typeof showToast === 'function') {
                    showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                }
                return;
            }

            if (!Array.isArray(state.nodes) || state.nodes.length < 2) {
                if (typeof showToast === 'function') {
                    showToast("ì—°ê²°í•  ë…¸ë“œê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
                return;
            }

            // ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (ê°™ì€ ë‚ ì§œë©´ id ìˆœ)
            const nodes = [...state.nodes];
            nodes.sort((a, b) => {
                const ad = a.date || '';
                const bd = b.date || '';
                if (ad === bd) {
                    return (a.id || 0) - (b.id || 0);
                }
                return ad < bd ? -1 : 1;
            });

            const newEdges = [];
            for (let i = 0; i < nodes.length - 1; i++) {
                const fromId = nodes[i].id;
                const toId = nodes[i + 1].id;
                if (fromId != null && toId != null) {
                    newEdges.push({ from: fromId, to: toId });
                }
            }

            state.edges = newEdges;
            if (typeof saveData === 'function') {
                saveData();
            }
            render();

            if (typeof showToast === 'function') {
                showToast("ë‚ ì§œ ìˆœìœ¼ë¡œ ìë™ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ëª¨ë“  ì—°ê²°ì„ ì„ í•œ ë²ˆì— ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥
        function clearAllConnections() {
            if (isReadOnly) {
                if (typeof showToast === 'function') {
                    showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                }
                return;
            }

            if (!Array.isArray(state.edges) || state.edges.length === 0) {
                if (typeof showToast === 'function') {
                    showToast("ì‚­ì œí•  ì—°ê²°ì„ ì´ ì—†ìŠµë‹ˆë‹¤.");
                }
                return;
            }

            if (!confirm('ëª¨ë“  ì—°ê²°ì„ ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            state.edges = [];
            render();

            if (typeof saveDataImmediate === 'function') {
                saveDataImmediate(false);
            } else if (typeof saveData === 'function') {
                saveData();
            }

            if (typeof showToast === 'function') {
                showToast("ëª¨ë“  ì—°ê²°ì„ ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;

            timeline.innerHTML = '';

            const nodes = [...state.nodes];
            nodes.sort((a, b) => {
                const ad = a.date || '';
                const bd = b.date || '';
                if (ad === bd) return 0;
                return ad < bd ? -1 : 1;
            });

            if (nodes.length === 0) {
                timeline.innerHTML = '<div class="h-full flex items-center justify-center text-slate-400 text-sm px-6 text-center">ì•„ì§ ë“±ë¡ëœ ìˆœê°„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ + ë²„íŠ¼ìœ¼ë¡œ ì²« ìˆœê°„ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>';
                return;
            }

            nodes.forEach(node => {
                const card = document.createElement('div');
                card.className = 'timeline-card mx-auto mt-4 w-full max-w-md rounded-2xl bg-white shadow-sm border border-slate-200 overflow-hidden';
                card.dataset.nodeId = node.id;
                card.setAttribute('draggable', 'true');
                card.addEventListener('dragstart', (event) => {
                    if (typeof onNodeDragStartForAi === 'function') {
                        onNodeDragStartForAi(event, node.id);
                    }
                });

                const hasVideo = !!node.videoId;
                const thumbUrl = hasVideo ? getYouTubeThumb(node.videoId, 'hqdefault') : '';

                const moments = node.moments || [];
                let feelingSummary = 'ì•„ì§ ê°ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                if (moments.length > 0) {
                    const counts = {};
                    moments.forEach(m => {
                        const f = m.feeling || 'other';
                        counts[f] = (counts[f] || 0) + 1;
                    });

                    let topFeeling = null;
                    let topCount = 0;
                    Object.keys(counts).forEach(f => {
                        if (f !== 'other' && counts[f] > topCount) {
                            topFeeling = f;
                            topCount = counts[f];
                        }
                    });
                    if (!topFeeling) {
                        topFeeling = Object.keys(counts)[0];
                    }
                    const emoji = getFeelingEmoji(topFeeling);
                    feelingSummary = `${emoji} í¬í•¨ ${moments.length}íšŒ`;
                }

                card.innerHTML = `
                    <div class="bg-black h-40 relative overflow-hidden">
                        ${hasVideo
                        ? `<div class="w-full h-full relative overflow-hidden">
                                    <img src="${thumbUrl}" alt="YouTube thumbnail" class="w-full h-full object-cover" />
                                    <div class="absolute inset-0 bg-black/25"></div>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="w-10 h-10 rounded-full bg-white/90 flex items-center justify-center shadow-lg">
                                            <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"></path>
                                            </svg>
                                        </div>
                                    </div>
                               </div>`
                        : (node.imageUrl
                            ? `<div class="w-full h-full relative overflow-hidden">
                                <img src="${node.imageUrl}" alt="Node Image" class="w-full h-full object-cover" />
                               </div>`
                            : `<div class="w-full h-full flex items-center justify-center bg-slate-800 text-slate-300 text-xs">No Media</div>`
                        )
                    }
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base leading-snug mb-1 line-clamp-2">${node.title}</h3>
                                <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                                <p class="mt-1 text-[11px] text-slate-400">${feelingSummary}</p>
                                <div class="mt-1 flex gap-1">
                                    <button type="button" class="w-7 h-7 rounded-full bg-pink-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'love')">ğŸ˜</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-sky-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'tear')">ğŸ˜­</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-amber-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'funny')">ğŸ¤£</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-violet-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'shock')">ğŸ˜²</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1 shrink-0">
                                <button type="button" class="px-3 py-1.5 rounded-full bg-brand-500 text-white text-xs font-bold"
                                    onclick="event.stopPropagation(); openDetailFromTimeline(${node.id})">ì—´ê¸°</button>
                                <button type="button" class="px-2 py-1 rounded-full bg-slate-100 text-[11px] text-slate-600"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">ë¹ ë¥¸ìˆ˜ì •</button>
                            </div>
                        </div>
                        <form class="quick-edit-form hidden mt-2 space-y-2" onsubmit="saveQuickEdit(event, ${node.id})">
                            <div>
                                <input type="text" class="quick-edit-title w-full px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="ì œëª©" />
                            </div>
                            <div class="flex gap-2">
                                <input type="date" class="quick-edit-date flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg" />
                                <input type="text" class="quick-edit-video flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="ìœ íŠœë¸Œ URL" />
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="px-2 py-1 text-[11px] text-slate-500"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">ì·¨ì†Œ</button>
                                <button type="submit" class="px-3 py-1 text-[11px] font-bold text-white bg-brand-500 rounded-full">
                                    ì €ì¥
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                card.onclick = () => openDetailModal(node);
                timeline.appendChild(card);
            });
        }

        function openDetailFromTimeline(nodeId) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;
            openDetailModal(node);
        }

        function toggleQuickEdit(nodeId) {
            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const form = card.querySelector('.quick-edit-form');
            if (!form) return;

            if (form.classList.contains('hidden')) {
                const node = state.nodes.find(n => n.id === nodeId);
                if (!node) return;

                const titleInput = form.querySelector('.quick-edit-title');
                const dateInput = form.querySelector('.quick-edit-date');
                const videoInput = form.querySelector('.quick-edit-video');

                if (titleInput) titleInput.value = node.title || '';
                if (dateInput) dateInput.value = node.date || '';
                if (videoInput) videoInput.value = node.videoId ? 'https://youtu.be/' + node.videoId : '';
            }

            form.classList.toggle('hidden');
        }

        function saveQuickEdit(e, nodeId) {
            e.preventDefault();
            e.stopPropagation();

            if (isReadOnly) {
                showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                return;
            }

            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const titleInput = card.querySelector('.quick-edit-title');
            const dateInput = card.querySelector('.quick-edit-date');
            const videoInput = card.querySelector('.quick-edit-video');

            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const newTitle = titleInput ? titleInput.value.trim() : '';
            const newDate = dateInput ? dateInput.value : '';
            const videoUrl = videoInput ? videoInput.value.trim() : '';

            if (newTitle) node.title = newTitle;
            node.date = newDate;

            let videoId = '';
            if (videoUrl) {
                const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
                if (match) videoId = match[1];
            }

            node.videoId = videoId;

            // ì €ì¥ ë° ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            render();
            saveData();
        }

        function addQuickFeeling(nodeId, feeling) {
            if (isReadOnly) {
                showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                return;
            }
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            if (!Array.isArray(node.moments)) {
                node.moments = [];
            }

            node.moments.push({
                time: '00:00',
                text: '',
                feeling
            });

            render();
            saveData();
        }

        // --- Interactions ---
        let dragStartX = 0;
        let dragStartY = 0;
        let isDraggingNode = false;

        function startDragNode(e, node) {
            if (isReadOnly) return; // Prevent dragging in read-only mode
            if (e.target.closest('.connection-handle')) return; // Don't drag if clicking connection handle
            e.stopPropagation();
            isDraggingNode = true;
            state.selectedNode = node.id;
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            state.dragStart = {
                x: e.clientX / state.transform.k - node.x,
                y: e.clientY / state.transform.k - node.y
            };
            // Do NOT set state.isDragging = true here yet
        }

        window.onmousemove = (e) => {
            if (isDraggingNode && state.selectedNode) {
                // Check threshold to distinguish click from drag
                const dist = Math.hypot(e.clientX - dragStartX, e.clientY - dragStartY);
                if (dist > 5) {
                    state.isDragging = true;
                }

                if (state.isDragging) {
                    const node = state.nodes.find(n => n.id === state.selectedNode);
                    if (node) {
                        node.x = e.clientX / state.transform.k - state.dragStart.x;
                        node.y = e.clientY / state.transform.k - state.dragStart.y;
                        render();
                    }
                }
            } else if (state.isPanning) {
                state.transform.x += e.movementX;
                state.transform.y += e.movementY;
                render();
            }
        };

        window.onmouseup = () => {
            // Delay clearing slightly to allow node.onmouseup to fire with correct state
            setTimeout(() => {
                if (state.isDragging) {
                    // ë“œë˜ê·¸ê°€ ëë‚œ ì§í›„ì—ëŠ” ë””ë°”ìš´ìŠ¤ ì—†ì´ ì¦‰ì‹œ ì €ì¥í•˜ì—¬ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ„ì¹˜ê°€ ìœ ì§€ë˜ë„ë¡ í•œë‹¤
                    if (typeof saveDataImmediate === 'function') {
                        saveDataImmediate(false);
                    } else if (typeof saveData === 'function') {
                        saveData();
                    }
                }
                isDraggingNode = false;
                state.isDragging = false;
                state.isPanning = false;
            }, 0);
        };

        document.getElementById('wrapper').onmousedown = (e) => {
            if (e.target.id === 'wrapper' || e.target.id === 'canvas') {
                state.isPanning = true;
                state.selectedNode = null;
                render();
            }
        };

        document.getElementById('wrapper').onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            state.transform.k = Math.max(0.1, Math.min(3, state.transform.k * delta));
            render();
        };

        // --- Drag & Drop YouTube URL ---
        const wrapperEl = document.getElementById('wrapper');
        if (wrapperEl) {
            wrapperEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
            });

            wrapperEl.addEventListener('drop', (e) => {
                e.preventDefault();

                if (isReadOnly) {
                    showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                    return;
                }

                const dataTransfer = e.dataTransfer;
                if (!dataTransfer) return;

                const url = dataTransfer.getData('text/uri-list') || dataTransfer.getData('text/plain');
                if (!url) return;

                const videoId = validateYouTubeUrl(url);
                if (!videoId) {
                    showToast('ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                let targetNode = null;
                if (state.selectedNode) {
                    targetNode = state.nodes.find(n => n.id === state.selectedNode) || null;
                }

                if (!targetNode) {
                    targetNode = {
                        id: Date.now(),
                        x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                        y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                        title: 'New Moment',
                        date: new Date().toISOString().split('T')[0],
                        videoId,
                        moments: []
                    };
                    state.nodes.push(targetNode);
                } else {
                    targetNode.videoId = videoId;
                }

                render();
                saveData();
                showToast('ìœ íŠœë¸Œ ì˜ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
        }

        // ìƒì„¸ ëª¨ë‹¬ ì•ˆì—ì„œë„ ìœ íŠœë¸Œ URL ë“œë¡­ìœ¼ë¡œ ì˜ìƒ êµì²´ ê°€ëŠ¥í•˜ë„ë¡ ì²˜ë¦¬
        const detailModal = document.getElementById('detail-modal');
        if (detailModal) {
            detailModal.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'copy';
                }
            });

            detailModal.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (isReadOnly) {
                    showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                    return;
                }

                const dataTransfer = e.dataTransfer;
                if (!dataTransfer) return;

                const url = dataTransfer.getData('text/uri-list') || dataTransfer.getData('text/plain');
                if (!url) return;

                const videoId = validateYouTubeUrl(url);
                if (!videoId) {
                    showToast('ìœ íŠœë¸Œ ì£¼ì†Œë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const node = state.nodes.find(n => n.id === state.activeNodeId);
                if (!node) return;

                node.videoId = videoId;

                // ìƒì„¸ ë·°ì™€ ë¦¬ìŠ¤íŠ¸/íŠ¸ë¦¬ ë™ì‹œì— ê°±ì‹ 
                render();
                openDetailModal(node);
                saveData();
                showToast('ìœ íŠœë¸Œ ì˜ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            });
        }

        function zoomIn() {
            state.transform.k *= 1.2;
            render();
        }

        function zoomOut() {
            state.transform.k *= 0.8;
            render();
        }

        function resetLayout() {
            if (confirm(isKorean ? 'ëª¨ë“  ë…¸ë“œì˜ ìœ„ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ëœ ë°ì´í„°ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)' : 'Reset all node positions? (Saved data will be reset)')) {
                state.nodes = JSON.parse(JSON.stringify(originalNodes));
                state.transform = { x: 0, y: 0, k: 1 };

                // Clear Local Storage
                localStorage.removeItem(STORAGE_KEY);

                // Clear Firebase
                if (db) {
                    db.collection('trees').doc(treeId).delete().then(() => {
                        console.log("Firebase document deleted");
                    }).catch((error) => {
                        console.error("Error removing document: ", error);
                    });
                }

                render();
            }
        }

        // --- Video Helpers ---
        function onYouTubeIframeAPIReady() {
            youTubeApiReady = true;
        }

        function startVideo(videoId, startSeconds) {
            if (!videoId) return;
            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            const startSec = (typeof startSeconds === 'number' && Number.isFinite(startSeconds) && startSeconds > 0)
                ? Math.floor(startSeconds)
                : 0;

            // 1) ê°€ëŠ¥í•˜ë©´ YouTube IFrame Player API ì‚¬ìš©
            if (youTubeApiReady && typeof YT !== 'undefined' && typeof YT.Player === 'function') {
                try {
                    // ytPlayerê°€ ì—†ê±°ë‚˜ ë¹„ì •ìƒì¸ ê²½ìš° ìƒˆë¡œ ìƒì„±
                    if (!ytPlayer || typeof ytPlayer.getCurrentTime !== 'function') {
                        ytPlayer = new YT.Player('detail-video', {
                            videoId: videoId,
                            playerVars: {
                                playsinline: 1,
                                rel: 0,
                                modestbranding: 1,
                                autoplay: 1,
                                start: startSec
                            }
                        });
                    } else {
                        ytPlayer.loadVideoById({
                            videoId: videoId,
                            startSeconds: startSec
                        });
                    }

                    if (iframe) {
                        iframe.classList.remove('hidden');
                    }
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                    return;
                } catch (e) {
                    console.error('YouTube Player API ì˜¤ë¥˜, iframe src í´ë°±ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤:', e);
                    ytPlayer = null; // ë‹¤ìŒ í˜¸ì¶œì—ì„œ ë‹¤ì‹œ ì´ˆê¸°í™” ì‹œë„
                    // ì•„ë˜ ì¼ë°˜ iframe ê²½ë¡œë¡œ í´ë°±
                }
            }

            // 2) í´ë°±: ë‹¨ìˆœ nocookie iframe src êµì²´
            const params = new URLSearchParams({
                playsinline: 1,
                rel: 0,
                modestbranding: 1,
                autoplay: 1
            });

            if (startSec > 0) {
                params.set('start', String(startSec));
            }

            if (iframe) {
                iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?${params.toString()}`;
                iframe.classList.remove('hidden');
            }
            if (placeholder) {
                placeholder.classList.add('hidden');
            }
        }

        function setCurrentMomentTime() {
            const input = document.getElementById('new-moment-time');
            if (!input) return;

            let seconds = 0;

            if (ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                try {
                    seconds = ytPlayer.getCurrentTime();
                } catch (e) {
                    seconds = 0;
                }
            }

            if (!Number.isFinite(seconds) || seconds < 0) {
                seconds = 0;
            }

            const total = Math.floor(seconds);

            if (typeof secondsToTime === 'function') {
                input.value = secondsToTime(total);
            } else {
                const m = Math.floor(total / 60);
                const s = total % 60;
                input.value = `${m}:${s.toString().padStart(2, '0')}`;
            }
        }

        // --- Unified Detail Modal & Other Logic ---
        function openDetailModal(node) {
            state.activeNodeId = node.id;
            document.getElementById('detail-title').innerText = node.title;
            document.getElementById('detail-date').innerText = node.date;
            document.getElementById('edit-title').value = node.title;
            document.getElementById('edit-date').value = node.date;
            document.getElementById('edit-video').value = node.videoId ? `https://youtu.be/${node.videoId}` : '';

            // ëª¨ë‹¬ì„ ì—´ ë•ŒëŠ” ì½ê¸° ëª¨ë“œë¡œ ë‘ê³ , Edit ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ í¸ì§‘ í¼ì„ ì—°ë‹¤
            disableEditMode();

            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            // Update Media View
            updateDetailMedia(node);

            // Edit Form - Image Preview
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            if (node.imageUrl) {
                imagePreview.src = node.imageUrl;
                imagePreviewContainer.classList.remove('hidden');
            } else {
                imagePreviewContainer.classList.add('hidden');
            }

            renderMomentsList(node.moments);
            const modal = document.getElementById('detail-modal');
            modal.showModal();
        }

        function renderMomentsList(moments) {
            const list = document.getElementById('moments-list');
            list.innerHTML = '';

            if (moments.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-10">ì•„ì§ ê¸°ë¡ëœ ìˆœê°„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì˜ìƒì„ ë³´ë©° ê°ì •ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`;
                return;
            }

            moments.forEach(m => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 items-start';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-lg">
                        ${getFeelingEmoji(m.feeling)}
                    </div>
                    <div class="flex-1 bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded cursor-pointer hover:bg-brand-100" onclick="seekVideo('${m.time}')">
                                ${m.time}
                            </span>
                            <span class="text-[10px] text-slate-400">User</span>
                        </div>
                        <p class="text-sm text-slate-700 leading-snug">${m.text}</p>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function getFeelingEmoji(feeling) {
            const map = { love: 'ğŸ˜', tear: 'ğŸ˜­', funny: 'ğŸ¤£', shock: 'ğŸ˜²' };
            return map[feeling] || 'ğŸ˜Š';
        }

        function seekVideo(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node || !node.videoId) return;

            startVideo(node.videoId, seconds);
        }

        function addMomentFromDetail(e) {
            e.preventDefault();
            if (isReadOnly) {
                showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                return;
            }
            const time = document.getElementById('new-moment-time').value;
            const text = document.getElementById('new-moment-text').value;
            const feeling = document.querySelector('input[name="new-moment-feeling"]:checked').value;

            if (!time || !text) return;

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.moments.push({ time, text, feeling });
                renderMomentsList(node.moments);
                render();
                saveData(); // Save after adding moment
                document.getElementById('new-moment-text').value = '';
                document.getElementById('new-moment-time').value = '';
                if (typeof updateTreeStatsBanner === 'function') {
                    updateTreeStatsBanner();
                }
                // ë“±ë¡ ì™„ë£Œ í”¼ë“œë°±
                showToast(isKorean ? 'ìˆœê°„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'Moment added!');
            }
        }

        function enableEditMode() {
            document.getElementById('edit-form').classList.remove('hidden');
        }

        function disableEditMode() {
            document.getElementById('edit-form').classList.add('hidden');
        }

        async function saveNodeDetails(e) {
            e.preventDefault();
            if (isReadOnly) {
                showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                return;
            }
            const title = document.getElementById('edit-title').value;
            const date = document.getElementById('edit-date').value;
            const videoUrl = document.getElementById('edit-video').value;
            const imageFile = document.getElementById('edit-image').files[0];

            let videoId = '';
            const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (match) videoId = match[1];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.title = title;
                node.date = date;
                if (videoId) node.videoId = videoId;

                // Handle Image Upload
                if (imageFile) {
                    if (!currentUser) {
                        showToast("ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }

                    // Check for Pro (Optional, strict check in rules)
                    // if (currentUser.role !== 'pro') ... 

                    try {
                        const storageRef = storage.ref();
                        const fileRef = storageRef.child(`users/${currentUser.uid}/trees/${treeId}/nodes/${node.id}/${imageFile.name}`);
                        await fileRef.put(imageFile);
                        const downloadURL = await fileRef.getDownloadURL();
                        node.imageUrl = downloadURL;
                        console.log("Image uploaded:", downloadURL);
                    } catch (error) {
                        console.error("Image upload failed:", error);
                        showToast("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message);
                        return;
                    }
                }

                document.getElementById('detail-title').innerText = title;
                document.getElementById('detail-date').innerText = date;

                // Update Video/Image View
                updateDetailMedia(node);

                render();
                saveData(); // Save after editing details
                disableEditMode();
            }
        }

        function removeImage() {
            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                delete node.imageUrl;
                document.getElementById('edit-image').value = '';
                document.getElementById('image-preview-container').classList.add('hidden');
                updateDetailMedia(node);
                render();
                saveData();
            }
        }

        function updateDetailMedia(node) {
            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');
            const externalLink = document.getElementById('external-link');

            // Reset
            iframe.src = '';
            iframe.classList.add('hidden');
            placeholder.classList.remove('hidden');
            placeholder.style.backgroundImage = '';
            placeholder.innerHTML = `
                <div class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </div>
                <p class="text-sm font-medium">ì˜ìƒì„ ë³´ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                <p class="text-xs text-slate-400">ì¸ë„¤ì¼ì€ ìˆ¨ê¸°ê³ , ì¬ìƒ ì‹œì—ë§Œ ì˜ìƒì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
            `;
            externalLink.classList.add('hidden');

            if (node.videoId) {
                const params = new URLSearchParams({
                    playsinline: 1,
                    rel: 0,
                    modestbranding: 1
                });
                // We don't set src immediately to avoid autoplay/loading
                // iframe.src = ... (handled by startVideo or click)

                // Show placeholder with play button (ì‹¤ì œ ì¬ìƒ)
                placeholder.onclick = () => startVideo(node.videoId);
                externalLink.href = `https://www.youtube.com/watch?v=${node.videoId}`;
                externalLink.classList.remove('hidden');
            } else if (node.imageUrl) {
                // Show Image
                placeholder.innerHTML = ''; // Clear play button text
                placeholder.style.backgroundImage = `url('${node.imageUrl}')`;
                placeholder.style.backgroundSize = 'contain';
                placeholder.style.backgroundPosition = 'center';
                placeholder.style.backgroundRepeat = 'no-repeat';
                placeholder.onclick = null;
            } else {
                // No Media: í´ë¦­ ì‹œ ìœ íŠœë¸Œ URL ì„¤ì •ì„ ì•ˆë‚´
                placeholder.innerHTML = `<div class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </div>
                    <p class="text-sm font-medium">ìœ íŠœë¸Œ ì˜ìƒì„ ì¶”ê°€í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                    <p class="text-xs text-slate-400">ìš°ì¸¡ í¸ì§‘ ì˜ì—­ì—ì„œ ìœ íŠœë¸Œ URLì„ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì¬ìƒí•  ìˆ˜ ìˆì–´ìš”.</p>`;

                placeholder.onclick = () => {
                    if (typeof isReadOnly !== 'undefined' && isReadOnly) {
                        if (typeof showToast === 'function') {
                            showToast("ì½ê¸° ì „ìš© ëª¨ë“œì…ë‹ˆë‹¤.");
                        }
                        return;
                    }

                    if (typeof enableEditMode === 'function') {
                        enableEditMode();
                    }

                    const videoInput = document.getElementById('edit-video');
                    if (videoInput) {
                        videoInput.focus();
                    }
                };
            }
        }

        function createNewNode() {
            if (isReadOnly) return;
            const newNode = {
                id: Date.now(),
                x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                title: 'New Moment',
                date: new Date().toISOString().split('T')[0],
                videoId: '',
                moments: []
            };
            state.nodes.push(newNode);
            state.activeNodeId = newNode.id;
            render();
            saveData(); // Save after creating node
            openDetailModal(newNode);
            if (typeof updateTreeStatsBanner === 'function') {
                updateTreeStatsBanner();
            }
            // ìƒˆ ë…¸ë“œ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ í¸ì§‘ ëª¨ë“œ ì§„ì…
            setTimeout(() => {
                enableEditMode();
            }, 100);
        }

        function deleteNode() {
            if (isReadOnly) return;
            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node) return;

            if (confirm(isKorean ? `"${node.title}" ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?` : `Delete "${node.title}"?`)) {
                // Remove edges connected to this node
                state.edges = state.edges.filter(e => e.from !== node.id && e.to !== node.id);

                // Remove the node
                state.nodes = state.nodes.filter(n => n.id !== node.id);

                // ì„ íƒ ìƒíƒœ ì´ˆê¸°í™”
                state.activeNodeId = null;
                state.selectedNode = null;

                // Close modal
                closeModal('detail-modal');

                // Re-render and save
                render();
                saveData();

                showToast(isKorean ? 'ë…¸ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' : 'Node deleted');
            }
        }

        function closeModal(id) {
            document.getElementById(id).close();
            document.getElementById('detail-video').src = '';
        }

        // ëª¨ë‹¬ ë°”ê¹¥(backdrop)ì„ í´ë¦­í•˜ë©´ ë‹«íˆë„ë¡ ì²˜ë¦¬
        const detailModalEl = document.getElementById('detail-modal');
        if (detailModalEl) {
            detailModalEl.addEventListener('click', (e) => {
                const rect = detailModalEl.getBoundingClientRect();
                const isInDialog = (
                    rect.top <= e.clientY && e.clientY <= rect.bottom &&
                    rect.left <= e.clientX && e.clientX <= rect.right
                );

                // ë‹¤ì´ì–¼ë¡œê·¸ ì˜ì—­ ë°–(ì–´ë‘ìš´ ë°°ê²½)ì„ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ë‹«ê¸°
                if (!isInDialog) {
                    closeModal('detail-modal');
                }
            });
        }

        // ================== ë¯¸ë‹ˆë§µ ê¸°ëŠ¥ ==================
        function updateMinimap() {
            const minimapEl = document.getElementById('minimap');
            const canvasEl = document.getElementById('minimap-canvas');
            const viewportEl = document.getElementById('minimap-viewport');

            if (!minimapEl || !canvasEl || !viewportEl) return;
            if (!Array.isArray(state.nodes) || state.nodes.length === 0) {
                // ë…¸ë“œê°€ ì—†ìœ¼ë©´ ë¯¸ë‹ˆë§µ ìˆ¨ê¹€
                minimapEl.classList.add('hidden');
                return;
            }
            minimapEl.classList.remove('hidden');
            minimapEl.classList.add('md:block');

            const ctx = canvasEl.getContext('2d');
            if (!ctx) return;

            // ìº”ë²„ìŠ¤ ì‹¤ì œ í¬ê¸° ì„¤ì •
            const rect = canvasEl.getBoundingClientRect();
            canvasEl.width = rect.width * 2; // ê³ í•´ìƒë„
            canvasEl.height = rect.height * 2;
            ctx.scale(2, 2);

            // ë…¸ë“œ ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚°
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            const nodeWidth = 280;
            const nodeHeight = 200;

            state.nodes.forEach(n => {
                if (n.x < minX) minX = n.x;
                if (n.y < minY) minY = n.y;
                if (n.x + nodeWidth > maxX) maxX = n.x + nodeWidth;
                if (n.y + nodeHeight > maxY) maxY = n.y + nodeHeight;
            });

            // íŒ¨ë”© ì¶”ê°€
            const padding = 100;
            minX -= padding;
            minY -= padding;
            maxX += padding;
            maxY += padding;

            const worldWidth = maxX - minX;
            const worldHeight = maxY - minY;

            // ìŠ¤ì¼€ì¼ ê³„ì‚°
            const scaleX = rect.width / worldWidth;
            const scaleY = rect.height / worldHeight;
            const scale = Math.min(scaleX, scaleY);

            // í´ë¦¬ì–´ (íˆ¬ëª… ë°°ê²½)
            ctx.clearRect(0, 0, rect.width, rect.height);

            // ë…¸ë“œ ê·¸ë¦¬ê¸° (ì‘ì€ ì  ìŠ¤íƒ€ì¼)
            state.nodes.forEach(n => {
                const x = (n.x - minX) * scale;
                const y = (n.y - minY) * scale;
                const w = nodeWidth * scale;
                const h = nodeHeight * scale;

                // ì„ íƒëœ ë…¸ë“œëŠ” ë°ê²Œ, ë‚˜ë¨¸ì§€ëŠ” ì–´ë‘¡ê²Œ
                ctx.fillStyle = state.selectedNode === n.id ? '#f43f5e' : 'rgba(255, 255, 255, 0.6)';
                ctx.beginPath();
                ctx.roundRect(x, y, Math.max(w, 3), Math.max(h, 2), 1);
                ctx.fill();
            });

            // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.lineWidth = 0.5;
            state.edges.forEach(edge => {
                const from = state.nodes.find(n => n.id === edge.from);
                const to = state.nodes.find(n => n.id === edge.to);
                if (!from || !to) return;

                const x1 = (from.x - minX + nodeWidth) * scale;
                const y1 = (from.y - minY + nodeHeight / 2) * scale;
                const x2 = (to.x - minX) * scale;
                const y2 = (to.y - minY + nodeHeight / 2) * scale;

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            });

            // ë·°í¬íŠ¸ í‘œì‹œ
            const vpX = (-state.transform.x / state.transform.k - minX) * scale;
            const vpY = (-state.transform.y / state.transform.k - minY) * scale;
            const vpW = (window.innerWidth / state.transform.k) * scale;
            const vpH = (window.innerHeight / state.transform.k) * scale;

            viewportEl.style.left = vpX + 'px';
            viewportEl.style.top = vpY + 'px';
            viewportEl.style.width = Math.max(vpW, 10) + 'px';
            viewportEl.style.height = Math.max(vpH, 10) + 'px';

            // ë¯¸ë‹ˆë§µ í´ë¦­ ë°ì´í„° ì €ì¥
            minimapEl.dataset.minX = minX;
            minimapEl.dataset.minY = minY;
            minimapEl.dataset.scale = scale;
        }

        // ë¯¸ë‹ˆë§µ í´ë¦­ìœ¼ë¡œ ì´ë™
        (function () {
            const minimapEl = document.getElementById('minimap');
            if (!minimapEl) return;

            minimapEl.addEventListener('click', function (e) {
                const rect = minimapEl.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                const minX = parseFloat(minimapEl.dataset.minX) || 0;
                const minY = parseFloat(minimapEl.dataset.minY) || 0;
                const scale = parseFloat(minimapEl.dataset.scale) || 1;

                // í´ë¦­ ìœ„ì¹˜ë¥¼ ì›”ë“œ ì¢Œí‘œë¡œ ë³€í™˜
                const worldX = clickX / scale + minX;
                const worldY = clickY / scale + minY;

                // ë·°í¬íŠ¸ ì¤‘ì•™ìœ¼ë¡œ ì´ë™
                state.transform.x = -(worldX - window.innerWidth / 2 / state.transform.k) * state.transform.k;
                state.transform.y = -(worldY - window.innerHeight / 2 / state.transform.k) * state.transform.k;

                if (typeof render === 'function') render();
            });
        })();

        // Initial Load
        loadData();

        if (typeof setupAiHelperDropZone === 'function') {
            setupAiHelperDropZone();
        }

        // ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ê¸°ë³¸ ì—ë””í„° ëª¨ë“œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì„¤ì •
        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
            setEditorMode('timeline');
        }

    </script>
</body>

</html>