<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Critical for YouTube Embeds -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>LoveTree Editor</title>
    <!-- Tailwind CSS (Built locally for production) -->
    <link rel="stylesheet" href="output.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK (Compat for easier integration with existing code) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --main-bg-image: none;
        }

        body {
            /* ì¸ë±ìŠ¤ì™€ ë™ì¼í•œ ê¸°ë³¸ ë°°ê²½ìƒ‰ */
            background-color: #f8fafc;
            background-image: var(--main-bg-image);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            overflow: hidden;
            font-family: 'Noto Sans KR', sans-serif;
            transition: background-color 0.3s ease;
        }

        /* ëª¨ë°”ì¼ + íƒ€ì„ë¼ì¸ ëª¨ë“œ ì „ìš© ë ˆì´ì•„ì›ƒ */
        body.editor-mobile.editor-timeline #timeline {
            background-color: transparent;
            padding-left: 16px;
            padding-right: 16px;
        }

        body.editor-mobile.editor-timeline .timeline-card {
            max-width: 100%;
            margin-left: 0;
            margin-right: 0;
            border-radius: 20px;
        }

        #canvas {
            width: 100vw;
            height: 100vh;
            background-image: radial-gradient(#94a3b8 1px, transparent 1px);
            background-size: 24px 24px;
            cursor: grab;
            transform-origin: 0 0;
            will-change: transform;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* Simplified Node Style */
        .node {
            position: absolute;
            width: 280px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.3s, transform 0.3s;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            z-index: 10;
        }

        .node:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-color: #f43f5e;
        }

        .node.selected {
            border-color: #f43f5e;
            box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.2);
            z-index: 20;
        }

        .moment-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: 600;
        }

        /* Unified Modal */
        dialog {
            border: none;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            max-width: 1000px;
            width: 95%;
            height: 85vh;
            animation: modal-pop 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.7);
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
            animation: fade-in 0.3s ease;
        }

        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Scrollbar for modal content */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div
        class="fixed top-0 left-0 w-full z-50 px-4 md:px-6 py-3 flex flex-wrap md:flex-nowrap justify-between items-center gap-2 pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-3">
            <a href="index.html"
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 p-2 rounded-xl hover:bg-white transition-colors text-slate-500 hover:text-brand-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <h1 id="tree-title"
                class="text-lg md:text-2xl font-bold text-slate-800 drop-shadow-sm bg-white/80 backdrop-blur px-3 md:px-4 py-1.5 rounded-xl border border-slate-200 max-w-[55vw] truncate">
                ë‚˜ì˜ ëŸ¬ë¸ŒíŠ¸ë¦¬
            </h1>
        </div>
        <div class="pointer-events-auto flex flex-wrap md:flex-nowrap gap-2 items-center justify-end">
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="mode-tree-btn" onclick="setEditorMode('tree')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    íŠ¸ë¦¬
                </button>
                <button id="mode-timeline-btn" onclick="setEditorMode('timeline')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    ë¦¬ìŠ¤íŠ¸
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="viewport-desktop-btn" onclick="setViewportMode('desktop')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    ë°ìŠ¤í¬íƒ‘
                </button>
                <button id="viewport-mobile-btn" onclick="setViewportMode('mobile')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    ëª¨ë°”ì¼
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-1.5 py-1 rounded-lg text-[11px] text-slate-500 flex items-center gap-1">
                <button id="orientation-portrait-btn" onclick="setOrientationMode('portrait')"
                    class="px-2 py-0.5 rounded-md font-semibold bg-slate-800 text-white text-[11px]">
                    ì„¸ë¡œ
                </button>
                <button id="orientation-landscape-btn" onclick="setOrientationMode('landscape')"
                    class="px-2 py-0.5 rounded-md text-slate-600 bg-slate-100 hover:text-slate-800 hover:bg-slate-200 text-[11px]">
                    ê°€ë¡œ
                </button>
            </div>
            <div
                class="bg-white/80 backdrop-blur shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg text-xs font-mono text-slate-500 flex items-center gap-2">
                <span>ZOOM</span>
                <span id="zoom-level" class="font-bold text-slate-800">100%</span>
            </div>
            <button onclick="zoomOut()"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
            </button>
            <button onclick="zoomIn()"
                class="bg-white shadow-sm border border-slate-200 p-2 rounded-lg hover:bg-slate-50 text-slate-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
            <div class="w-px h-8 bg-slate-300 mx-1"></div>
            <button id="btn-reset" onclick="resetLayout()"
                class="bg-white shadow-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-red-50 text-red-500 text-xs font-bold transition-colors">
                ì´ˆê¸°í™”
            </button>
            <button id="lang-btn" onclick="toggleLanguage()"
                class="bg-slate-800 shadow-lg text-white px-3 py-1.5 rounded-lg hover:bg-slate-700 text-xs font-bold transition-colors">
                English
            </button>
        </div>
    </div>

    <!-- Canvas Wrapper -->
    <div id="wrapper" class="w-full h-full overflow-hidden relative">
        <div id="canvas">
            <svg id="connections" class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-visible">
                <!-- Connections injected here -->
            </svg>
            <!-- Nodes injected here -->
        </div>
        <div id="timeline" class="hidden w-full h-full overflow-y-auto pt-20 pb-24 bg-slate-100/80"></div>
    </div>

    <!-- Floating Action Button -->
    <button onclick="createNewNode()"
        class="fixed bottom-8 right-8 w-16 h-16 bg-brand-500 hover:bg-brand-600 text-white rounded-full shadow-2xl flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-40 group">
        <svg class="w-8 h-8 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span
            class="absolute -top-10 right-0 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
            ìƒˆë¡œìš´ ìˆœê°„ ì¶”ê°€
        </span>
    </button>

    <!-- Unified Detail Modal -->
    <dialog id="detail-modal" class="bg-white">
        <div class="flex flex-col md:flex-row h-full">
            <!-- Left: Video Player -->
            <div class="w-full md:w-2/3 bg-black flex items-center justify-center relative group">
                <div id="video-shell"
                    class="w-full max-w-3xl mx-auto aspect-video relative flex items-center justify-center">
                    <div id="video-placeholder"
                        class="w-full h-full flex flex-col items-center justify-center text-slate-200 gap-3 cursor-pointer select-none">
                        <div
                            class="w-16 h-16 rounded-full border-2 border-white/60 flex items-center justify-center bg-black/40 shadow-lg">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                        <p class="text-sm font-medium">ì˜ìƒì„ ë³´ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</p>
                        <p class="text-xs text-slate-400">ì¸ë„¤ì¼ì€ ìˆ¨ê¸°ê³ , ì¬ìƒ ì‹œì—ë§Œ ì˜ìƒì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</p>
                    </div>
                    <iframe id="detail-video" class="w-full h-full absolute inset-0 hidden" src="" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                </div>

                <!-- Fallback / External Link Button -->
                <a id="external-link" href="#" target="_blank"
                    class="absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white text-xs px-3 py-1.5 rounded-full backdrop-blur transition-colors flex items-center gap-1 z-20">
                    <span>YouTubeì—ì„œ ë³´ê¸°</span>
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                </a>

                <div class="absolute top-4 left-4 z-10">
                    <button onclick="closeModal('detail-modal')"
                        class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full backdrop-blur transition-colors md:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Right: Details & Moments -->
            <div class="w-full md:w-1/3 flex flex-col h-full border-l border-slate-200 bg-white">
                <!-- Header -->
                <div class="p-5 border-b border-slate-100 flex justify-between items-start shrink-0">
                    <div>
                        <h2 id="detail-title" class="text-xl font-bold text-slate-900 leading-tight mb-1">Title</h2>
                        <p id="detail-date" class="text-sm text-slate-500">Date</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="enableEditMode()"
                            class="p-2 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                            title="ìˆ˜ì •">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                </path>
                            </svg>
                        </button>
                        <button onclick="deleteNode()"
                            class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="ì‚­ì œ">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                </path>
                            </svg>
                        </button>
                        <button onclick="closeModal('detail-modal')"
                            class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors hidden md:block"
                            title="ë‹«ê¸°">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Edit Form (Hidden by default) -->
                <div id="edit-form" class="hidden p-5 bg-slate-50 border-b border-slate-200 shrink-0">
                    <form onsubmit="saveNodeDetails(event)" class="space-y-3">
                        <input type="hidden" id="edit-node-id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ì œëª©</label>
                            <input type="text" id="edit-title"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ë‚ ì§œ</label>
                            <input type="date" id="edit-date"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ìœ íŠœë¸Œ URL</label>
                            <input type="text" id="edit-video"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" onclick="disableEditMode()"
                                class="px-3 py-1.5 text-xs font-bold text-slate-500 hover:bg-slate-200 rounded-lg">ì·¨ì†Œ</button>
                            <button type="submit"
                                class="px-3 py-1.5 text-xs font-bold text-white bg-brand-500 hover:bg-brand-600 rounded-lg">ì €ì¥</button>
                        </div>
                    </form>
                </div>

                <!-- Moments List -->
                <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-4 bg-slate-50/50" id="moments-list">
                    <!-- Moments injected here -->
                </div>

                <!-- Add Moment Input -->
                <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                    <form onsubmit="addMomentFromDetail(event)" class="flex flex-col gap-3">
                        <div class="flex gap-2">
                            <input type="text" id="new-moment-time" placeholder="0:00"
                                class="w-16 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm font-mono focus:outline-none focus:ring-2 focus:ring-brand-500 text-center">
                            <input type="text" id="new-moment-text" placeholder="ì´ ìˆœê°„ì— ëŒ€í•œ ì½”ë©˜íŠ¸..."
                                class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-brand-500">
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-1">
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="love"
                                        class="peer sr-only" checked><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-pink-100 peer-checked:text-pink-600 hover:bg-pink-50 transition-colors">ğŸ˜</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling" value="tear"
                                        class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-blue-100 peer-checked:text-blue-600 hover:bg-blue-50 transition-colors">ğŸ˜­</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="funny" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-yellow-100 peer-checked:text-yellow-600 hover:bg-yellow-50 transition-colors">ğŸ¤£</span></label>
                                <label class="cursor-pointer"><input type="radio" name="new-moment-feeling"
                                        value="shock" class="peer sr-only"><span
                                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 peer-checked:bg-purple-100 peer-checked:text-purple-600 hover:bg-purple-50 transition-colors">ğŸ˜²</span></label>
                            </div>
                            <button type="submit"
                                class="px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white text-sm font-bold rounded-xl transition-colors shadow-sm">ë“±ë¡</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        // --- Translations ---
        let isKorean = true;
        const translations = {
            ko: {
                treeTitle: "ë‚˜ì˜ ëŸ¬ë¸ŒíŠ¸ë¦¬",
                langBtn: "English",
                placeholderComment: "ì´ ìˆœê°„ì— ëŒ€í•œ ì½”ë©˜íŠ¸...",
                btnRegister: "ë“±ë¡",
                editTitle: "ì œëª©",
                editDate: "ë‚ ì§œ",
                editVideo: "ìœ íŠœë¸Œ URL",
                btnCancel: "ì·¨ì†Œ",
                btnSave: "ì €ì¥",
                btnReset: "ì´ˆê¸°í™”"
            },
            en: {
                treeTitle: "My LoveTree",
                langBtn: "í•œêµ­ì–´",
                placeholderComment: "Comment on this moment...",
                btnRegister: "Add",
                editTitle: "Title",
                editDate: "Date",
                editVideo: "YouTube URL",
                btnCancel: "Cancel",
                btnSave: "Save",
                btnReset: "Reset"
            }
        };

        function toggleLanguage() {
            isKorean = !isKorean;
            const t = isKorean ? translations.ko : translations.en;

            document.getElementById('tree-title').innerText = t.treeTitle;
            document.getElementById('lang-btn').innerText = t.langBtn;
            document.getElementById('new-moment-text').placeholder = t.placeholderComment;
            document.querySelector('button[type="submit"]').innerText = t.btnRegister;
            document.getElementById('btn-reset').innerText = t.btnReset;

            render();
        }

        // --- State & Logic ---
        const urlParams = new URLSearchParams(window.location.search);
        const treeId = urlParams.get('id') || 'bts'; // Default to bts if no ID provided

        // Expanded Test Data (Personas)
        const dummyData = {
            'bts': {
                name: 'ë°©íƒ„ì†Œë…„ë‹¨ (BTS)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ë°ë·” ë¬´ëŒ€ (No More Dream)', date: '2013-06-13', videoId: 'rBG5L7UsUxA',
                        moments: [{ time: '0:10', text: 'ì „ì„¤ì˜ ì‹œì‘', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ì²« 1ìœ„ (I Need U)', date: '2015-05-05', videoId: 'NMdTd9e-LEI',
                        moments: [{ time: '2:30', text: 'ëˆˆë¬¼ë°”ë‹¤ ã… ã… ', feeling: 'tear' }]
                    },
                    {
                        id: 3, x: 900, y: 100, title: 'Dynamite ë¹Œë³´ë“œ 1ìœ„', date: '2020-08-21', videoId: 'gdZLi9oWNZg',
                        moments: [{ time: '1:00', text: 'ìë‘ìŠ¤ëŸ½ë‹¤', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }, { from: 2, to: 3 }]
            },
            'newbie_fan': {
                name: 'ì‹ ì… íŒ¬ (Newbie)',
                nodes: [
                    {
                        id: 1, x: 400, y: 300, title: 'ì…ë• ë¶€ì •ê¸° ë', date: '2024-01-01', videoId: '',
                        moments: [{ time: '0:00', text: 'ì´ì œ ì¸ì •í•©ë‹ˆë‹¤. ì €ëŠ” íŒ¬ì…ë‹ˆë‹¤.', feeling: 'shock' }]
                    }
                ],
                edges: []
            },
            'heavy_uploader': {
                name: 'ê¸°ë¡ê´‘ (Heavy User)',
                nodes: [
                    { id: 1, x: 100, y: 100, title: 'Day 1', date: '2024-01-01', videoId: '', moments: [] },
                    { id: 2, x: 300, y: 100, title: 'Day 2', date: '2024-01-02', videoId: '', moments: [] },
                    { id: 3, x: 500, y: 100, title: 'Day 3', date: '2024-01-03', videoId: '', moments: [] },
                    { id: 4, x: 100, y: 300, title: 'Day 4', date: '2024-01-04', videoId: '', moments: [] },
                    { id: 5, x: 300, y: 300, title: 'Day 5', date: '2024-01-05', videoId: '', moments: [] }
                ],
                edges: [
                    { from: 1, to: 2 }, { from: 2, to: 3 }, { from: 3, to: 4 }, { from: 4, to: 5 }
                ]
            },
            'seventeen': {
                name: 'ì„¸ë¸í‹´ (Seventeen)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ì†ì˜¤ê³µ (Super)', date: '2023-04-24', videoId: 'Y6cGBh_TSIc',
                        moments: [{ time: '2:45', text: 'ì¹¼êµ°ë¬´ ë¯¸ì³¤ë‹¤', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'MAESTRO ì»´ë°±', date: '2024-04-29', videoId: 'ThI0pBAbFnk',
                        moments: [{ time: '3:00', text: 'ì§€íœ˜í•˜ëŠ” ì•ˆë¬´ ëŒ€ë°•', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'straykids': {
                name: 'ìŠ¤í‚¤ì¦ˆ (Stray Kids)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ç¥ë©”ë‰´ (God\'s Menu)', date: '2020-06-17', videoId: 'TQTlCHxyuu8',
                        moments: [{ time: '1:20', text: 'ë„¤ ì†ë‹˜~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ë½ (LALALALA)', date: '2023-11-10', videoId: 'DTAQd-qA8Q4',
                        moments: [{ time: '2:10', text: 'ì—ë„ˆì§€ í­ë°œ', feeling: 'shock' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'leejunyoung': {
                name: 'ì´ì¤€ì˜ (Lee Jun-young)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'ê¶ê¸ˆí•´ (Curious About U)', date: '2019-12-05', videoId: 'K4y_y2BfSgI',
                        moments: [{ time: '0:00', text: 'ì†”ë¡œ ê°€ìˆ˜ ì´ì¤€ì˜!', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ë„ˆì˜ ë°¤ì´ ë˜ì–´ì¤„ê²Œ (ì—°ê¸°)', date: '2021-11-07', videoId: 'B-e_nK8Q3-M',
                        moments: [{ time: '0:00', text: 'ì—°ê¸° ì²œì¬ ë§Œì¬', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'hearts2hearts': {
                name: 'í•˜ì¸ íˆ¬í•˜ì¸  (Hearts2Hearts)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'The Chase (Debut)', date: '2025-02-24', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '0:05', text: 'ë¹„ì£¼ì–¼ ì‡¼í¬...', feeling: 'shock' }]
                    },
                    {
                        id: 2, x: 500, y: 300, title: 'ì²« ìŒì•…ë°©ì†¡ 1ìœ„', date: '2025-03-15', videoId: 'kxUA2wwYiME',
                        moments: [{ time: '3:20', text: 'ëˆˆë¬¼ë°”ë‹¤ ã… ã… ', feeling: 'tear' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            },
            'illit': {
                name: 'ì•„ì¼ë¦¿ (ILLIT)',
                nodes: [
                    {
                        id: 1, x: 100, y: 100, title: 'Magnetic ë°ë·”', date: '2024-03-25', videoId: 'Vk5-c_v4gMU',
                        moments: [{ time: '0:30', text: 'ìŠˆí¼ ì´ëŒë¦¼~', feeling: 'love' }]
                    },
                    {
                        id: 2, x: 500, y: 200, title: 'Lucky Girl Syndrome', date: '2024-04-10', videoId: 'UCmgGZbfjmk',
                        moments: [{ time: '1:10', text: 'ì•ˆë¬´ ë„ˆë¬´ ê·€ì—¬ì›Œ', feeling: 'love' }]
                    }
                ],
                edges: [{ from: 1, to: 2 }]
            }
        };

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQNR8bNIp4LG4EGNwl1ew8B7Har-KJC90",
            authDomain: "relovetree.firebaseapp.com",
            projectId: "relovetree",
            storageBucket: "relovetree.firebasestorage.app",
            messagingSenderId: "1091063063536",
            appId: "1:1091063063536:web:065a746e2578c47dd7b335",
            measurementId: "G-D4R5XMGFK5"
        };

        // Local Storage Key (Backup)
        const STORAGE_KEY = `relovetree_data_${treeId}`;

        // Initialize Firebase
        let db;
        let auth;
        let isFirebaseReady = false;

        try {
            if (firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                isFirebaseReady = true;
                console.log("Firebase initialized");

                // Anonymous Login
                auth.signInAnonymously().catch((error) => {
                    console.error("Auth Error:", error);
                });
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // Load Data (Firebase -> LocalStorage -> Dummy)
        let initialData = dummyData[treeId] || {
            name: treeId ? decodeURIComponent(treeId) : 'My Tree',
            nodes: [],
            edges: []
        };

        // Async Load Function
        async function loadData() {
            if (isFirebaseReady && db) {
                try {
                    const docRef = db.collection('trees').doc(treeId);
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        console.log("Document data:", docSnap.data());
                        const data = docSnap.data();
                        const hasNodes = Array.isArray(data.nodes) && data.nodes.length > 0;

                        if (hasNodes) {
                            state.nodes = data.nodes;
                            state.edges = data.edges || [];
                            document.getElementById('tree-title').innerText = data.name || initialData.name;
                        } else {
                            console.log("Document has no nodes. Falling back to local or initial data.");
                            const stored = localStorage.getItem(STORAGE_KEY);
                            if (stored) {
                                const localData = JSON.parse(stored);
                                state.nodes = localData.nodes || [];
                                state.edges = localData.edges || [];
                                document.getElementById('tree-title').innerText = localData.name || initialData.name;
                            } else {
                                state.nodes = JSON.parse(JSON.stringify(originalNodes));
                                state.edges = data.edges || initialData.edges || [];
                                document.getElementById('tree-title').innerText = data.name || initialData.name;
                            }
                        }
                        render();
                    } else {
                        console.log("No such document! Using initial data.");
                        // If no data in Firebase, try LocalStorage first
                        const stored = localStorage.getItem(STORAGE_KEY);
                        if (stored) {
                            const localData = JSON.parse(stored);
                            state.nodes = localData.nodes || [];
                            state.edges = localData.edges || [];
                            document.getElementById('tree-title').innerText = localData.name || initialData.name;
                        } else {
                            // ì™„ì „ ì‹ ê·œ íŠ¸ë¦¬ì¸ ê²½ìš° ë”ë¯¸/ê¸°ë³¸ ë…¸ë“œ ì‚¬ìš©
                            state.nodes = JSON.parse(JSON.stringify(originalNodes));
                            state.edges = initialData.edges || [];
                            document.getElementById('tree-title').innerText = initialData.name;
                        }
                        render();
                    }
                } catch (error) {
                    console.error("Error getting document:", error);
                    // Firebase ì¡°íšŒ ì‹¤íŒ¨ ì‹œì—ë„ ë¡œì»¬/ë”ë¯¸ ë°ì´í„°ë¡œ ë°”ë¡œ ë…¸ë“œë¥¼ ë³´ì—¬ì¤€ë‹¤
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const localData = JSON.parse(stored);
                        state.nodes = localData.nodes || [];
                        state.edges = localData.edges || [];
                        document.getElementById('tree-title').innerText = localData.name || initialData.name;
                    } else {
                        state.nodes = JSON.parse(JSON.stringify(originalNodes));
                        state.edges = initialData.edges || [];
                        document.getElementById('tree-title').innerText = initialData.name;
                    }
                    render();
                }
            } else {
                // Fallback to LocalStorage
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    const localData = JSON.parse(stored);
                    state.nodes = localData.nodes || [];
                    state.edges = localData.edges || [];
                    document.getElementById('tree-title').innerText = localData.name || initialData.name;
                } else {
                    state.nodes = JSON.parse(JSON.stringify(originalNodes));
                    state.edges = initialData.edges || [];
                    document.getElementById('tree-title').innerText = initialData.name;
                }
                render();
            }
        }

        if (initialData.name) {
            document.getElementById('tree-title').innerText = initialData.name;
        }

        // Deep copy for reset
        const originalNodes = JSON.parse(JSON.stringify(initialData.nodes.length > 0 ? initialData.nodes : [{
            id: 1, x: window.innerWidth / 2 - 140, y: window.innerHeight / 2 - 100, title: 'ì—¬ì •ì˜ ì‹œì‘', date: new Date().toISOString().split('T')[0], videoId: '', moments: []
        }]));

        const state = {
            nodes: JSON.parse(JSON.stringify(originalNodes)),
            edges: initialData.edges || [],
            transform: { x: 0, y: 0, k: 1 },
            isDragging: false,
            isPanning: false,
            selectedNode: null,
            dragStart: { x: 0, y: 0 },
            activeNodeId: null
        };

        let editorMode = 'tree';

        function setEditorMode(mode) {
            if (mode !== 'tree' && mode !== 'timeline') return;
            editorMode = mode;

            const bodyEl = document.body;
            if (bodyEl) {
                if (mode === 'timeline') {
                    bodyEl.classList.add('editor-timeline');
                } else {
                    bodyEl.classList.remove('editor-timeline');
                }
            }

            const treeBtn = document.getElementById('mode-tree-btn');
            const listBtn = document.getElementById('mode-timeline-btn');

            if (treeBtn && listBtn) {
                if (mode === 'tree') {
                    treeBtn.classList.add('bg-slate-800', 'text-white');
                    treeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    listBtn.classList.remove('bg-slate-800', 'text-white');
                    listBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    listBtn.classList.add('bg-slate-800', 'text-white');
                    listBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    treeBtn.classList.remove('bg-slate-800', 'text-white');
                    treeBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }

            render();
        }

        const VIEWPORT_MODE_KEY = 'relovetree_viewport_mode';
        let viewportMode = 'desktop';
        let orientationMode = 'portrait';

        function applyViewportLayout() {
            const wrapper = document.getElementById('wrapper');
            if (!wrapper) return;

            if (viewportMode === 'desktop') {
                wrapper.style.width = '100vw';
                wrapper.style.height = '100vh';
                wrapper.style.maxWidth = '';
                wrapper.style.maxHeight = '';
                wrapper.style.margin = '0';
                wrapper.style.borderRadius = '0';
                wrapper.style.boxShadow = 'none';
            } else {
                let width = 430;
                let height = 780;

                if (orientationMode === 'landscape') {
                    width = 780;
                    height = 430;
                }

                wrapper.style.width = width + 'px';
                wrapper.style.maxWidth = '100vw';
                wrapper.style.height = height + 'px';
                wrapper.style.maxHeight = 'calc(100vh - 112px)';
                wrapper.style.margin = '80px auto 32px';
                wrapper.style.borderRadius = '24px';
                wrapper.style.boxShadow = '0 20px 40px rgba(15,23,42,0.45)';
            }

            // ë°°ê²½ìƒ‰ ê°•ì œ ì´ˆê¸°í™” ì œê±° (ì‚¬ìš©ì ì„¤ì • ìœ ì§€)
            // document.body.style.backgroundColor = '#f8fafc';
        }

        function setViewportMode(mode) {
            if (mode !== 'desktop' && mode !== 'mobile') return;
            viewportMode = mode;

            const desktopBtn = document.getElementById('viewport-desktop-btn');
            const mobileBtn = document.getElementById('viewport-mobile-btn');

            applyViewportLayout();

            const bodyEl = document.body;
            if (bodyEl) {
                if (mode === 'mobile') {
                    bodyEl.classList.add('editor-mobile');
                } else {
                    bodyEl.classList.remove('editor-mobile');
                }
            }

            if (desktopBtn && mobileBtn) {
                if (mode === 'desktop') {
                    desktopBtn.classList.add('bg-slate-800', 'text-white');
                    desktopBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    mobileBtn.classList.remove('bg-slate-800', 'text-white');
                    mobileBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    mobileBtn.classList.add('bg-slate-800', 'text-white');
                    mobileBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    desktopBtn.classList.remove('bg-slate-800', 'text-white');
                    desktopBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }

            // ì‚¬ìš©ìê°€ ì„ íƒí•œ ëª¨ë“œë¥¼ ê¸°ì–µ
            try {
                localStorage.setItem(VIEWPORT_MODE_KEY, mode);
            } catch (e) { }
        }

        function setOrientationMode(mode) {
            if (mode !== 'portrait' && mode !== 'landscape') return;
            orientationMode = mode;

            const portraitBtn = document.getElementById('orientation-portrait-btn');
            const landscapeBtn = document.getElementById('orientation-landscape-btn');

            applyViewportLayout();

            if (portraitBtn && landscapeBtn) {
                if (orientationMode === 'portrait') {
                    portraitBtn.classList.add('bg-slate-800', 'text-white');
                    portraitBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    landscapeBtn.classList.remove('bg-slate-800', 'text-white');
                    landscapeBtn.classList.add('bg-slate-100', 'text-slate-600');
                } else {
                    landscapeBtn.classList.add('bg-slate-800', 'text-white');
                    landscapeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                    portraitBtn.classList.remove('bg-slate-800', 'text-white');
                    portraitBtn.classList.add('bg-slate-100', 'text-slate-600');
                }
            }
        }

        // Initial viewport mode (ì‹¤ì œ ê¸°ê¸° í¬ê¸° + ì €ì¥ëœ ê°’ ê¸°ì¤€)
        (function initViewportMode() {
            let initialMode = 'desktop';

            try {
                const saved = localStorage.getItem(VIEWPORT_MODE_KEY);
                if (saved === 'desktop' || saved === 'mobile') {
                    initialMode = saved;
                } else if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                    initialMode = 'mobile';
                }
            } catch (e) { }

            setViewportMode(initialMode);
        })();

        // Save Data (Firebase + LocalStorage)
        // Simple debounce function
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const saveData = debounce(async () => {
            const dataToSave = {
                name: document.getElementById('tree-title').innerText,
                nodes: state.nodes,
                edges: state.edges,
                lastUpdated: new Date().toISOString()
            };

            // 1. Save to LocalStorage (Backup & Speed)
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) { console.error("Local save failed", e); }

            // 2. Save to Firebase
            if (isFirebaseReady && db) {
                try {
                    await db.collection('trees').doc(treeId).set(dataToSave);
                    console.log("Data saved to Firebase");
                    showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
                } catch (e) {
                    console.error("Firebase save failed", e);
                    showToast("í´ë¼ìš°ë“œ ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ì—ë§Œ ì €ì¥ë¨)");
                }
            }
        }, 1000); // Debounce 1s

        // Simple Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm opacity-0 transition-opacity duration-300 z-50';
            toast.innerText = message;
            document.body.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('opacity-0'));
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        const canvas = document.getElementById('canvas');
        const connections = document.getElementById('connections');

        function render() {
            const timeline = document.getElementById('timeline');

            if (editorMode === 'timeline') {
                if (canvas) canvas.classList.add('hidden');
                if (connections) connections.innerHTML = '';
                if (timeline) timeline.classList.remove('hidden');
                renderTimeline();
                return;
            }

            if (timeline) timeline.classList.add('hidden');
            if (canvas) canvas.classList.remove('hidden');

            canvas.style.transform = `translate(${state.transform.x}px, ${state.transform.y}px) scale(${state.transform.k})`;
            document.getElementById('zoom-level').innerText = Math.round(state.transform.k * 100) + '%';

            connections.innerHTML = '';
            document.querySelectorAll('.node').forEach(el => el.remove());

            state.edges.forEach(edge => {
                const from = state.nodes.find(n => n.id === edge.from);
                const to = state.nodes.find(n => n.id === edge.to);
                if (from && to) drawConnection(from, to);
            });

            state.nodes.forEach(node => {
                const el = document.createElement('div');

                el.className = `node ${state.selectedNode === node.id ? 'selected' : ''}`;
                el.style.left = node.x + 'px';
                el.style.top = node.y + 'px';

                const videoBlock = node.videoId
                    ? `<iframe src="https://www.youtube-nocookie.com/embed/${node.videoId}?playsinline=1&rel=0&modestbranding=1" class="w-full h-full" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
                    : `<div class=\"w-full h-full flex items-center justify-center bg-slate-800 text-slate-300 text-xs\">No Video</div>`;

                el.innerHTML = `
                    <div class="h-40 bg-black relative group overflow-hidden">
                        ${videoBlock}
                        <div class="absolute bottom-2 right-2 bg-black/60 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur">
                            ${node.moments.length} Moments
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-slate-800 text-lg leading-tight line-clamp-1 mb-1">${node.title}</h3>
                        <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                    </div>
                    <!-- Connect Handles -->
                    <div class="absolute top-1/2 -right-3 w-6 h-6 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center cursor-crosshair hover:border-brand-500 text-slate-400 hover:text-brand-500 z-30 connection-handle" title="Drag to connect">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>
                `;

                el.onmousedown = (e) => startDragNode(e, node);

                el.onclick = (e) => {
                    if (!state.isDragging) {
                        e.stopPropagation();
                        openDetailModal(node);
                    }
                };

                canvas.appendChild(el);
            });
        }

        function drawConnection(from, to) {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const startX = from.x + 280;
            const startY = from.y + 100;
            const endX = to.x;
            const endY = to.y + 100;

            const cp1X = startX + (endX - startX) * 0.5;
            const cp1Y = startY;
            const cp2X = endX - (endX - startX) * 0.5;
            const cp2Y = endY;

            const d = `M ${startX} ${startY} C ${cp1X} ${cp1Y}, ${cp2X} ${cp2Y}, ${endX} ${endY}`;

            path.setAttribute('d', d);
            path.setAttribute('stroke', '#cbd5e1');
            path.setAttribute('stroke-width', '3');
            path.setAttribute('fill', 'none');
            connections.appendChild(path);
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;

            timeline.innerHTML = '';

            const nodes = [...state.nodes];
            nodes.sort((a, b) => {
                const ad = a.date || '';
                const bd = b.date || '';
                if (ad === bd) return 0;
                return ad < bd ? -1 : 1;
            });

            if (nodes.length === 0) {
                timeline.innerHTML = '<div class="h-full flex items-center justify-center text-slate-400 text-sm px-6 text-center">ì•„ì§ ë“±ë¡ëœ ìˆœê°„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì•„ë˜ + ë²„íŠ¼ìœ¼ë¡œ ì²« ìˆœê°„ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>';
                return;
            }

            nodes.forEach(node => {
                const card = document.createElement('div');
                card.className = 'timeline-card mx-auto mt-4 w-full max-w-md rounded-2xl bg-white shadow-sm border border-slate-200 overflow-hidden';
                card.dataset.nodeId = node.id;

                const videoBlock = node.videoId
                    ? `<iframe src="https://www.youtube-nocookie.com/embed/${node.videoId}?playsinline=1&rel=0&modestbranding=1" class="w-full h-40" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
                    : `<div class="w-full h-40 flex items-center justify-center bg-slate-800 text-slate-300 text-xs">No Video</div>`;

                const moments = node.moments || [];
                let feelingSummary = 'ì•„ì§ ê°ì • ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                if (moments.length > 0) {
                    const counts = {};
                    moments.forEach(m => {
                        const f = m.feeling || 'other';
                        counts[f] = (counts[f] || 0) + 1;
                    });

                    let topFeeling = null;
                    let topCount = 0;
                    Object.keys(counts).forEach(f => {
                        if (f !== 'other' && counts[f] > topCount) {
                            topFeeling = f;
                            topCount = counts[f];
                        }
                    });
                    if (!topFeeling) {
                        topFeeling = Object.keys(counts)[0];
                    }
                    const emoji = getFeelingEmoji(topFeeling);
                    feelingSummary = `${emoji} í¬í•¨ ${moments.length}íšŒ`;
                }

                card.innerHTML = `
                    <div class="bg-black">
                        ${videoBlock}
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base leading-snug mb-1 line-clamp-2">${node.title}</h3>
                                <p class="text-xs text-slate-400 font-medium">${node.date || ''}</p>
                                <p class="mt-1 text-[11px] text-slate-400">${feelingSummary}</p>
                                <div class="mt-1 flex gap-1">
                                    <button type="button" class="w-7 h-7 rounded-full bg-pink-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'love')">ğŸ˜</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-sky-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'tear')">ğŸ˜­</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-amber-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'funny')">ğŸ¤£</button>
                                    <button type="button" class="w-7 h-7 rounded-full bg-violet-50 text-xs flex items-center justify-center"
                                        onclick="event.stopPropagation(); addQuickFeeling(${node.id}, 'shock')">ğŸ˜²</button>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-1 shrink-0">
                                <button type="button" class="px-3 py-1.5 rounded-full bg-brand-500 text-white text-xs font-bold"
                                    onclick="event.stopPropagation(); openDetailFromTimeline(${node.id})">ì—´ê¸°</button>
                                <button type="button" class="px-2 py-1 rounded-full bg-slate-100 text-[11px] text-slate-600"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">ë¹ ë¥¸ìˆ˜ì •</button>
                            </div>
                        </div>
                        <form class="quick-edit-form hidden mt-2 space-y-2" onsubmit="saveQuickEdit(event, ${node.id})">
                            <div>
                                <input type="text" class="quick-edit-title w-full px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="ì œëª©" />
                            </div>
                            <div class="flex gap-2">
                                <input type="date" class="quick-edit-date flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg" />
                                <input type="text" class="quick-edit-video flex-1 px-2 py-1.5 text-xs border border-slate-200 rounded-lg"
                                    placeholder="ìœ íŠœë¸Œ URL" />
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="px-2 py-1 text-[11px] text-slate-500"
                                    onclick="event.stopPropagation(); toggleQuickEdit(${node.id})">ì·¨ì†Œ</button>
                                <button type="submit" class="px-3 py-1 text-[11px] font-bold text-white bg-brand-500 rounded-full">
                                    ì €ì¥
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                card.onclick = () => openDetailModal(node);
                timeline.appendChild(card);
            });
        }

        function openDetailFromTimeline(nodeId) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;
            openDetailModal(node);
        }

        function toggleQuickEdit(nodeId) {
            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const form = card.querySelector('.quick-edit-form');
            if (!form) return;

            if (form.classList.contains('hidden')) {
                const node = state.nodes.find(n => n.id === nodeId);
                if (!node) return;

                const titleInput = form.querySelector('.quick-edit-title');
                const dateInput = form.querySelector('.quick-edit-date');
                const videoInput = form.querySelector('.quick-edit-video');

                if (titleInput) titleInput.value = node.title || '';
                if (dateInput) dateInput.value = node.date || '';
                if (videoInput) videoInput.value = node.videoId ? 'https://youtu.be/' + node.videoId : '';
            }

            form.classList.toggle('hidden');
        }

        function saveQuickEdit(e, nodeId) {
            e.preventDefault();
            e.stopPropagation();

            const selector = '.timeline-card[data-node-id="' + nodeId + '"]';
            const card = document.querySelector(selector);
            if (!card) return;

            const titleInput = card.querySelector('.quick-edit-title');
            const dateInput = card.querySelector('.quick-edit-date');
            const videoInput = card.querySelector('.quick-edit-video');

            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            const newTitle = titleInput ? titleInput.value.trim() : '';
            const newDate = dateInput ? dateInput.value : '';
            const videoUrl = videoInput ? videoInput.value.trim() : '';

            if (newTitle) node.title = newTitle;
            node.date = newDate;

            let videoId = '';
            if (videoUrl) {
                const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
                if (match) videoId = match[1];
            }

            node.videoId = videoId;

            // ì €ì¥ ë° ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            render();
            saveData();
        }

        function addQuickFeeling(nodeId, feeling) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node) return;

            if (!Array.isArray(node.moments)) {
                node.moments = [];
            }

            node.moments.push({
                time: '00:00',
                text: '',
                feeling
            });

            render();
            saveData();
        }

        // --- Interactions ---
        let dragStartX = 0;
        let dragStartY = 0;
        let isDraggingNode = false;

        function startDragNode(e, node) {
            if (e.target.closest('.connection-handle')) return; // Don't drag if clicking connection handle
            e.stopPropagation();
            isDraggingNode = true;
            state.selectedNode = node.id;
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            state.dragStart = {
                x: e.clientX / state.transform.k - node.x,
                y: e.clientY / state.transform.k - node.y
            };
            // Do NOT set state.isDragging = true here yet
        }

        window.onmousemove = (e) => {
            if (isDraggingNode && state.selectedNode) {
                // Check threshold to distinguish click from drag
                const dist = Math.hypot(e.clientX - dragStartX, e.clientY - dragStartY);
                if (dist > 5) {
                    state.isDragging = true;
                }

                if (state.isDragging) {
                    const node = state.nodes.find(n => n.id === state.selectedNode);
                    if (node) {
                        node.x = e.clientX / state.transform.k - state.dragStart.x;
                        node.y = e.clientY / state.transform.k - state.dragStart.y;
                        render();
                    }
                }
            } else if (state.isPanning) {
                state.transform.x += e.movementX;
                state.transform.y += e.movementY;
                render();
            }
        };

        window.onmouseup = () => {
            // Delay clearing slightly to allow node.onmouseup to fire with correct state
            setTimeout(() => {
                if (state.isDragging) {
                    saveData(); // Save position after drag
                }
                isDraggingNode = false;
                state.isDragging = false;
                state.isPanning = false;
            }, 0);
        };

        document.getElementById('wrapper').onmousedown = (e) => {
            if (e.target.id === 'wrapper' || e.target.id === 'canvas') {
                state.isPanning = true;
                state.selectedNode = null;
                render();
            }
        };

        document.getElementById('wrapper').onwheel = (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            state.transform.k = Math.max(0.1, Math.min(3, state.transform.k * delta));
            render();
        };

        function zoomIn() {
            state.transform.k *= 1.2;
            render();
        }

        function zoomOut() {
            state.transform.k *= 0.8;
            render();
        }

        function resetLayout() {
            if (confirm(isKorean ? 'ëª¨ë“  ë…¸ë“œì˜ ìœ„ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ëœ ë°ì´í„°ë„ ì´ˆê¸°í™”ë©ë‹ˆë‹¤)' : 'Reset all node positions? (Saved data will be reset)')) {
                state.nodes = JSON.parse(JSON.stringify(originalNodes));
                state.transform = { x: 0, y: 0, k: 1 };

                // Clear Local Storage
                localStorage.removeItem(STORAGE_KEY);

                // Clear Firebase
                if (isFirebaseReady && db) {
                    db.collection('trees').doc(treeId).delete().then(() => {
                        console.log("Firebase document deleted");
                    }).catch((error) => {
                        console.error("Error removing document: ", error);
                    });
                }

                render();
            }
        }

        // --- Video Helpers ---
        function startVideo(videoId, startSeconds) {
            if (!videoId) return;
            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            const params = new URLSearchParams({
                playsinline: 1,
                rel: 0,
                modestbranding: 1,
                autoplay: 1
            });

            if (typeof startSeconds === 'number' && Number.isFinite(startSeconds) && startSeconds > 0) {
                params.set('start', String(Math.floor(startSeconds)));
            }

            iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?${params.toString()}`;
            iframe.classList.remove('hidden');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }
        }

        // --- Unified Detail Modal & Other Logic ---
        function openDetailModal(node) {
            state.activeNodeId = node.id;
            document.getElementById('detail-title').innerText = node.title;
            document.getElementById('detail-date').innerText = node.date;
            document.getElementById('edit-title').value = node.title;
            document.getElementById('edit-date').value = node.date;
            document.getElementById('edit-video').value = node.videoId ? `https://youtu.be/${node.videoId}` : '';

            // ëª¨ë‹¬ì„ ì—´ ë•ŒëŠ” ì½ê¸° ëª¨ë“œë¡œ ë‘ê³ , Edit ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œë§Œ í¸ì§‘ í¼ì„ ì—°ë‹¤
            disableEditMode();

            const iframe = document.getElementById('detail-video');
            const placeholder = document.getElementById('video-placeholder');

            if (node.videoId) {
                const params = new URLSearchParams({
                    playsinline: 1,
                    rel: 0,
                    modestbranding: 1
                });
                iframe.src = `https://www.youtube-nocookie.com/embed/${node.videoId}?${params.toString()}`;
                iframe.classList.remove('hidden');
                if (placeholder) {
                    placeholder.classList.add('hidden');
                }
                document.getElementById('external-link').href = `https://www.youtube.com/watch?v=${node.videoId}`;
                document.getElementById('external-link').classList.remove('hidden');
            } else {
                iframe.src = '';
                iframe.classList.add('hidden');
                if (placeholder) {
                    placeholder.classList.remove('hidden');
                    placeholder.style.cursor = 'default';
                    placeholder.onclick = null;
                    placeholder.innerHTML = '<p class="text-sm text-slate-300">ë“±ë¡ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                document.getElementById('external-link').classList.add('hidden');
            }

            renderMomentsList(node.moments);
            const modal = document.getElementById('detail-modal');
            modal.showModal();
        }

        function renderMomentsList(moments) {
            const list = document.getElementById('moments-list');
            list.innerHTML = '';

            if (moments.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 text-sm py-10">ì•„ì§ ê¸°ë¡ëœ ìˆœê°„ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì˜ìƒì„ ë³´ë©° ê°ì •ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>`;
                return;
            }

            moments.forEach(m => {
                const el = document.createElement('div');
                el.className = 'flex gap-3 items-start';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center shrink-0 shadow-sm text-lg">
                        ${getFeelingEmoji(m.feeling)}
                    </div>
                    <div class="flex-1 bg-white p-3 rounded-r-xl rounded-bl-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-brand-600 bg-brand-50 px-1.5 py-0.5 rounded cursor-pointer hover:bg-brand-100" onclick="seekVideo('${m.time}')">
                                ${m.time}
                            </span>
                            <span class="text-[10px] text-slate-400">User</span>
                        </div>
                        <p class="text-sm text-slate-700 leading-snug">${m.text}</p>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function getFeelingEmoji(feeling) {
            const map = { love: 'ğŸ˜', tear: 'ğŸ˜­', funny: 'ğŸ¤£', shock: 'ğŸ˜²' };
            return map[feeling] || 'ğŸ˜Š';
        }

        function seekVideo(timeStr) {
            const parts = timeStr.split(':').map(Number);
            let seconds = 0;
            if (parts.length === 2) seconds = parts[0] * 60 + parts[1];
            if (parts.length === 3) seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node || !node.videoId) return;

            startVideo(node.videoId, seconds);
        }

        function addMomentFromDetail(e) {
            e.preventDefault();
            const time = document.getElementById('new-moment-time').value;
            const text = document.getElementById('new-moment-text').value;
            const feeling = document.querySelector('input[name="new-moment-feeling"]:checked').value;

            if (!time || !text) return;

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.moments.push({ time, text, feeling });
                renderMomentsList(node.moments);
                render();
                saveData(); // Save after adding moment
                document.getElementById('new-moment-text').value = '';
                document.getElementById('new-moment-time').value = '';
            }
        }

        function enableEditMode() {
            document.getElementById('edit-form').classList.remove('hidden');
        }

        function disableEditMode() {
            document.getElementById('edit-form').classList.add('hidden');
        }

        function saveNodeDetails(e) {
            e.preventDefault();
            const title = document.getElementById('edit-title').value;
            const date = document.getElementById('edit-date').value;
            const videoUrl = document.getElementById('edit-video').value;

            let videoId = '';
            const match = videoUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (match) videoId = match[1];

            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (node) {
                node.title = title;
                node.date = date;
                if (videoId) node.videoId = videoId;

                document.getElementById('detail-title').innerText = title;
                document.getElementById('detail-date').innerText = date;

                if (videoId) {
                    const iframe = document.getElementById('detail-video');
                    const placeholder = document.getElementById('video-placeholder');

                    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?playsinline=1&rel=0&modestbranding=1`;
                    iframe.classList.remove('hidden');
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }

                    document.getElementById('external-link').href = `https://www.youtube.com/watch?v=${videoId}`;
                    document.getElementById('external-link').classList.remove('hidden');
                }

                render();
                saveData(); // Save after editing details
                disableEditMode();
            }
        }

        function createNewNode() {
            const newNode = {
                id: Date.now(),
                x: -state.transform.x / state.transform.k + window.innerWidth / 2 / state.transform.k - 140,
                y: -state.transform.y / state.transform.k + window.innerHeight / 2 / state.transform.k - 100,
                title: 'New Moment',
                date: new Date().toISOString().split('T')[0],
                videoId: '',
                moments: []
            };
            state.nodes.push(newNode);
            state.activeNodeId = newNode.id;
            render();
            saveData(); // Save after creating node
            openDetailModal(newNode);
        }

        function deleteNode() {
            const node = state.nodes.find(n => n.id === state.activeNodeId);
            if (!node) return;

            if (confirm(isKorean ? `"${node.title}" ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?` : `Delete "${node.title}"?`)) {
                // Remove edges connected to this node
                state.edges = state.edges.filter(e => e.from !== node.id && e.to !== node.id);

                // Remove the node
                state.nodes = state.nodes.filter(n => n.id !== node.id);

                // Close modal
                closeModal('detail-modal');

                // Re-render and save
                render();
                saveData();

                showToast(isKorean ? 'ë…¸ë“œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' : 'Node deleted');
            }
        }

        function closeModal(id) {
            document.getElementById(id).close();
            document.getElementById('detail-video').src = '';
        }

        // ëª¨ë‹¬ ë°”ê¹¥(backdrop)ì„ í´ë¦­í•˜ë©´ ë‹«íˆë„ë¡ ì²˜ë¦¬
        const detailModalEl = document.getElementById('detail-modal');
        if (detailModalEl) {
            detailModalEl.addEventListener('click', (e) => {
                const rect = detailModalEl.getBoundingClientRect();
                const isInDialog = (
                    rect.top <= e.clientY && e.clientY <= rect.bottom &&
                    rect.left <= e.clientX && e.clientX <= rect.right
                );

                // ë‹¤ì´ì–¼ë¡œê·¸ ì˜ì—­ ë°–(ì–´ë‘ìš´ ë°°ê²½)ì„ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ë‹«ê¸°
                if (!isInDialog) {
                    closeModal('detail-modal');
                }
            });
        }

        // ================== BACKGROUND SYNC ==================
        const BG_STORAGE_KEY = 'relovetree_background';

        function applyBackgroundConfig(config) {
            const body = document.body;
            if (!body || !config) return;

            if (config.type === 'image' && config.value) {
                body.style.backgroundImage = `url('${config.value}')`;
                body.style.backgroundSize = 'cover';
                body.style.backgroundPosition = 'center';
                body.style.backgroundRepeat = 'no-repeat';
            } else if (config.type === 'color' && config.value) {
                body.style.backgroundImage = '';
                body.style.backgroundColor = config.value;
            }
        }

        function loadBackgroundPreference() {
            try {
                const saved = localStorage.getItem(BG_STORAGE_KEY);
                if (saved) {
                    const config = JSON.parse(saved);
                    if (config && (config.type === 'image' || config.type === 'color')) {
                        applyBackgroundConfig(config);
                    }
                }
            } catch (e) {
                console.warn('Failed to load background preference:', e);
            }
        }

        // Initial Load
        loadBackgroundPreference(); // Load background first

        // Load Viewport Mode
        let initialMode = 'desktop';
        try {
            const saved = localStorage.getItem(VIEWPORT_MODE_KEY);
            if (saved === 'desktop' || saved === 'mobile') {
                initialMode = saved;
            } else if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                initialMode = 'mobile';
            }
        } catch (e) { }
        setViewportMode(initialMode);

        loadData();

        // ëª¨ë°”ì¼ í™”ë©´ì—ì„œëŠ” ê¸°ë³¸ ì—ë””í„° ëª¨ë“œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì„¤ì •
        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
            setEditorMode('timeline');
        }

    </script>
</body>

</html>